# 18. ìºì‹œ ë° ì„±ëŠ¥ ìµœì í™”

## Spring Cache ì¶”ìƒí™”

- ## `@Cacheable`, `@CacheEvict`, `@CachePut`

  Springì—ì„œëŠ” **ë©”ì„œë“œ ìˆ˜ì¤€ ìºì‹œ ê¸°ëŠ¥**ì„ ë§¤ìš° ê°„í¸í•˜ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆë„ë¡ `@Cacheable`, `@CacheEvict`, `@CachePut`ì„ ì œê³µí•œë‹¤.
   ì´ ê¸°ëŠ¥ì€ Spring Cache ì¶”ìƒí™” API ìœ„ì—ì„œ ë™ì‘í•˜ê³ , ì‹¤ì œ ì €ì¥ì†Œë¡œëŠ” **EhCache, Redis, Caffeine ë“±**ì„ ì„ íƒí•  ìˆ˜ ìˆë‹¤.
  
  ------
  
  ### 1. @Cacheable
  
  #### ğŸ”¹ ê°œë…
  
  í•´ë‹¹ ë©”ì„œë“œê°€ í˜¸ì¶œë  ë•Œ, íŒŒë¼ë¯¸í„° ê¸°ë°˜ìœ¼ë¡œ ìºì‹œì— ë¨¼ì € ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê³ , **ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš°ì—ë§Œ ë©”ì„œë“œë¥¼ ì‹¤í–‰í•´ì„œ ê²°ê³¼ë¥¼ ìºì‹œì— ì €ì¥**í•œë‹¤.
  
  ```
  @Cacheable(value = "users", key = "#id")
  public User findUserById(Long id) {
      return userRepository.findById(id).orElse(null);
  }
  ```
  
  #### ğŸ”¹ ì‘ë™ ìˆœì„œ
  
  1. `value`(=cache name)ê°€ "users"ì¸ ìºì‹œì—ì„œ `key = id`ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„° ì°¾ê¸°
  2. ìˆìœ¼ë©´ ìºì‹œëœ ê°’ì„ ë°˜í™˜ (ë©”ì„œë“œ ì‹¤í–‰ âŒ)
  3. ì—†ìœ¼ë©´ ë©”ì„œë“œ ì‹¤í–‰ â†’ ë°˜í™˜ ê²°ê³¼ë¥¼ ìºì‹œì— ì €ì¥
  
  #### ğŸ”¹ ì£¼ìš” ì†ì„±
  
  | ì†ì„±        | ì„¤ëª…                                       |
  | ----------- | ------------------------------------------ |
  | `value`     | ìºì‹œ ì´ë¦„ (í•„ìˆ˜)                           |
  | `key`       | SpEL ê¸°ë°˜ í‚¤ ì§€ì • (`#id`, `#user.name` ë“±) |
  | `condition` | íŠ¹ì • ì¡°ê±´ì—ë§Œ ìºì‹œ ì ìš©                    |
  | `unless`    | ì¡°ê±´ì´ trueì¼ ê²½ìš° ìºì‹œ âŒ                  |
  | `sync`      | ë™ê¸°í™” ìºì‹œ ì‚¬ìš© (ë™ì‹œì„± ë¬¸ì œ ëŒ€ì‘)        |
  
  ##### ì˜ˆì‹œ - ì¡°ê±´ ì„¤ì •
  
  ```
  @Cacheable(value = "products", key = "#id", condition = "#id > 10", unless = "#result == null")
  public Product getProduct(Long id) { ... }
  ```
  
  ### 2. @CacheEvict
  
  #### ğŸ”¹ ê°œë…
  
  ë©”ì„œë“œ ì‹¤í–‰ í›„, **ì§€ì •ëœ ìºì‹œ í•­ëª©ì„ ì œê±°**í•˜ëŠ” ì—­í• ì„ í•´. ì£¼ë¡œ **ë°ì´í„° ì‚­ì œ/ìˆ˜ì • ì‹œ** ì‚¬ìš©í•¨.
  
  ```
  @CacheEvict(value = "users", key = "#id")
  public void deleteUser(Long id) {
      userRepository.deleteById(id);
  }
  ```
  
  #### ğŸ”¹ ì£¼ìš” ì†ì„±
  
  | ì†ì„±               | ì„¤ëª…                                            |
  | ------------------ | ----------------------------------------------- |
  | `value`            | ìºì‹œ ì´ë¦„                                       |
  | `key`              | ì œê±°í•  í‚¤ ì§€ì •                                  |
  | `allEntries`       | `true`ì´ë©´ í•´ë‹¹ ìºì‹œ ì „ì²´ ì‚­ì œ                  |
  | `beforeInvocation` | `true`ë©´ ë©”ì„œë“œ ì‹¤í–‰ ì „ì— ìºì‹œ ì œê±° (ê¸°ë³¸ì€ í›„) |
  
  ##### ì˜ˆì‹œ - ì „ì²´ ìºì‹œ ì œê±°
  
  ```
  @CacheEvict(value = "users", allEntries = true)
  public void deleteAllUsers() {
      userRepository.deleteAll();
  }
  ```
  
  ##### ì˜ˆì‹œ - ì˜ˆì™¸ ë°œìƒ ì „ ì œê±°
  
  ```
  @CacheEvict(value = "users", key = "#id", beforeInvocation = true)
  public void riskyDelete(Long id) {
      if (id == null) throw new IllegalArgumentException();
      userRepository.deleteById(id);
  }
  ```
  
  ### 3. @CachePut
  
  #### ğŸ”¹ ê°œë…
  
  í•­ìƒ ë©”ì„œë“œë¥¼ ì‹¤í–‰í•˜ê³ , **ê·¸ ê²°ê³¼ë¥¼ ìºì‹œì— ê°•ì œë¡œ ê°±ì‹ (update)**í•œë‹¤.
   ì¦‰, `@Cacheable`ê³¼ ë‹¬ë¦¬ í•­ìƒ ì‹¤í–‰ë¨.
  
  ```
  @CachePut(value = "users", key = "#user.id")
  public User updateUser(User user) {
      return userRepository.save(user);
  }
  ```
  
  #### ğŸ”¹ ì£¼ìš” ì†ì„±
  
  - `value`: ìºì‹œ ì´ë¦„
  - `key`: SpELë¡œ ìºì‹œ í‚¤ ì„¤ì •
  
  > ê°±ì‹  ëŒ€ìƒ ë©”ì„œë“œê°€ ì‹¤ì œ ë°ì´í„°ë¥¼ ë³€ê²½í•  ë•Œ ìœ ìš©
  
  ------
  
  ### 4. ì˜ˆì‹œ: ì„¸ ì• ë„ˆí…Œì´ì…˜ í†µí•© í™œìš©
  
  ```
  @Service
  public class UserService {
  
      @Cacheable(value = "users", key = "#id")
      public User findById(Long id) {
          return userRepository.findById(id).orElse(null);
      }
  
      @CachePut(value = "users", key = "#user.id")
      public User updateUser(User user) {
          return userRepository.save(user);
      }
  
      @CacheEvict(value = "users", key = "#id")
      public void deleteUser(Long id) {
          userRepository.deleteById(id);
      }
  }
  ```
  
  ------
  
  ### 5. ìºì‹œ í‚¤ ê´€ë¦¬ ì „ëµ
  
  Springì˜ ê¸°ë³¸ í‚¤ ìƒì„± ë°©ì‹ì€ íŒŒë¼ë¯¸í„° ê¸°ë°˜ì´ë©°, ì»¤ìŠ¤í…€ í‚¤ ìƒì„±ê¸°ë¥¼ ì„¤ì •í•  ìˆ˜ë„ ìˆìŒ.
  
  ```
  @Bean
  public KeyGenerator customKeyGenerator() {
      return (target, method, params) -> {
          return method.getName() + "_" + Arrays.toString(params);
      };
  }
  ```
  
  ```
  @Cacheable(value = "users", keyGenerator = "customKeyGenerator")
  ```
  
  ### 6. ì£¼ì˜ì‚¬í•­ ë° íŒ
  
  | í•­ëª©           | ì£¼ì˜ ì‚¬í•­                                                    |
  | -------------- | ------------------------------------------------------------ |
  | í”„ë¡ì‹œ ê¸°ë°˜    | `@Cache*` ì• ë„ˆí…Œì´ì…˜ì€ í”„ë¡ì‹œ ë°©ì‹ì´ë¯€ë¡œ **ìê¸° í´ë˜ìŠ¤ ë‚´ë¶€ í˜¸ì¶œ ì‹œ ë™ì‘í•˜ì§€ ì•ŠìŒ** |
  | ë°˜í™˜ê°’ í•„ìˆ˜    | `@Cacheable`, `@CachePut` ë©”ì„œë“œëŠ” ë°˜ë“œì‹œ ë°˜í™˜ê°’ì´ ìˆì–´ì•¼ í•¨ |
  | `null` ìºì‹œ    | ìºì‹œ ì €ì¥ì†Œì— ë”°ë¼ `null` ê°’ ì €ì¥ ì—¬ë¶€ ë‹¤ë¦„ (RedisëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì €ì¥ ì•ˆ í•¨) |
  | íŠ¸ëœì­ì…˜       | ìºì‹œëŠ” DB íŠ¸ëœì­ì…˜ê³¼ ë³„ê°œë¡œ ë™ì‘í•˜ë¯€ë¡œ **íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì „ ìºì‹œ ì €ì¥ ì£¼ì˜** |
  | í…ŒìŠ¤íŠ¸ ì‹œ ì£¼ì˜ | í…ŒìŠ¤íŠ¸ ì¤‘ì—” ìºì‹œë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ê±°ë‚˜ êº¼ì•¼ ì˜ˆì™¸ì ì¸ ì¼€ì´ìŠ¤ í™•ì¸ ê°€ëŠ¥ |
  
  ### 7. ì €ì¥ì†Œ ì˜ˆì‹œ: Redis ì—°ë™
  
  #### ì˜ì¡´ì„± ì¶”ê°€ (Gradle)
  
  ```
  implementation 'org.springframework.boot:spring-boot-starter-data-redis'
  ```
  
  #### ì„¤ì • ì˜ˆì‹œ (`application.yml`)
  
  ```
  spring:
    cache:
      type: redis
    redis:
      host: localhost
      port: 6379
  ```
  
  ### ì •ë¦¬ ìš”ì•½
  
  | ì• ë„ˆí…Œì´ì…˜    | ì—­í•                       | í˜¸ì¶œ ì—¬ë¶€   | ìºì‹œ ì˜í–¥ |
  | ------------- | ------------------------- | ----------- | --------- |
  | `@Cacheable`  | ìºì‹œëœ ê²°ê³¼ ìˆìœ¼ë©´ ì¬ì‚¬ìš© | ì¡°ê±´ë¶€ ì‹¤í–‰ | ì¡°íšŒ      |
  | `@CacheEvict` | ìºì‹œ ì œê±°                 | í•­ìƒ ì‹¤í–‰   | ì‚­ì œ      |
  | `@CachePut`   | ê²°ê³¼ë¥¼ í•­ìƒ ìºì‹œì— ê°±ì‹    | í•­ìƒ ì‹¤í–‰   | ê°±ì‹       |

## ìºì‹œ ì €ì¥ì†Œ: Redis, Caffeine

### ğŸ”° ê³µí†µ ì „ì œ: Spring Cache ì¶”ìƒí™”

Springì€ ìì²´ `@Cacheable`, `@CacheEvict`, `@CachePut` ë“±ì„ ì‚¬ìš©í•´ **í‘œì¤€ APIë¥¼ ì œê³µ**í•˜ê³ , ì‹¤ì œ ì €ì¥ì†Œ êµ¬í˜„ì²´ë¥¼ ììœ ë¡­ê²Œ ë°”ê¿€ ìˆ˜ ìˆë‹¤.

```
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  @Cacheableâ”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
      [Spring Cache ì¶”ìƒí™”]
              â†“
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚   Redis  â”‚ Caffeine â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

------

### 1. âœ… Redis ìºì‹œ ì €ì¥ì†Œ

#### ğŸ”¹ íŠ¹ì§•

| í•­ëª©      | ì„¤ëª…                              |
| --------- | --------------------------------- |
| ë¶„ì‚°      | Yes (ë‹¤ì¤‘ ì„œë²„ ê°€ëŠ¥)              |
| ì˜ì†ì„±    | Yes (ì˜µì…˜)                        |
| TTL ì§€ì›  | Yes                               |
| í¬ê¸° ì œí•œ | ì—†ìŒ (ë©”ëª¨ë¦¬ ê¸°ë°˜)                |
| ì†ë„      | ë¹ ë¦„ (ë„¤íŠ¸ì›Œí¬ ë¹„ìš©ì€ ì¡´ì¬)       |
| ì¥ì       | ë‹¤ì¤‘ ì„œë²„ ê°„ ìºì‹œ ê³µìœ  ê°€ëŠ¥       |
| ë‹¨ì       | ì™¸ë¶€ ì„œë¹„ìŠ¤ ì˜ì¡´, Redis ì„¤ì¹˜ í•„ìš” |

------

#### ğŸ”¹ Gradle ì˜ì¡´ì„±

```
implementation 'org.springframework.boot:spring-boot-starter-data-redis'
```

------

#### ğŸ”¹ application.yml ì„¤ì • ì˜ˆì‹œ

```
spring:
  cache:
    type: redis
  redis:
    host: localhost
    port: 6379
```

------

#### ğŸ”¹ TTL ë° ìºì‹œ êµ¬ì„± ì„¤ì • (Java ê¸°ë°˜)

```
@Configuration
public class RedisCacheConfig {

    @Bean
    public RedisCacheConfiguration redisCacheConfiguration() {
        return RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(10)) // ê¸°ë³¸ TTL ì„¤ì •
            .disableCachingNullValues();     // null ìºì‹œ ë°©ì§€
    }
}
```

------

#### ğŸ”¹ TTLì„ ìºì‹œë§ˆë‹¤ ë‹¤ë¥´ê²Œ ì„¤ì • (ì˜ˆ: CacheManager customizer)

```
@Bean
public CacheManager cacheManager(RedisConnectionFactory connectionFactory) {
    Map<String, RedisCacheConfiguration> configMap = new HashMap<>();
    configMap.put("shortCache", RedisCacheConfiguration.defaultCacheConfig().entryTtl(Duration.ofSeconds(30)));
    configMap.put("longCache", RedisCacheConfiguration.defaultCacheConfig().entryTtl(Duration.ofHours(1)));

    return RedisCacheManager.builder(connectionFactory)
        .withInitialCacheConfigurations(configMap)
        .build();
}
```

------

### 2. âœ… Caffeine ìºì‹œ ì €ì¥ì†Œ (ë‚´ì¥í˜•)

#### ğŸ”¹ íŠ¹ì§•

| í•­ëª©     | ì„¤ëª…                   |
| -------- | ---------------------- |
| ë¶„ì‚°     | âŒ (ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ ì „ìš©) |
| ì˜ì†ì„±   | âŒ (JVM ì¢…ë£Œ ì‹œ ì†Œë©¸)   |
| TTL ì§€ì› | Yes                    |
| LRU ì§€ì› | Yes                    |
| ì†ë„     | ë§¤ìš° ë¹ ë¦„ (ë©”ëª¨ë¦¬ ë‚´)  |
| ì¥ì      | ì„¤ì¹˜ ë¶ˆí•„ìš”, ì„±ëŠ¥ íƒì›” |
| ë‹¨ì      | ë¶„ì‚° ìºì‹œ ë¶ˆê°€ëŠ¥       |

------

#### ğŸ”¹ Gradle ì˜ì¡´ì„±

```
implementation 'org.springframework.boot:spring-boot-starter-cache'
implementation 'com.github.ben-manes.caffeine:caffeine'
```

------

#### ğŸ”¹ application.yml ì„¤ì • ì˜ˆì‹œ

```
spring:
  cache:
    type: caffeine
  caffeine:
    spec: maximumSize=1000,expireAfterWrite=10m
```

> `maximumSize`: ìµœëŒ€ ì €ì¥ ê°œìˆ˜
>  `expireAfterWrite`: ì“°ê¸° ì´í›„ ë§Œë£Œ ì‹œê°„

------

#### ğŸ”¹ Java ê¸°ë°˜ êµ¬ì„± (ì„ íƒ ì‚¬í•­)

```
@Bean
public Caffeine<Object, Object> caffeineConfig() {
    return Caffeine.newBuilder()
        .expireAfterWrite(10, TimeUnit.MINUTES)
        .maximumSize(1000);
}

@Bean
public CacheManager cacheManager(Caffeine<Object, Object> caffeine) {
    return new CaffeineCacheManager("users", "products");
}
```

------

### 3. Redis vs Caffeine ë¹„êµ ì •ë¦¬

| í•­ëª©           | Redis                     | Caffeine           |
| -------------- | ------------------------- | ------------------ |
| ì„¤ì¹˜ í•„ìš”      | O (ì„œë²„ ë³„ë„)             | X                  |
| ë¶„ì‚° ìºì‹œ      | O (ë‹¤ì¤‘ ì„œë²„ ê³µìœ )        | X                  |
| ì†ë„           | ë¹ ë¦„ (ë„¤íŠ¸ì›Œí¬ ì¡´ì¬)      | ë” ë¹ ë¦„ (ë¡œì»¬ JVM) |
| TTL            | ì§€ì›                      | ì§€ì›               |
| LRU/ìµœëŒ€ í¬ê¸°  | ì„¤ì • ê°€ëŠ¥                 | ê¸°ë³¸ ì§€ì›          |
| ì¬ì‹œì‘ í›„ ë³´ì¡´ | ê°€ëŠ¥ (RDB, AOF)           | ë¶ˆê°€ëŠ¥             |
| ìºì‹œ ê³µìœ       | í´ëŸ¬ìŠ¤í„°/ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ìš© | ë‹¨ì¼ ì„œë¹„ìŠ¤ ì „ìš©   |
| ìš´ì˜ ë‚œì´ë„    | ë†’ìŒ                      | ë‚®ìŒ               |

------

### 4. ìºì‹œ ì´ë¦„ ê´€ë¦¬ íŒ

- `@Cacheable(value = "users")`ì—ì„œ `"users"`ëŠ” ë°˜ë“œì‹œ `CacheManager`ê°€ ì¸ì‹í•˜ëŠ” ì´ë¦„ì´ì–´ì•¼ í•¨
- ë™ì ìœ¼ë¡œ ìºì‹œ ìƒì„±í•˜ë ¤ë©´ `SimpleCacheManager` ë˜ëŠ” `CaffeineCacheManager`/`RedisCacheManager` ì„¤ì • í•„ìš”

------

### 5. ì‹¤ì „ ì‚¬ìš© ì „ëµ

| ì‹œë‚˜ë¦¬ì˜¤                     | ê¶Œì¥ ìºì‹œ                                |
| ---------------------------- | ---------------------------------------- |
| ë‹¨ì¼ ì• í”Œë¦¬ì¼€ì´ì…˜            | Caffeine                                 |
| ë©€í‹° ì¸ìŠ¤í„´ìŠ¤ ë°°í¬           | Redis                                    |
| ë¹ ë¥¸ TTL íšŒì „ í•„ìš”           | Caffeine                                 |
| ì‚¬ìš©ì ì¸ì¦ ì •ë³´ ì €ì¥        | Redis (ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ìš©)                  |
| ì‹¤ì‹œê°„ API ì‘ë‹µ ìºì‹±         | Redis (ë‹¨, ë†’ì€ ë¶€í•˜ ì‹œ Caffeineë„ ê³ ë ¤) |
| ì„ì‹œ ê³„ì‚° ìºì‹œ               | Caffeine                                 |
| ì‚¬ìš©ìë³„ ë°ì´í„° (ì„¸ì…˜, ê¶Œí•œ) | Redis + Spring Session                   |

### âœ… ë‹¤ìŒìœ¼ë¡œ?

- Redis + Caffeineì„ **í˜¼í•© êµ¬ì„±**í•  ìˆ˜ë„ ìˆì–´: **ë¡œì»¬ ìš°ì„  ìºì‹œ(Caffeine)** â†’ ì‹¤íŒ¨ ì‹œ Redis â†’ ì‹¤íŒ¨ ì‹œ DB
- `Spring CacheManager`ë¥¼ **ë©€í‹° ê³„ì¸µ ìºì‹œ(Multi-tier)**ë¡œ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•˜ëŠ” ê²ƒë„ ê°€ëŠ¥

## TTL, LRU ì „ëµ ì„¤ì •

### 1. TTL (Time To Live)

#### ğŸ”¹ ê°œë…

- TTLì€ **ë°ì´í„°ì˜ ìœ íš¨ ê¸°ê°„**ì„ ì„¤ì •í•˜ì—¬, ì¼ì • ì‹œê°„ì´ ì§€ë‚˜ë©´ ìë™ìœ¼ë¡œ ìºì‹œì—ì„œ ì‚­ì œë˜ê²Œ í•¨
- ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€, ì˜¤ë˜ëœ ë°ì´í„° ì œê±°ì— í•„ìˆ˜

------

#### âœ… Redisì—ì„œ TTL ì„¤ì •

#### ë°©ë²• 1: Global TTL ì„¤ì • (ì „ì²´ ìºì‹œì— ì¼ê´„ ì ìš©)

```
@Bean
public RedisCacheConfiguration redisCacheConfiguration() {
    return RedisCacheConfiguration.defaultCacheConfig()
        .entryTtl(Duration.ofMinutes(10));  // ëª¨ë“  ìºì‹œì— 10ë¶„ TTL
}
```

#### ë°©ë²• 2: ìºì‹œë³„ TTL ì„¤ì • (ìºì‹œ ì´ë¦„ë§ˆë‹¤ TTL ë‹¤ë¥´ê²Œ)

```
@Bean
public CacheManager cacheManager(RedisConnectionFactory connectionFactory) {
    Map<String, RedisCacheConfiguration> configMap = new HashMap<>();
    configMap.put("shortCache", RedisCacheConfiguration.defaultCacheConfig().entryTtl(Duration.ofSeconds(30)));
    configMap.put("longCache", RedisCacheConfiguration.defaultCacheConfig().entryTtl(Duration.ofHours(1)));

    return RedisCacheManager.builder(connectionFactory)
        .withInitialCacheConfigurations(configMap)
        .cacheDefaults(RedisCacheConfiguration.defaultCacheConfig().entryTtl(Duration.ofMinutes(10)))
        .build();
}
```

------

#### âœ… Caffeineì—ì„œ TTL ì„¤ì •

```
spring:
  cache:
    type: caffeine
  caffeine:
    spec: expireAfterWrite=5m,expireAfterAccess=10m
```

ë˜ëŠ” Java ê¸°ë°˜ ì„¤ì •:

```
@Bean
public Caffeine<Object, Object> caffeineConfig() {
    return Caffeine.newBuilder()
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .expireAfterAccess(10, TimeUnit.MINUTES);
}
```

| ì „ëµ                | ì„¤ëª…                                      |
| ------------------- | ----------------------------------------- |
| `expireAfterWrite`  | ì“°ê¸° ì´í›„ ê²½ê³¼ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ TTL ì ìš©     |
| `expireAfterAccess` | ë§ˆì§€ë§‰ ì ‘ê·¼ ì‹œì ë¶€í„° TTL ì ìš© (ì½ê¸° í¬í•¨) |

------

### 2. LRU (Least Recently Used)

#### ğŸ”¹ ê°œë…

- LRUëŠ” **ê°€ì¥ ì˜¤ë˜ ì‚¬ìš©ë˜ì§€ ì•Šì€ ìºì‹œ í•­ëª©ì„ ì œê±°**í•˜ëŠ” ë°©ì‹
- ìºì‹œ ìš©ëŸ‰ ì´ˆê³¼ ì‹œ ë©”ëª¨ë¦¬ ë³´í˜¸ìš©ìœ¼ë¡œ ê°€ì¥ ë§ì´ ì“°ì„

------

#### âœ… Redisì—ì„œ LRU ì„¤ì •

RedisëŠ” TTLê³¼ëŠ” ë‹¤ë¥´ê²Œ, **LRU ì •ì±…ì€ Redis ì„œë²„ ìì²´ ì„¤ì •**ì—ì„œ ìˆ˜í–‰ë¨.

#### â‘  Redis ì„¤ì •íŒŒì¼ (redis.conf)

```
maxmemory 256mb
maxmemory-policy allkeys-lru
```

#### â‘¡ ë©”ëª¨ë¦¬ ì„¤ì • ëª…ë ¹ì–´ë¡œë„ ê°€ëŠ¥

```
CONFIG SET maxmemory 256mb
CONFIG SET maxmemory-policy allkeys-lru
```

| ì •ì±…             | ì„¤ëª…                              |
| ---------------- | --------------------------------- |
| `noeviction`     | ê¸°ë³¸ê°’, ë©”ëª¨ë¦¬ ì´ˆê³¼ ì‹œ ì˜¤ë¥˜ ë°œìƒ  |
| `allkeys-lru`    | ì „ì²´ í‚¤ ëŒ€ìƒ LRU ì œê±°             |
| `volatile-lru`   | TTL ì„¤ì •ëœ í‚¤ë§Œ ëŒ€ìƒìœ¼ë¡œ LRU ì œê±° |
| `allkeys-random` | ë¬´ì‘ìœ„ ì œê±°                       |
| `volatile-ttl`   | TTLì´ ê°€ì¥ ê°€ê¹Œìš´ í‚¤ ì œê±°         |

------

#### âœ… Caffeineì—ì„œ LRU ìœ ì‚¬ ì •ì±… ì„¤ì •

Caffeineì€ ë‚´ë¶€ì ìœ¼ë¡œ LRUë³´ë‹¤ ë” ì •êµí•œ **Window TinyLFU (W-TinyLFU)** ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ì§€ë§Œ, ì¼ë°˜ì ì¸ LRUì™€ ê±°ì˜ ë™ì¼í•œ íš¨ê³¼ë¥¼ ì œê³µí•œë‹¤.

```
spring:
  cache:
    type: caffeine
  caffeine:
    spec: maximumSize=1000
```

ë˜ëŠ” Java ì„¤ì •:

```
@Bean
public Caffeine<Object, Object> caffeineConfig() {
    return Caffeine.newBuilder()
        .maximumSize(1000) // ì´ˆê³¼ ì‹œ LRU ë°©ì‹ìœ¼ë¡œ ì œê±°
        .expireAfterAccess(10, TimeUnit.MINUTES);
}
```

> `maximumSize`: í•­ëª© ìˆ˜ ì œí•œ
>  ë‚´ë¶€ì ìœ¼ë¡œ LRUì™€ LFU í˜¼í•© ì „ëµ (ë¹ˆë„ + ìµœê·¼ì„±)

------

### 3. TTL + LRU ë™ì‹œ ì„¤ì • ì „ëµ

#### Redis: TTL + ì„œë²„ ë ˆë²¨ LRU ì¡°í•©

- `@Cacheable` ê²°ê³¼ëŠ” TTLë¡œ ë§Œë£Œë˜ë©°,
- Redis ì „ì²´ ë©”ëª¨ë¦¬ê°€ ì´ˆê³¼ë˜ë©´ **LRU ê¸°ì¤€ìœ¼ë¡œ ìë™ ì œê±°ë¨**

#### Caffeine: TTL + ìµœëŒ€ í¬ê¸° ì¡°í•©

```
return Caffeine.newBuilder()
    .maximumSize(1000)             // LRU ì œê±°
    .expireAfterWrite(10, TimeUnit.MINUTES) // TTL
    .build();
```

------

### 4. ì „ëµ ì„ íƒ íŒ

| ìƒí™©                          | ê¶Œì¥ ì„¤ì •                                            |
| ----------------------------- | ---------------------------------------------------- |
| ìºì‹œ í•­ëª© ìˆ˜ ì œí•œ í•„ìš”        | `maximumSize` (Caffeine), `maxmemory-policy` (Redis) |
| ë¯¼ê°í•œ ë°ì´í„° ìë™ ë§Œë£Œ       | `expireAfterWrite` (Caffeine), `entryTtl` (Redis)    |
| ìµœê·¼ ì‚¬ìš© ìœ„ì£¼ë¡œ ë³´ì¡´         | `expireAfterAccess`, `allkeys-lru`                   |
| ì „ì—­ ì„¤ì • + ì„¸ë¶€ ì»¤ìŠ¤í„°ë§ˆì´ì§• | Redis + ìºì‹œë³„ TTL                                   |
| ìºì‹œ ë¶€ë‹´ ì—†ëŠ” ë¹ ë¥¸ ì²˜ë¦¬      | Caffeine (ë¡œì»¬ ë©”ëª¨ë¦¬ ë¹ ë¦„)                          |

------

### 5. í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ ë°©ë²•

#### Redisì—ì„œ TTL í™•ì¸

```
TTL users::123
```

â†’ ê²°ê³¼ê°€ `300`ì´ë©´ 5ë¶„ ë‚¨ì•˜ë‹¤ëŠ” ëœ»

#### Caffeineì€ JVM ë‚´ í™•ì¸ í•„ìš” â†’ ë¡œê·¸ ì¶œë ¥ ë˜ëŠ” `MeterRegistry` + Actuator ì´ìš©

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½

| í•­ëª©      | Redis                | Caffeine             |
| --------- | -------------------- | -------------------- |
| TTL ì„¤ì •  | `entryTtl(Duration)` | `expireAfterWrite()` |
| LRU ì„¤ì •  | `maxmemory-policy`   | `maximumSize()`      |
| ê°•ì œ ì‚­ì œ | `@CacheEvict`        | ë™ì¼                 |
| ë³µí•© ì „ëµ | TTL + LRU ê°€ëŠ¥       | TTL + Size ê°€ëŠ¥      |

## ë™ì‹œì„± ê³ ë ¤í•œ ìºì‹œ ì—…ë°ì´íŠ¸

### 1. ë¬¸ì œ ìœ í˜• ìš”ì•½

| ë¬¸ì œ ì´ë¦„         | ì„¤ëª…                                                        |
| ----------------- | ----------------------------------------------------------- |
| â— Cache Stampede  | ë‹¤ìˆ˜ì˜ ìš”ì²­ì´ ë™ì‹œì— ìºì‹œ ë¯¸ìŠ¤ë¥¼ ë°œìƒì‹œí‚¤ë©° DBë¡œ ëª°ë¦¼       |
| â— Race Condition  | ë™ì‹œì— ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì¼ ë°ì´í„°ë¥¼ ìºì‹œì— ì“°ë©° ê²°ê³¼ê°€ ê¼¬ì„  |
| â— Inconsistency   | DBëŠ” ì—…ë°ì´íŠ¸ë˜ì—ˆì§€ë§Œ ìºì‹œëŠ” ì—¬ì „íˆ ì˜ˆì „ ê°’ì„ ë“¤ê³  ìˆìŒ     |
| â— Thundering Herd | í•˜ë‚˜ì˜ í‚¤ì— ë§ì€ íŠ¸ë˜í”½ì´ ëª°ë¦´ ë•Œ TTL ë§Œë£Œ ì§í›„ ìš”ì²­ì´ í­ì£¼ |

------

### 2. í•´ê²° ì „ëµ ê°œìš”

| ì „ëµ                           | ì„¤ëª…                                              |
| ------------------------------ | ------------------------------------------------- |
| âœ… ë™ê¸°í™”(Cache Lock)           | íŠ¹ì • í‚¤ì— ëŒ€í•´ ë™ì‹œì— í•˜ë‚˜ë§Œ ê°±ì‹ í•˜ë„ë¡ Lock ì‚¬ìš© |
| âœ… Refresh-Ahead                | ë§Œë£Œ ì „ì— ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¯¸ë¦¬ ê°±ì‹                 |
| âœ… Local Lock + Redis Lock í˜¼í•© | JVM ë‚´ë¶€ + ë¶„ì‚° í™˜ê²½ ê³ ë ¤                         |
| âœ… Double Check                 | ìºì‹œ í™•ì¸ â†’ DB í™•ì¸ â†’ ë‹¤ì‹œ ìºì‹œ í™•ì¸              |
| âœ… Async ê°±ì‹                    | ìºì‹œ ê°±ì‹ ì„ ë¹„ë™ê¸° ì‘ì—…ìœ¼ë¡œ ë¶„ë¦¬                  |

------

### 3. âœ… ë°©ë²• 1: `@Cacheable(sync = true)` ì‚¬ìš©

> Spring 4.3+ ì§€ì›
>  `sync = true`ë¥¼ ì‚¬ìš©í•˜ë©´ **ë™ì¼ í‚¤ë¡œ ë™ì‹œì— ë“¤ì–´ì˜¨ ìš”ì²­ì€ í•˜ë‚˜ë§Œ ì‹¤í–‰**ë˜ê³  ë‚˜ë¨¸ì§€ëŠ” ê¸°ë‹¤ë¦°ë‹¤.

```
@Cacheable(value = "products", key = "#id", sync = true)
public Product getProduct(Long id) {
    return productRepository.findById(id).orElseThrow();
}
```

### âš ï¸ ì œì•½ì‚¬í•­

- ë™ê¸°í™”ëŠ” **ê°œë³„ ìºì‹œ í•­ëª©(key) ìˆ˜ì¤€**ì„
- ë‹¨ì¼ JVMì—ì„œë§Œ ì‘ë™ (ë¶„ì‚° í™˜ê²½ì€ ë³„ë„ ì²˜ë¦¬ í•„ìš”)

------

### 4. âœ… ë°©ë²• 2: ë¶„ì‚° ë½ (ì˜ˆ: Redis Lock)

```
String lockKey = "lock:product:" + id;
boolean acquired = redisTemplate.opsForValue().setIfAbsent(lockKey, "1", Duration.ofSeconds(5));

if (acquired) {
    try {
        Product data = repository.findById(id).orElseThrow();
        redisTemplate.opsForValue().set("product:" + id, data, Duration.ofMinutes(5));
        return data;
    } finally {
        redisTemplate.delete(lockKey); // ë½ í•´ì œ
    }
} else {
    // ë½ì´ ê±¸ë ¤ ìˆìœ¼ë©´ ëŒ€ê¸°í•˜ê±°ë‚˜ fallback
    Thread.sleep(100); return getFromCache(); // ì¬ì‹œë„
}
```

#### ë¼ì´ë¸ŒëŸ¬ë¦¬ í™œìš© ì˜ˆì‹œ

- Redisson
- Lettuce ê¸°ë°˜ Redis Lock

------

### 5. âœ… ë°©ë²• 3: Caffeine Refresh Ahead (ë¹„ë™ê¸° ë¯¸ë¦¬ ê°±ì‹ )

> Caffeineì€ TTLì´ ë„ë‹¬í•˜ê¸° ì „ì— ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œì—ì„œ ë°ì´í„°ë¥¼ ë¯¸ë¦¬ ê°±ì‹ í•  ìˆ˜ ìˆìŒ

```
return Caffeine.newBuilder()
    .maximumSize(1000)
    .refreshAfterWrite(10, TimeUnit.MINUTES)
    .build(key -> loadFromDatabase(key));
```

### âš ï¸ ì£¼ì˜

- `refreshAfterWrite`ëŠ” **ë°ì´í„°ê°€ ìºì‹œëœ í›„ íŠ¹ì • ì‹œê°„ì´ ì§€ë‚˜ë©´ ìë™ìœ¼ë¡œ ë¹„ë™ê¸° ê°±ì‹ **
- ê°±ì‹  í•¨ìˆ˜ëŠ” `build(Function<K, V>)`ë¥¼ í†µí•´ ë“±ë¡í•´ì•¼ í•¨

------

### 6. âœ… ë°©ë²• 4: Double Check + Fallback

```
public Product getProduct(Long id) {
    Product cached = cache.get(id);
    if (cached != null) return cached;

    synchronized (("productLock:" + id).intern()) {
        // Double check
        Product recheck = cache.get(id);
        if (recheck != null) return recheck;

        Product dbData = repository.findById(id).orElseThrow();
        cache.put(id, dbData);
        return dbData;
    }
}
```

- `String.intern()`ì„ í†µí•´ JVM ë‚´ì—ì„œ ë™ê¸°í™”
- ë˜ëŠ” `ConcurrentHashMap<id, ReentrantLock>` ë°©ì‹ë„ ê°€ëŠ¥

------

### 7. âœ… ë°©ë²• 5: Cache Aside íŒ¨í„´ with ê°±ì‹  ì´ë²¤íŠ¸

```
// 1ë‹¨ê³„: DBë¥¼ ê°±ì‹ í•œë‹¤
repository.update(product);

// 2ë‹¨ê³„: ìºì‹œë¥¼ ë¬´íš¨í™”í•˜ê±°ë‚˜ ì§ì ‘ ë®ì–´ì“´ë‹¤
cacheManager.getCache("products").evict(product.getId()); // ë˜ëŠ” put()
```

- ìºì‹œë¥¼ **ì™„ì „íˆ ë¹„ìš°ê±°ë‚˜ ìµœì‹  ë°ì´í„°ë¡œ overwrite**
- ìºì‹œ ë¬´íš¨í™” ì‹œì ì€ íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì´í›„ê°€ ì•ˆì „í•¨

------

### 8. ì „ëµ ë¹„êµ ì •ë¦¬

| ì „ëµ                         | ë™ì‹œì„± ì œì–´   | ë¶„ì‚° í™˜ê²½ | êµ¬í˜„ ë³µì¡ë„ | ì‹¤ìš©ì„±           |
| ---------------------------- | ------------- | --------- | ----------- | ---------------- |
| `@Cacheable(sync = true)`    | âœ…             | âŒ         | ì•„ì£¼ ë‚®ìŒ   | ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ ì•± |
| Redis Lock                   | âœ…             | âœ…         | ì¤‘ê°„        | ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤   |
| Caffeine `refreshAfterWrite` | â­• (ë¹„ë™ê¸°)    | âŒ         | ë‚®ìŒ        | ë¹ ë¥¸ ë¡œì»¬ ìºì‹œ   |
| Double Check                 | âœ…             | âŒ         | ë‚®ìŒ        | ë¡œì»¬ ì•±          |
| Cache Aside                  | âœ… (ì œì–´ ê°€ëŠ¥) | âœ…         | ì¤‘ê°„        | ë²”ìš©             |

------

### 9. ì‹¤ì „ ì‹œë‚˜ë¦¬ì˜¤ ì˜ˆì‹œ

```
ì‚¬ìš©ìê°€ ìƒí’ˆ ìƒì„¸ ì •ë³´ë¥¼ ìš”ì²­í•¨
â†’ ìºì‹œ ë¯¸ìŠ¤ ë°œìƒ
â†’ í•˜ë‚˜ì˜ ìš”ì²­ì´ DBì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´ (Lock íšë“)
â†’ ê²°ê³¼ë¥¼ ìºì‹œì— ì €ì¥
â†’ ë‹¤ë¥¸ ìš”ì²­ì€ ìºì‹œì—ì„œ ì½ìŒ
â†’ ì´í›„ 5ë¶„ ì§€ë‚˜ë©´ ìë™ ë§Œë£Œ ë˜ëŠ” refresh
```

------

### âœ… ë§ˆë¬´ë¦¬ ì •ë¦¬

- ìºì‹œ ë™ì‹œì„± ë¬¸ì œëŠ” ë‹¨ìˆœíˆ `@Cacheable`ë§Œìœ¼ë¡œëŠ” ì™„ë²½íˆ í•´ê²°ë˜ì§€ ì•ŠìŒ
- `sync = true`ëŠ” ê°„ë‹¨í•˜ì§€ë§Œ **ë‹¨ì¼ ì„œë²„ í•œì •**
- **Redis Lock + Double Check**ê°€ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í™˜ê²½ì—ì„œ ê°€ì¥ ë„ë¦¬ ì“°ì„
- Caffeineì€ **refreshAhead** ê¸°ëŠ¥ì„ í™œìš©í•˜ë©´ ë›°ì–´ë‚œ ì„±ëŠ¥
- ë°ì´í„° ì¼ê´€ì„±ì´ ì¤‘ìš”í•œ ê²½ìš°ì—” í•­ìƒ **íŠ¸ëœì­ì…˜ê³¼ ìºì‹œ ì—…ë°ì´íŠ¸ ì‹œì **ì„ ì£¼ì˜

## API ì‘ë‹µ ìºì‹±

### 1. ê°œìš”: ì™œ API ì‘ë‹µì„ ìºì‹±í• ê¹Œ?

API ì‘ë‹µì€ ì¼ë°˜ì ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ê²½ìš°ì— ìºì‹±ì´ ìœ ë¦¬í•´:

- ìì£¼ í˜¸ì¶œë˜ì§€ë§Œ ë³€ê²½ì´ ë“œë¬¸ ë°ì´í„°
   (ì˜ˆ: ìƒí’ˆ ëª©ë¡, ì¹´í…Œê³ ë¦¬, í™˜ìœ¨, ê³µê³µ API)
- ì‘ë‹µ ìƒì„± ë¹„ìš©ì´ ë¹„ì‹¼ ì‘ì—… (ë³µì¡í•œ JOIN, ì™¸ë¶€ API ì—°ë™ ë“±)
- ì‹¤ì‹œê°„ì„±ì´ í¬ê²Œ ì¤‘ìš”í•˜ì§€ ì•Šê³ , ì•½ê°„ì˜ ì§€ì—° í—ˆìš© ê°€ëŠ¥í•  ë•Œ

------

### 2. ê¸°ë³¸ ë°©ì‹: `@Cacheable`ë¡œ ì‘ë‹µ ìºì‹±

Springì—ì„œëŠ” **ì»¨íŠ¸ë¡¤ëŸ¬ë‚˜ ì„œë¹„ìŠ¤ ë ˆì´ì–´ ë©”ì„œë“œ**ì— `@Cacheable`ì„ ë¶™ì´ëŠ” ê²ƒë§Œìœ¼ë¡œ ìºì‹± ê°€ëŠ¥

```
@Cacheable(value = "productCache", key = "#id")
public ProductResponse getProductById(Long id) {
    log.info("DB or ì™¸ë¶€ í˜¸ì¶œ ìˆ˜í–‰");
    return productService.getProduct(id);
}
```

#### ì´ë•Œ ìºì‹œì— ì €ì¥ë˜ëŠ” ê²ƒì€?

- **ë©”ì„œë“œì˜ ë¦¬í„´ê°’** ì „ì²´ê°€ ìºì‹œë¨
- ì§ë ¬í™” ê°€ëŠ¥í•´ì•¼ í•¨ (RedisëŠ” Jackson ê¸°ë°˜ìœ¼ë¡œ ìë™ ì§ë ¬í™”)

------

### 3. Controller ë ˆë²¨ ìºì‹±ë„ ê°€ëŠ¥í• ê¹Œ?

ì§ì ‘ì€ ì•ˆ ë˜ì§€ë§Œ, **ì„œë¹„ìŠ¤ ë ˆì´ì–´ì—ì„œ ì²˜ë¦¬**í•˜ëŠ” ê²ƒì´ ê¶Œì¥ë¨. í•˜ì§€ë§Œ ì˜ˆì™¸ì ìœ¼ë¡œ Controllerì—ë„ ì ìš© ê°€ëŠ¥:

```
@RestController
@RequiredArgsConstructor
public class ProductController {
    private final ProductService productService;

    @GetMapping("/api/product/{id}")
    public ResponseEntity<ProductResponse> getProduct(@PathVariable Long id) {
        return ResponseEntity.ok(productService.getProductById(id)); // ì„œë¹„ìŠ¤ì—ì„œ ìºì‹±
    }
}
```

------

### 4. ìºì‹œ Key ì „ëµ

| ì „ëµ              | ì˜ˆì‹œ                          | ì„¤ëª…                               |
| ----------------- | ----------------------------- | ---------------------------------- |
| ë‹¨ì¼ íŒŒë¼ë¯¸í„°     | `key = "#id"`                 | ìˆ«ì, ID                           |
| ë³µìˆ˜ íŒŒë¼ë¯¸í„°     | `key = "#name + '_' + #type"` | ë¬¸ìì—´ ì¡°í•©                        |
| Request ê°ì²´ ì „ì²´ | `key = "#request.toString()"` | ê¶Œì¥ âŒ, ëª…í™•í•œ í‚¤ ìƒì„±ê¸° ì‚¬ìš© ì¶”ì²œ |

#### ì»¤ìŠ¤í…€ í‚¤ ìƒì„±ê¸°

```
@Bean
public KeyGenerator keyGenerator() {
    return (target, method, params) ->
        method.getName() + "_" + Arrays.toString(params);
}
```

```
@Cacheable(value = "myApiCache", keyGenerator = "keyGenerator")
```

------

### 5. TTL ì„¤ì •ê³¼ ìºì‹œ ì €ì¥ì†Œ ì§€ì •

#### Redisë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°

```
spring:
  cache:
    type: redis
  redis:
    host: localhost
    port: 6379
```

```
@Bean
public RedisCacheConfiguration redisCacheConfiguration() {
    return RedisCacheConfiguration.defaultCacheConfig()
        .entryTtl(Duration.ofMinutes(3))
        .disableCachingNullValues();
}
```

------

### 6. ì‹¤ì „ íŒ¨í„´: API ì‘ë‹µ ìºì‹± íŒ¨í„´ ì˜ˆì‹œ

```
@Cacheable(value = "exchangeRates", key = "#currency", unless = "#result == null")
public ExchangeRateResponse getRate(String currency) {
    // ì™¸ë¶€ í™˜ìœ¨ API í˜¸ì¶œ
}
```

```
@CacheEvict(value = "exchangeRates", key = "#currency")
public void refreshRate(String currency) {
    // ìˆ˜ë™ ìºì‹œ ê°±ì‹ 
}
```

------

### 7. ê³ ê¸‰ ì „ëµ: ì¡°ê±´ë¶€ ìºì‹±

```
@Cacheable(value = "products", key = "#id", condition = "#id > 0", unless = "#result == null")
public ProductResponse getProductById(Long id) {
    ...
}
```

- `condition`: trueì¼ ë•Œë§Œ ìºì‹œ ì‹œë„
- `unless`: trueì¼ ë•Œ ìºì‹±í•˜ì§€ ì•ŠìŒ (ìºì‹œ ë¬´ì‹œ)

------

### 8. ì£¼ì˜ì‚¬í•­

| í•­ëª©         | ì£¼ì˜                                                     |
| ------------ | -------------------------------------------------------- |
| ê°ì²´ ì§ë ¬í™”  | Redisì— ì €ì¥ ì‹œ ì§ë ¬í™” í•„ìš” (Jacksonì´ ê¸°ë³¸)             |
| ìºì‹œ ë¬´íš¨í™”  | DB ë³€ê²½ ì‹œ `@CacheEvict` í•„ìˆ˜                            |
| ìºì‹œ ë²”ëŒ    | key ë²”ìœ„ ì œí•œ / TTL í•„ìˆ˜                                 |
| ì˜ˆì™¸ ë°œìƒ ì‹œ | ìºì‹œì— ì €ì¥í•˜ì§€ ì•Šë„ë¡ `unless = "#result == null"` ì„¤ì • |
| ì‹¤ì‹œê°„ ì‘ë‹µ  | ì£¼ê¸°ì  ê°±ì‹  ì „ëµ í•„ìš” (ì˜ˆ: `@Scheduled`)                 |

------

### 9. ì‹¤ì „ ì„¤ê³„ ì˜ˆì‹œ: ì œí’ˆ ìƒì„¸ ì¡°íšŒ API

```
@GetMapping("/api/products/{id}")
public ProductResponse getProduct(@PathVariable Long id) {
    return productService.getProductById(id); // ë‚´ë¶€ì—ì„œ ìºì‹œ ì‚¬ìš©
}
```

```
@Cacheable(value = "productDetails", key = "#id")
public ProductResponse getProductById(Long id) {
    log.info("DB í˜¸ì¶œ ë°œìƒ");
    return repository.findProductDetail(id);
}
```

------

### 10. ìºì‹œ ë¬´íš¨í™” ì „ëµ

| ì‹œì           | ë°©ë²•                                            |
| ------------- | ----------------------------------------------- |
| ë°ì´í„° ìˆ˜ì •   | `@CacheEvict(key=...)`                          |
| ë°°ì¹˜ ì²˜ë¦¬     | `cacheManager.getCache(...).clear()`            |
| TTL ìë™ ë§Œë£Œ | Redis: `entryTtl`, Caffeine: `expireAfterWrite` |
| ê°•ì œ ë¦¬ë¡œë“œ   | `@CachePut` ë˜ëŠ” API ìˆ˜ë™ í˜¸ì¶œ í›„ ìºì‹œ ê°±ì‹      |

------

### 11. ë„êµ¬ ë° ë³´ì¡° ì „ëµ

| ë„êµ¬               | ëª©ì                                    |
| ------------------ | -------------------------------------- |
| Redis              | ë¶„ì‚° ìºì‹œ ì €ì¥ì†Œ                       |
| Caffeine           | ë¹ ë¥¸ ë¡œì»¬ ìºì‹œ                         |
| Actuator + /caches | í˜„ì¬ ìºì‹œ ìƒíƒœ í™•ì¸                    |
| Spring AOP + TTL   | ë¹„ë™ê¸° ìë™ ê°±ì‹  ì„¤ê³„ ê°€ëŠ¥             |
| MeterRegistry      | ìºì‹œ ì ì¤‘ë¥  ëª¨ë‹ˆí„°ë§ ê°€ëŠ¥ (Micrometer) |

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½

| í•­ëª©        | ì„¤ëª…                                      |
| ----------- | ----------------------------------------- |
| ëª©ì         | API ì‘ë‹µ ì†ë„ í–¥ìƒ, DB ë¶€í•˜ ê°ì†Œ          |
| ìœ„ì¹˜        | ì„œë¹„ìŠ¤ ê³„ì¸µì— `@Cacheable` ê¶Œì¥           |
| TTL         | Redis / Caffeine ëª¨ë‘ ì§€ì›                |
| ë¬´íš¨í™”      | `@CacheEvict`, TTL, ìˆ˜ë™ ë°©ì‹             |
| ì¡°ê±´ë¶€ ìºì‹± | `condition`, `unless`ë¡œ ì œì–´              |
| ì €ì¥ì†Œ      | Redis(ë©€í‹° ì¸ìŠ¤í„´ìŠ¤), Caffeine(ë¡œì»¬ ê³ ì†) |