# 5. ì„œë¹„ìŠ¤ ê³„ì¸µ (Service Layer)

## `@Service` í´ë˜ìŠ¤ì˜ ì—­í• 

### ğŸ” 1. `@Service`ë€?

`@Service`ëŠ” Spring Frameworkì—ì„œ **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ê³„ì¸µ(=ì„œë¹„ìŠ¤ ê³„ì¸µ)**ì— ë¶™ì´ëŠ” ì»´í¬ë„ŒíŠ¸ ì–´ë…¸í…Œì´ì…˜ì´ì•¼.

> ë‚´ë¶€ì ìœ¼ë¡œëŠ” `@Component`ì˜ íŠ¹ìˆ˜í™”(Stereotype)ì´ë©°,
>  **ë¹„ì¦ˆë‹ˆìŠ¤ íŠ¸ëœì­ì…˜ê³¼ ë„ë©”ì¸ ì¡°í•©ì˜ ì¤‘ì‹¬**ìœ¼ë¡œ ë™ì‘í•´.

------

### ğŸ§­ 2. ì„œë¹„ìŠ¤ ê³„ì¸µ(Service Layer)ì˜ ëª©ì 

| ëª©í‘œ                 | ì„¤ëª…                                                         |
| -------------------- | ------------------------------------------------------------ |
| ğŸ“¦ ë¹„ì¦ˆë‹ˆìŠ¤ íë¦„ êµ¬í˜„ | ë„ë©”ì¸ ê°ì²´, Repository, ì™¸ë¶€ ì‹œìŠ¤í…œ ë“±ì„ ì¡°í•©í•´ ë³µì¡í•œ ìœ ìŠ¤ì¼€ì´ìŠ¤ ì‹¤í–‰ |
| ğŸ” íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì • | `@Transactional`ë¡œ DB ì‘ì—…ì„ ë¬¶ì–´ì„œ ì‹¤í–‰/ë¡¤ë°±                |
| ğŸ§  ë„ë©”ì¸ ë¡œì§ í˜¸ì¶œ   | ë„ë©”ì¸ ê°ì²´ê°€ ì •ì˜í•œ í•µì‹¬ ë¡œì§ì„ **ìœ„ì„**í•˜ì—¬ ì‹¤í–‰           |
| ğŸ”„ ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ê³„   | ê²°ì œ API, ì´ë©”ì¼ ë°œì†¡, Kafka ì „ì†¡ ë“± ë„ë©”ì¸ ì™¸ë¶€ ìš”ì†Œ í˜¸ì¶œ í¬í•¨ ê°€ëŠ¥ |
| ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ëŒ€ìƒ   | ë¡œì§ì´ ì§‘ì¤‘ë˜ë¯€ë¡œ í…ŒìŠ¤íŠ¸ ì¤‘ì‹¬ ê³„ì¸µì´ê¸°ë„ í•¨                  |

------

### âš™ï¸ 3. ì „í˜•ì ì¸ ì—­í•  ìš”ì•½

| ê¸°ëŠ¥                  | ì—­í•                                                       |
| --------------------- | --------------------------------------------------------- |
| ğŸ’¡ ìœ ìŠ¤ì¼€ì´ìŠ¤ ì¡°ë¦½     | ì—¬ëŸ¬ ë„ë©”ì¸ ê°ì²´/Repoì˜ ìˆœì„œ ì •ì˜                         |
| ğŸ” ì…ë ¥ ê²€ì¦/ì¡°ê±´ íŒë‹¨ | íŠ¹ì • ì¡°ê±´ì— ë”°ë¼ íë¦„ ë¶„ê¸° (ë„ë©”ì¸ ì´ì „ ë‹¨ê³„ì˜ ì¡°ê±´ íŒë‹¨) |
| ğŸ” íŠ¸ëœì­ì…˜ ì„¤ì •       | `@Transactional` ì‚¬ìš©                                     |
| ğŸ§± ë„ë©”ì¸ í˜¸ì¶œ         | `user.createAccount()`, `order.markAsPaid()`              |
| â˜ ì™¸ë¶€ í˜¸ì¶œ           | `paymentGateway.charge(...)`, `emailSender.send(...)`     |

------

### ğŸ§ª 4. ì‹¤ì „ ì˜ˆì‹œ

```
@Service
public class OrderService {

    private final OrderRepository orderRepository;
    private final InventoryRepository inventoryRepository;
    private final PaymentGateway paymentGateway;

    @Transactional
    public void placeOrder(Long userId, Long itemId, int quantity, PaymentInfo paymentInfo) {
        Inventory inventory = inventoryRepository.findByItemId(itemId);
        inventory.decrease(quantity);

        paymentGateway.charge(paymentInfo);

        Order order = new Order(userId, itemId, quantity);
        order.markAsPaid();

        orderRepository.save(order);
    }
}
```

------

### ğŸ” 5. `@Service`ì˜ ìœ„ì¹˜ì™€ ì–´ë…¸í…Œì´ì…˜

| ì–´ë…¸í…Œì´ì…˜                 | ì„¤ëª…                                               |
| -------------------------- | -------------------------------------------------- |
| `@Service`                 | Spring ì»¨í…Œì´ë„ˆì— ë“±ë¡. ì„œë¹„ìŠ¤ ì—­í•  ëª…ì‹œ           |
| `@Transactional`           | íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •. ë°˜ë“œì‹œ ì„œë¹„ìŠ¤ ê³„ì¸µì— ì„ ì–¸í•  ê²ƒ |
| `@RequiredArgsConstructor` | ìƒì„±ì ì£¼ì…ì„ í¸í•˜ê²Œ ì„¤ì • (Lombok ì‚¬ìš© ì‹œ)         |

------

### ğŸ“š 6. ì•ˆí‹°íŒ¨í„´ í”¼í•˜ê¸°

| ì•ˆí‹°íŒ¨í„´                  | ì„¤ëª…                                                         |
| ------------------------- | ------------------------------------------------------------ |
| âŒ Fat Service             | ëª¨ë“  ë¡œì§ì´ ì„œë¹„ìŠ¤ì— ëª°ë ¤ìˆê³  ë„ë©”ì¸ì€ ë¹ˆ ê»ë°ê¸° â†’ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ì€ ë„ë©”ì¸ìœ¼ë¡œ ë¶„ë¦¬í•  ê²ƒ |
| âŒ ë„ë©”ì¸ ë¬´ì‹œ             | ì„œë¹„ìŠ¤ê°€ ì—”í‹°í‹°ì˜ ìƒíƒœë¥¼ ì§ì ‘ ë³€ê²½ (`order.setStatus(...)`) â† ë°˜ë“œì‹œ ë„ë©”ì¸ ë©”ì„œë“œë¥¼ í†µí•´ ë³€ê²½ |
| âŒ ë¬´ì˜ë¯¸í•œ íŒ¨ì‹¯(Facade)í™” | ë‹¨ìˆœ CRUDë§Œ í•˜ëŠ” `UserService.save()`, `findById()`ëŠ” ì¡´ì¬ ì´ìœ ê°€ ì—†ìŒ. Controller â†’ Repositoryë¡œ ì§ì ‘ ê°€ëŠ” ê²Œ ë‚«ë‹¤ |

------

### âœ… ë„ë©”ì¸ ì£¼ë„ ì„¤ê³„(DDD) ê´€ì  ìš”ì•½

| ê³„ì¸µ                     | ì—­í•                                                   |
| ------------------------ | ----------------------------------------------------- |
| Controller               | DTO ë§¤í•‘, ìš”ì²­ ìˆ˜ì‹ , Command ë³€í™˜                     |
| **Service (`@Service`)** | ìœ ìŠ¤ì¼€ì´ìŠ¤ íë¦„ ì •ì˜, ë„ë©”ì¸/ì™¸ë¶€ ì¡°í•©, íŠ¸ëœì­ì…˜ ì¡°ìœ¨ |
| Domain                   | í•µì‹¬ ìƒíƒœ ë³€ê²½ ë° ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ì •ì˜                  |

------

### ğŸ§  ì–¸ì œ `@Service`ë¥¼ ë§Œë“¤ê³  ì–¸ì œ ë§Œë“¤ì§€ ë§ì•„ì•¼ í• ê¹Œ?

| ë§Œë“¤ ë•Œ                    | ì•ˆ ë§Œë“¤ ë•Œ                                    |
| -------------------------- | --------------------------------------------- |
| ìœ ìŠ¤ì¼€ì´ìŠ¤ê°€ ë³µì¡í•¨        | ë‹¨ìˆœ CRUDë§Œ í•„ìš”                              |
| ë„ë©”ì¸ ê°ì²´ ì—¬ëŸ¬ ê°œë¥¼ ì¡°í•© | í•œ ê°œ ì—”í‹°í‹°ì— ëŒ€í•´ ë‹¨ìˆœ ì¡°íšŒë§Œ í•  ë•Œ         |
| ì™¸ë¶€ ì‹œìŠ¤í…œ í˜¸ì¶œ í¬í•¨      | ë‹¨ìˆœ ì¡°íšŒëŠ” `@Repository` ì§ì ‘ í˜¸ì¶œì´ ë” ì í•© |
| íŠ¸ëœì­ì…˜ ë²”ìœ„ê°€ ìˆìŒ       | ë¡œì§ì´ ì—†ê³  ë‹¨ìˆœ ë˜í•‘ë§Œ í•˜ë©´ ì˜ë¯¸ ì—†ìŒ        |

------

### âœ… ìš”ì•½ ì •ë¦¬í‘œ

| í•­ëª©        | ì„¤ëª…                                     |
| ----------- | ---------------------------------------- |
| ì •ì˜        | ë¹„ì¦ˆë‹ˆìŠ¤ ìœ ìŠ¤ì¼€ì´ìŠ¤ë¥¼ ì‹¤í–‰í•˜ëŠ” ê³„ì¸µ      |
| í•µì‹¬ ì±…ì„   | íŠ¸ëœì­ì…˜, ë„ë©”ì¸ í˜¸ì¶œ, ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ë™  |
| ì–´ë…¸í…Œì´ì…˜  | `@Service`, `@Transactional`             |
| ìœ„ì¹˜        | Application Layer or Service Layer       |
| SRP ê¸°ì¤€    | íë¦„ ì¡°ì •ì— ì§‘ì¤‘, ê·œì¹™ì€ ë„ë©”ì¸ìœ¼ë¡œ ìœ„ì„ |
| í…ŒìŠ¤íŠ¸ ë‹¨ìœ„ | ë‹¨ìœ„ í…ŒìŠ¤íŠ¸, mocking í…ŒìŠ¤íŠ¸ ì¤‘ì‹¬ ê³„ì¸µ    |

## íŠ¸ëœì­ì…˜ ë²”ìœ„ ì§€ì •: `@Transactional`

### ğŸ§© 1. `@Transactional`ì´ë€?

Spring Frameworkê°€ ì œê³µí•˜ëŠ” **ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ê´€ë¦¬ ê¸°ëŠ¥**
 â†’ ë©”ì„œë“œ ì‹¤í–‰ì„ **íŠ¸ëœì­ì…˜ ë²”ìœ„ë¡œ ê°ì‹¸ê³ **,
 â†’ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ **ìë™ ë¡¤ë°±**,
 â†’ ì •ìƒ ì¢…ë£Œë˜ë©´ **ì»¤ë°‹**í•˜ëŠ” ê¸°ëŠ¥ì„ ìˆ˜í–‰í•¨.

```
@Transactional
public void process() {
    // íŠ¸ëœì­ì…˜ ì‹œì‘
    ... DB ì‘ì—… ...
    // íŠ¸ëœì­ì…˜ ì»¤ë°‹ or ë¡¤ë°±
}
```

------

### ğŸ¯ 2. ê¸°ë³¸ ë™ì‘ ë°©ì‹

| í•­ëª©                    | ê¸°ë³¸ê°’                             |
| ----------------------- | ---------------------------------- |
| ì „íŒŒ ë°©ì‹ (propagation) | `REQUIRED`                         |
| ê²©ë¦¬ ìˆ˜ì¤€ (isolation)   | ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë³¸ê°’                |
| ë¡¤ë°± ì¡°ê±´ (rollbackFor) | `RuntimeException`, `Error` ê³„ì—´ë§Œ |
| ì½ê¸° ì „ìš© (readOnly)    | `false`                            |

------

### ğŸ“¦ 3. ì„ ì–¸ ìœ„ì¹˜ì™€ ì˜ë¯¸

| ì„ ì–¸ ìœ„ì¹˜   | ì˜ë¯¸                                             |
| ----------- | ------------------------------------------------ |
| í´ë˜ìŠ¤ ì „ì²´ | ëª¨ë“  public ë©”ì„œë“œì— íŠ¸ëœì­ì…˜ ì ìš©               |
| ë©”ì„œë“œ ê°œë³„ | í•´ë‹¹ ë©”ì„œë“œì—ë§Œ íŠ¸ëœì­ì…˜ ì ìš© (ìš°ì„ ìˆœìœ„ ë” ë†’ìŒ) |

```
@Service
@Transactional
public class OrderService {
    public void placeOrder() {} // íŠ¸ëœì­ì…˜ O
}

@Transactional
public void cancelOrder() {} // ê°œë³„ ì„ ì–¸ ì‹œ ìš°ì„ 
```

------

### âš™ï¸ 4. íŠ¸ëœì­ì…˜ ì „íŒŒ ì†ì„± (`propagation`)

| ì†ì„±                | ì˜ë¯¸                                                |
| ------------------- | --------------------------------------------------- |
| `REQUIRED` (ê¸°ë³¸ê°’) | ì´ë¯¸ íŠ¸ëœì­ì…˜ì´ ìˆìœ¼ë©´ ì°¸ì—¬, ì—†ìœ¼ë©´ ìƒˆë¡œ ì‹œì‘       |
| `REQUIRES_NEW`      | ê¸°ì¡´ íŠ¸ëœì­ì…˜ **ì¼ì‹œ ì¤‘ë‹¨**, **ìƒˆ íŠ¸ëœì­ì…˜ ìƒì„±**   |
| `MANDATORY`         | ë°˜ë“œì‹œ ê¸°ì¡´ íŠ¸ëœì­ì…˜ì´ ìˆì–´ì•¼ í•¨, ì—†ìœ¼ë©´ ì˜ˆì™¸       |
| `NESTED`            | ë‚´ë¶€ì— ë³„ë„ ì €ì¥ì (Savepoint) ë§Œë“¤ì–´ í•˜ìœ„ ë¡¤ë°± ê°€ëŠ¥ |
| `NEVER`             | íŠ¸ëœì­ì…˜ì´ ì¡´ì¬í•˜ë©´ ì˜ˆì™¸                            |
| `SUPPORTS`          | ìˆìœ¼ë©´ ì°¸ì—¬, ì—†ìœ¼ë©´ ë¹„íŠ¸ëœì­ì…˜ìœ¼ë¡œ ìˆ˜í–‰             |
| `NOT_SUPPORTED`     | ê¸°ì¡´ íŠ¸ëœì­ì…˜ì„ **ì¤‘ì§€**í•˜ê³  ë¹„íŠ¸ëœì­ì…˜ ìˆ˜í–‰        |

------

### ğŸ§ª 5. ë¡¤ë°± ì „ëµ (`rollbackFor`, `noRollbackFor`)

#### âœ” ê¸°ë³¸ ë™ì‘

- `RuntimeException`, `Error` â†’ ë¡¤ë°± O
- `Checked Exception` (`IOException`, `SQLException`) â†’ ë¡¤ë°± âŒ

#### âœ” ì˜ˆì‹œ

```
@Transactional(rollbackFor = Exception.class)
public void saveWithChecked() throws Exception {
    // checked ì˜ˆì™¸ ë°œìƒí•´ë„ ë¡¤ë°±í•˜ë„ë¡ ì§€ì •
}
```

------

### ğŸ§  6. ë‚´ë¶€ ë™ì‘ ì›ë¦¬: í”„ë¡ì‹œ ê¸°ë°˜ AOP

- Springì€ `@Transactional`ì´ ë¶™ì€ ë©”ì„œë“œë¥¼ **í”„ë¡ì‹œë¡œ ê°ì‹¸ì„œ íŠ¸ëœì­ì…˜ ë¡œì§ì„ ì‚½ì…**í•¨
- ì‹¤ì œ ë©”ì„œë“œ í˜¸ì¶œ ì „í›„ë¡œ `PlatformTransactionManager`ê°€ **íŠ¸ëœì­ì…˜ ì‹œì‘/ì»¤ë°‹/ë¡¤ë°±**ì„ ìˆ˜í–‰

> ğŸ“Œ ë‚´ë¶€ í˜¸ì¶œ(self-invocation)ì€ íŠ¸ëœì­ì…˜ ì ìš© âŒ
>  ê°™ì€ í´ë˜ìŠ¤ ì•ˆì—ì„œ `this.methodA()` í˜¸ì¶œ â†’ í”„ë¡ì‹œ ìš°íšŒë˜ë¯€ë¡œ íŠ¸ëœì­ì…˜ ì ìš© ì•ˆ ë¨

------

### ğŸ“Œ 7. ì‹¤ì „ ì£¼ì˜ì‚¬í•­

| ì£¼ì˜ í•­ëª©      | ì„¤ëª…                                                         |
| -------------- | ------------------------------------------------------------ |
| ë‚´ë¶€ í˜¸ì¶œ      | `this.ë©”ì„œë“œ()`ë¡œ ê°™ì€ í´ë˜ìŠ¤ ë©”ì„œë“œ í˜¸ì¶œ ì‹œ íŠ¸ëœì­ì…˜ ì ìš© ì•ˆ ë¨ (â†’ ë¶„ë¦¬ í•„ìš”) |
| private ë©”ì„œë“œ | í”„ë¡ì‹œ ê¸°ë°˜ì´ë¼ `private` ë©”ì„œë“œì— `@Transactional` ë¶™ì—¬ë„ íš¨ê³¼ ì—†ìŒ |
| readOnly       | `@Transactional(readOnly = true)` â†’ select ì „ìš© íŠ¸ëœì­ì…˜, flush ìµœì í™” ê°€ëŠ¥ |
| ì˜ˆì™¸ ëˆ„ë½      | ì˜ˆì™¸ë¥¼ ì¡ê³  `.printStackTrace()`ë§Œ í•˜ë©´ ë¡¤ë°± ì•ˆ ë¨ (â†’ ë°˜ë“œì‹œ throw í•´ì•¼ í•¨) |

------

### ğŸ“š 8. ì˜ˆì‹œ ì •ë¦¬

#### ì¼ë°˜ ì‚¬ìš©

```
@Service
public class UserService {
    
    @Transactional
    public void registerUser() {
        userRepository.save(...);
        emailSender.send(...);
    }
}
```

#### ì½ê¸° ì „ìš©

```
@Transactional(readOnly = true)
public User getUser(Long id) {
    return userRepository.findById(id).orElseThrow();
}
```

#### ìƒˆ íŠ¸ëœì­ì…˜ ë¶„ë¦¬

```
@Transactional(propagation = Propagation.REQUIRES_NEW)
public void logAudit() {
    auditLogRepository.save(...); // ë³¸ íŠ¸ëœì­ì…˜ê³¼ ë¶„ë¦¬
}
```

------

### âœ… íŠ¸ëœì­ì…˜ ë™ì‘ íë¦„ ìš”ì•½

```
1. í”„ë¡ì‹œ ê°ì²´ê°€ ë©”ì„œë“œ í˜¸ì¶œì„ ê°€ë¡œì±”
2. íŠ¸ëœì­ì…˜ ì‹œì‘ (TransactionManager)
3. ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìˆ˜í–‰
4. ì˜ˆì™¸ ë°œìƒ ì—¬ë¶€ í™•ì¸
   - ì˜ˆì™¸ ì—†ìŒ â†’ Commit
   - ì˜ˆì™¸ ìˆìŒ â†’ Rollback
```

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½í‘œ

| í•­ëª©             | ì„¤ëª…                                         |
| ---------------- | -------------------------------------------- |
| í•µì‹¬ ê¸°ëŠ¥        | íŠ¸ëœì­ì…˜ ì‹œì‘/ì»¤ë°‹/ë¡¤ë°± ìë™í™”               |
| ê¸°ë³¸ ì „íŒŒ        | REQUIRED (íŠ¸ëœì­ì…˜ ìˆìœ¼ë©´ ì°¸ì—¬, ì—†ìœ¼ë©´ ìƒì„±) |
| ë¡¤ë°± ëŒ€ìƒ        | RuntimeException, Error                      |
| ë¹„ì ìš© ì¡°ê±´      | ë‚´ë¶€ í˜¸ì¶œ, private ë©”ì„œë“œ                    |
| íŠ¸ëœì­ì…˜ ë¶„ë¦¬    | REQUIRES_NEW ì‚¬ìš©                            |
| ì½ê¸° ì „ìš© ìµœì í™” | `readOnly = true`                            |

## ë‹¤ìˆ˜ì˜ Repository ë° ì™¸ë¶€ API í†µí•© ì²˜ë¦¬

### ğŸ§© 1. ìƒí™© ì˜ˆì‹œ

> ë‹¤ìŒê³¼ ê°™ì€ ë³µí•© ìœ ìŠ¤ì¼€ì´ìŠ¤ë¥¼ ìƒê°í•´ë³´ì:

```
"íšŒì›ì´ ì£¼ë¬¸ì„ ìƒì„±í•˜ë©´,
- ë¡œì»¬ DBì— ì£¼ë¬¸ì„ ì €ì¥í•˜ê³ 
- ê²°ì œ ì„œë¹„ìŠ¤(API)ë¡œ ê²°ì œ ìš”ì²­ì„ ë³´ë‚´ë©°,
- í¬ì¸íŠ¸ ì„œë¹„ìŠ¤ë¥¼ í†µí•´ íšŒì› í¬ì¸íŠ¸ë¥¼ ì°¨ê°í•œë‹¤."
```

â¡ï¸ ì´ë•Œ í•„ìš”í•œ êµ¬ì„±:

- `OrderRepository`, `UserRepository`, `PointRepository` (JPA)
- ì™¸ë¶€ API í´ë¼ì´ì–¸íŠ¸: `PaymentApiClient`, `PointApiClient` (RestTemplate/WebClient/Feign)
- **ë‹¨ì¼ íŠ¸ëœì­ì…˜ì²˜ëŸ¼ ë¬¶ì—¬ì•¼ í•˜ê³ **, ì‹¤íŒ¨ ì‹œ ë¡¤ë°± or ë³´ìƒ í•„ìš”

------

### ğŸ“¦ 2. í•µì‹¬ êµ¬ì„± ê³„ì¸µ êµ¬ì¡°

```
Controller
  â†“
ApplicationService (ë¹„ì¦ˆë‹ˆìŠ¤ ìœ ìŠ¤ì¼€ì´ìŠ¤)
  â”œâ”€ Repository (JPA ê¸°ë°˜)
  â”œâ”€ External API Client
  â†“
Domain (Entity, Domain Service)
```

------

### ğŸ¯ 3. Application Service ì—­í• 

> ì™¸ë¶€ ì‹œìŠ¤í…œ + ë‚´ë¶€ Repositoryë¥¼ ì¡°í•©í•´ **íŠ¸ëœì­ì…˜ íë¦„ì„ ì œì–´**í•˜ê³ 
>  **ì˜¤ë¥˜ ë°œìƒ ì‹œ ì „ì²´ ì‹¤íŒ¨ or ë³´ìƒ íŠ¸ëœì­ì…˜ ì²˜ë¦¬**ë¥¼ ìˆ˜í–‰

```
@Transactional
public void placeOrder(PlaceOrderCommand command) {
    User user = userRepository.findById(command.getUserId())
        .orElseThrow(() -> new NotFoundException("ì‚¬ìš©ì ì—†ìŒ"));

    Order order = Order.create(user, command);
    orderRepository.save(order); // 1. ë¡œì»¬ ì €ì¥

    paymentClient.requestPayment(order);     // 2. ì™¸ë¶€ ê²°ì œ
    pointClient.deduct(user.getId(), 1000);  // 3. ì™¸ë¶€ í¬ì¸íŠ¸ ì°¨ê°

    // ì„±ê³µ ì‹œ ì´ë²¤íŠ¸ ë°œí–‰ ë“±
}
```

------

### ğŸ”„ 4. íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ì „ëµ

| ëŒ€ìƒ               | íŠ¸ëœì­ì…˜ ì²˜ë¦¬                                              |
| ------------------ | ---------------------------------------------------------- |
| **JPA** Repository | `@Transactional`ë¡œ ê´€ë¦¬                                    |
| **ì™¸ë¶€ API í˜¸ì¶œ**  | DB íŠ¸ëœì­ì…˜ ì´í›„ í˜¸ì¶œ ê¶Œì¥ (`commit` ì§ì „ flush í›„)        |
| **ì‹¤íŒ¨ ë³´ìƒ**      | API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ **ë¡œì»¬ DB rollback + ë³´ìƒ API í˜¸ì¶œ** í•„ìš” |

> Springì€ JPA íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ì™¸ë¶€ HTTP í˜¸ì¶œ ì‹œ **ì˜ˆì™¸ ë°œìƒí•˜ë©´ ìë™ rollback**

------

### ğŸ“˜ 5. ì™¸ë¶€ API í˜¸ì¶œ ì˜ˆì‹œ (WebClient ê¸°ë°˜)

```
public class PaymentApiClient {
    private final WebClient webClient;

    public void requestPayment(Order order) {
        PaymentRequest payload = PaymentRequest.of(order);
        PaymentResponse response = webClient.post()
            .uri("/api/pay")
            .bodyValue(payload)
            .retrieve()
            .onStatus(HttpStatus::isError, res -> Mono.error(new PaymentFailException()))
            .bodyToMono(PaymentResponse.class)
            .block();  // ë¸”ë¡œí‚¹ í˜¸ì¶œ
    }
}
```

------

### âŒ 6. ì‹¤íŒ¨ ì¼€ì´ìŠ¤ ì²˜ë¦¬

| ì‹¤íŒ¨ êµ¬ê°„                     | ì²˜ë¦¬ ë°©ì‹                                              |
| ----------------------------- | ------------------------------------------------------ |
| `orderRepository.save()` ì‹¤íŒ¨ | `@Transactional` rollback                              |
| `paymentClient` ì‹¤íŒ¨          | ì˜ˆì™¸ throw â†’ rollbackë¨                                |
| `pointClient` ì‹¤íŒ¨            | ì˜ˆì™¸ throw + rollback â†’ ë³´ìƒ í•„ìš” (ex: ì·¨ì†Œ ê²°ì œ ìš”ì²­) |
| ì™¸ë¶€ API ì¼ë¶€ë§Œ ì„±ê³µí•œ ê²½ìš°   | ë³„ë„ `CompensationService`ë¥¼ í†µí•´ ë³µêµ¬ í”Œë¡œìš° êµ¬ì„±     |

------

### ğŸ§  7. ì‹¤ë¬´ ì„¤ê³„ ê¸°ì¤€

| í•­ëª©               | ê¸°ì¤€                                                         |
| ------------------ | ------------------------------------------------------------ |
| ë¹„ì¦ˆë‹ˆìŠ¤ ë‹¨ìœ„ ë¬¶ìŒ | ë°˜ë“œì‹œ Application Serviceë¡œ í†µí•©                            |
| ë¡œì»¬ íŠ¸ëœì­ì…˜      | `@Transactional`ë¡œ ë¬¶ê³ , ì™¸ë¶€ APIëŠ” í›„ë°˜ë¶€ì— í˜¸ì¶œ            |
| ì‹¤íŒ¨ ì˜ˆì™¸ ê´€ë¦¬     | ì»¤ìŠ¤í…€ ì˜ˆì™¸ ì •ì˜ + `@ControllerAdvice`ë¡œ ëŒ€ì‘                |
| í†µí•© ì‘ë‹µ ê°ì²´     | DTOë¡œ í†µí•©í•˜ì—¬ ë°˜í™˜ (`OrderResultResponse`)                  |
| ì„±ëŠ¥               | ì™¸ë¶€ APIëŠ” `WebClient` + ë¹„ë™ê¸° ê°€ëŠ¥ (ë‹¨, íŠ¸ëœì­ì…˜ ë¶„ë¦¬ ì£¼ì˜) |

------

### ğŸ“¦ 8. ì‘ë‹µ DTO ì„¤ê³„ ì˜ˆì‹œ

```
public class OrderResultResponse {
    private final Long orderId;
    private final String paymentStatus;
    private final int remainingPoints;

    public static OrderResultResponse of(Order order, PaymentResult payment, PointBalance point) {
        return new OrderResultResponse(order.getId(), payment.getStatus(), point.getBalance());
    }
}
```

------

### âœ… 9. ì˜ˆì™¸ í•¸ë“¤ë§ (`@ControllerAdvice`)

```
@ExceptionHandler(PaymentFailException.class)
public ResponseEntity<ApiResponse<Void>> handlePaymentError(PaymentFailException ex) {
    return ResponseEntity.status(502).body(ApiResponse.error("PAYMENT_FAIL", "ê²°ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));
}
```

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½í‘œ

| í•­ëª©               | ì„¤ê³„ ê¸°ì¤€                                                    |
| ------------------ | ------------------------------------------------------------ |
| íŠ¸ëœì­ì…˜ ë‹¨ìœ„      | ApplicationService ë‹¨ìœ„ë¡œ ë¬¶ê³ , ì™¸ë¶€ APIëŠ” ë§ˆì§€ë§‰ì— í˜¸ì¶œ     |
| DBì™€ API í†µí•©      | JPAëŠ” `@Transactional`, APIëŠ” ì˜ˆì™¸ ë°œìƒ ì‹œ ì „ì²´ ë¡¤ë°±         |
| ì™¸ë¶€ API ì‹¤íŒ¨ ì²˜ë¦¬ | ì˜ˆì™¸ + ë¡œê·¸ + (í•„ìš” ì‹œ) ë³´ìƒ íŠ¸ëœì­ì…˜ êµ¬ì„±                   |
| ì‘ë‹µ ê°ì²´          | DTOë¡œ í†µí•© ì„¤ê³„, í´ë¼ì´ì–¸íŠ¸ í•´ì„ ê°€ëŠ¥í•˜ê²Œ                    |
| ì˜ˆì™¸ êµ¬ì¡°          | `CustomException`, `ErrorCode`, `@ControllerAdvice` ì¡°í•©ìœ¼ë¡œ ê´€ë¦¬ |

## ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œì˜ ìœ íš¨ì„± ê²€ì‚¬, ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ì ìš©

### ğŸ§© 1. ìœ íš¨ì„± ê²€ì‚¬ì˜ ê³„ì¸µ êµ¬ë¶„

| ê³„ì¸µ                           | ìœ íš¨ì„± ê²€ì‚¬ ëª©ì                                              |
| ------------------------------ | ------------------------------------------------------------ |
| Controller                     | **ì…ë ¥ê°’ êµ¬ì¡°**, í˜•ì‹, í•„ìˆ˜ê°’ ê²€ì‚¬ (`@Valid`, `@NotNull` ë“±) |
| Service                        | **ë„ë©”ì¸ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™**, ìƒíƒœ ê²€ì¦, ì¡´ì¬ì„± ê²€ì‚¬ ë“±          |
| Domain (Entity, DomainService) | **ë¶ˆë³€ì„±**, **ìƒíƒœ ì „ì´**, **ìê¸°ì™„ê²° ê·œì¹™**                 |

------

### ğŸš« 2. ì™œ ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œë„ ìœ íš¨ì„± ê²€ì‚¬ê°€ í•„ìš”í•œê°€?

> ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œëŠ” **ë‹¨ìˆœ ê°’ ìœ íš¨ì„±**ë§Œ ì²´í¬í•¨ (null, length, pattern)

í•˜ì§€ë§Œ ë‹¤ìŒê³¼ ê°™ì€ ê²€ì‚¬ëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œë§Œ ê°€ëŠ¥í•¨:

- ì‚¬ìš©ì ì¡´ì¬ ì—¬ë¶€ í™•ì¸
- ì£¼ë¬¸ ìƒíƒœê°€ `PENDING`ì¸ì§€ í™•ì¸
- í¬ì¸íŠ¸ê°€ ì¶©ë¶„í•œì§€ ê²€ì‚¬
- ì¤‘ë³µ ì£¼ë¬¸ ì—¬ë¶€
- íŠ¹ì • ì •ì±…(ì˜ˆì•½ 7ì¼ ì „ê¹Œì§€ë§Œ ê°€ëŠ¥ ë“±)

âœ… ì´ê±´ ì „ë¶€ **ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™**, ì¦‰ **ì„œë¹„ìŠ¤ ê³„ì¸µì˜ ì±…ì„**

------

### ğŸ“˜ 3. ì˜ˆì‹œ: ì£¼ë¬¸ ìƒì„± ìœ ìŠ¤ì¼€ì´ìŠ¤

#### ìš”ì²­ DTO

```
public class OrderRequest {
    @NotNull
    private Long userId;

    @NotNull
    private Long productId;

    @Min(1)
    private int quantity;
}
```

#### ì»¨íŠ¸ë¡¤ëŸ¬

```
@PostMapping("/orders")
public ResponseEntity<?> placeOrder(@Valid @RequestBody OrderRequest req) {
    orderService.placeOrder(req);
    return ResponseEntity.status(HttpStatus.CREATED).build();
}
```

------

### âœ… 4. ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œì˜ ìœ íš¨ì„± ê²€ì‚¬

```
@Transactional
public void placeOrder(OrderRequest req) {
    User user = userRepository.findById(req.getUserId())
        .orElseThrow(() -> new NotFoundException("ì‚¬ìš©ì ì—†ìŒ"));

    Product product = productRepository.findById(req.getProductId())
        .orElseThrow(() -> new NotFoundException("ìƒí’ˆ ì—†ìŒ"));

    if (product.getStock() < req.getQuantity()) {
        throw new InvalidRequestException("ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
    }

    if (!user.canOrder()) {
        throw new BusinessRuleException("ì •ì§€ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤.");
    }

    Order order = Order.create(user, product, req.getQuantity());
    orderRepository.save(order);
}
```

------

### ğŸ’£ 5. ì˜ëª»ëœ ì„¤ê³„ ì˜ˆì‹œ

```
// controllerì—ì„œ ëª¨ë“  ìœ íš¨ì„± ê²€ì‚¬ ì²˜ë¦¬
if (!productService.hasStock(productId, quantity)) {
    return ResponseEntity.badRequest().body("ì¬ê³  ë¶€ì¡±");
}
```

âŒ ë¬¸ì œì :

- ìœ íš¨ì„± ê²€ì‚¬ê°€ ì—¬ëŸ¬ ì»¨íŠ¸ë¡¤ëŸ¬ì— ì¤‘ë³µë¨
- ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸ ì‹œ ê·œì¹™ì´ ë¹ ì§ˆ ìˆ˜ ìˆìŒ
- ìƒíƒœ ì „ì´ ê²€ì‚¬ ëˆ„ë½ ìœ„í—˜

------

### ğŸ¯ 6. ìœ íš¨ì„± ê²€ì‚¬ & ì˜ˆì™¸ êµ¬ì¡° íŒ¨í„´

#### âœ… ì»¤ìŠ¤í…€ ì˜ˆì™¸ í´ë˜ìŠ¤

```
public class BusinessRuleException extends RuntimeException {
    private final String code = "BUSINESS_RULE_VIOLATION";
}
```

#### âœ… ì „ì—­ ì²˜ë¦¬

```
@ExceptionHandler(BusinessRuleException.class)
public ResponseEntity<ApiResponse<Void>> handleRule(BusinessRuleException ex) {
    return ResponseEntity.badRequest().body(ApiResponse.error(ex.getCode(), ex.getMessage()));
}
```

------

### ğŸ§  7. ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ì˜ ìœ„ì¹˜ êµ¬ë¶„

| êµ¬ë¶„                     | ì²˜ë¦¬ ìœ„ì¹˜                  | ì˜ˆ                                 |
| ------------------------ | -------------------------- | ---------------------------------- |
| ë‹¨ìˆœ ê°’ ê²€ì¦             | Controller (`@Valid`)      | email í˜•ì‹, ë¹„ì–´ìˆìŒ ë“±            |
| DB ì¡´ì¬ì„±, ìƒíƒœ ì¡°ê±´     | Service Layer              | ì¡´ì¬ ì—¬ë¶€, ì¤‘ë³µ ê²€ì‚¬, ìƒíƒœ ì¡°ê±´ ë“± |
| ì—”í‹°í‹° ë¶ˆë³€ì„±, ìƒíƒœ ì „ì´ | Entity ë˜ëŠ” Domain Service | Order ìƒíƒœ ë³€ê²½, ì •ì±…ì  ì œì•½ ë“±    |

------

### ğŸ§ª 8. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì„¤ê³„

ì„œë¹„ìŠ¤ ê³„ì¸µì˜ ìœ íš¨ì„± ê²€ì‚¬ëŠ” ë°˜ë“œì‹œ í…ŒìŠ¤íŠ¸ë˜ì–´ì•¼ í•¨:

```
@Test
void ì£¼ë¬¸ìš”ì²­_ì¬ê³ ë¶€ì¡±_ì˜ˆì™¸ë°œìƒ() {
    given(product.getStock()).willReturn(0);

    assertThrows(InvalidRequestException.class, () -> {
        orderService.placeOrder(req);
    });
}
```

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½í‘œ

| í•­ëª©     | ì„¤ëª…                                          |
| -------- | --------------------------------------------- |
| ì»¨íŠ¸ë¡¤ëŸ¬ | ë‹¨ìˆœ êµ¬ì¡°/ê°’ ìœ íš¨ì„± (`@Valid`)                |
| ì„œë¹„ìŠ¤   | ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™, ìƒíƒœ ì¡°ê±´, ê´€ê³„ ìœ íš¨ì„± ê²€ì‚¬    |
| ë„ë©”ì¸   | ìƒíƒœ ì „ì´, ë¶ˆë³€ì„±, í•µì‹¬ ì •ì±…                  |
| ì˜ˆì™¸     | ì»¤ìŠ¤í…€ ì˜ˆì™¸ + ì „ì—­ ì²˜ë¦¬ (`@ControllerAdvice`) |
| í…ŒìŠ¤íŠ¸   | ì„œë¹„ìŠ¤ ê³„ì¸µ ê·œì¹™ì€ í…ŒìŠ¤íŠ¸ í•„ìˆ˜ (í–‰ìœ„ ì¤‘ì‹¬)    |

## ì˜ˆ: `UserService`, `OrderService`, `PaymentService`

### ğŸ”¹ 1. `UserService`

#### âœ… ì—­í• 

| ê¸°ëŠ¥           | ì„¤ëª…                     |
| -------------- | ------------------------ |
| íšŒì› ì¡°íšŒ      | ë‹¨ê±´/ì „ì²´ ì¡°íšŒ           |
| íšŒì› ë“±ë¡      | ì¤‘ë³µ ê²€ì‚¬ í¬í•¨           |
| íšŒì› ìƒíƒœ ê´€ë¦¬ | íœ´ë©´/íƒˆí‡´ ì²˜ë¦¬ ë“±        |
| í¬ì¸íŠ¸ ê´€ë¦¬    | ì ë¦½, ì°¨ê°, ì”ì•¡ ì¡°íšŒ ë“± |

#### âœ… ì£¼ìš” ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜

```
UserDto getUser(Long id);
void registerUser(UserCreateCommand command);
void deactivateUser(Long id);
void addPoint(Long userId, int amount);
void subtractPoint(Long userId, int amount);
```

#### âœ… ë‚´ë¶€ ìœ íš¨ì„± ë° ê·œì¹™

- ì´ë©”ì¼ ì¤‘ë³µ ê²€ì‚¬
- ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ì ì²˜ë¦¬
- ì •ì§€/íƒˆí‡´ ì‚¬ìš©ìëŠ” ì£¼ë¬¸ ë¶ˆê°€

```
if (user.isDeactivated()) {
    throw new BusinessRuleException("íƒˆí‡´í•œ íšŒì›ì€ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
}
```

------

### ğŸ”¹ 2. `OrderService`

#### âœ… ì—­í• 

| ê¸°ëŠ¥           | ì„¤ëª…                            |
| -------------- | ------------------------------- |
| ì£¼ë¬¸ ìƒì„±      | ìƒí’ˆ ì¡´ì¬ ì—¬ë¶€ + ì¬ê³  ê²€ì¦ í¬í•¨ |
| ì£¼ë¬¸ ì·¨ì†Œ      | ìƒíƒœ ì¡°ê±´(ë°°ì†¡ ì „) ê²€ì¦         |
| ì£¼ë¬¸ ëª©ë¡ ì¡°íšŒ | ì‚¬ìš©ìë³„ ë˜ëŠ” ì „ì²´ ì¡°íšŒ         |
| ê²°ì œ ì—°ê³„      | ë‚´ë¶€ ì €ì¥ â†’ ì™¸ë¶€ ê²°ì œ ìš”ì²­      |

#### âœ… ì£¼ìš” ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜

```
OrderDto placeOrder(OrderRequest command);         // ì£¼ë¬¸ ìƒì„±
void cancelOrder(Long orderId);                    // ì£¼ë¬¸ ì·¨ì†Œ
List<OrderDto> getOrdersByUser(Long userId);       // ì‚¬ìš©ìë³„ ì£¼ë¬¸ ëª©ë¡
```

#### âœ… ë‚´ë¶€ ê²€ì¦

- ìƒí’ˆ ì¬ê³  í™•ì¸ (`product.getStock() < qty`)
- ì‚¬ìš©ì ì¡´ì¬, ìƒíƒœ í™•ì¸
- ì£¼ë¬¸ ìƒíƒœê°€ `READY`ì¸ ê²½ìš°ì—ë§Œ ì·¨ì†Œ í—ˆìš©

```
if (!order.isCancelable()) {
    throw new BusinessRuleException("ë°°ì†¡ ì¤€ë¹„ ìƒíƒœì—ì„œëŠ” ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
}
```

------

### ğŸ”¹ 3. `PaymentService`

#### âœ… ì—­í• 

| ê¸°ëŠ¥           | ì„¤ëª…                       |
| -------------- | -------------------------- |
| ê²°ì œ ìš”ì²­      | ì™¸ë¶€ PGì‚¬ API ì—°ê³„         |
| ê²°ì œ ì·¨ì†Œ      | ìƒíƒœ/ì‹œê°„ ì¡°ê±´ ê²€ì¦        |
| ê²°ì œ ìƒíƒœ ì¡°íšŒ | ì™¸ë¶€ ì‘ë‹µ â†’ ë‚´ë¶€ ìƒíƒœ ë°˜ì˜ |
| ê²°ì œ ê²°ê³¼ ì €ì¥ | ê²°ì œ ë‚´ì—­ ë¡œê¹…             |

#### âœ… ì£¼ìš” ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜

```
PaymentResult pay(PaymentCommand command);
void cancelPayment(Long paymentId);
PaymentStatus getStatus(Long orderId);
```

#### âœ… ì™¸ë¶€ API ì—°ê³„ (Feign, WebClient)

```
public PaymentResult pay(PaymentCommand command) {
    try {
        PaymentApiResponse response = paymentApiClient.requestPayment(command);
        return PaymentResult.from(response);
    } catch (HttpClientErrorException e) {
        throw new PaymentFailException("ê²°ì œ ì‹¤íŒ¨: " + e.getMessage());
    }
}
```

------

### ğŸ” íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ì •ë¦¬

| ì„œë¹„ìŠ¤           | íŠ¸ëœì­ì…˜ ì—¬ë¶€                                                | ì˜ˆì™¸ ì‹œ ì²˜ë¦¬               |
| ---------------- | ------------------------------------------------------------ | -------------------------- |
| `UserService`    | ë“±ë¡, ìƒíƒœ ë³€ê²½ ì‹œ `@Transactional`                          | ë¡¤ë°±                       |
| `OrderService`   | ì£¼ë¬¸ ìƒì„±, ì·¨ì†ŒëŠ” ë°˜ë“œì‹œ `@Transactional`                    | ì‹¤íŒ¨ ì‹œ ì „ì²´ ë¡¤ë°±          |
| `PaymentService` | DB ì €ì¥ì€ `@Transactional`, ì™¸ë¶€ APIëŠ” íŠ¸ëœì­ì…˜ ì´í›„ í˜¸ì¶œ ê¶Œì¥ | ì˜ˆì™¸ ì‹œ ë³´ìƒ íŠ¸ëœì­ì…˜ í•„ìš” |

------

### âš ï¸ ì˜ˆì™¸ ì„¤ê³„ ì˜ˆì‹œ

```
public class UserNotFoundException extends RuntimeException { ... }
public class OutOfStockException extends RuntimeException { ... }
public class PaymentFailException extends RuntimeException { ... }
```

------

### âœ… ë§ˆë¬´ë¦¬ êµ¬ì¡° ìš”ì•½

| ì„œë¹„ìŠ¤         | ì£¼ìš” ê¸°ëŠ¥          | íŠ¸ëœì­ì…˜ ì—¬ë¶€ | ì™¸ë¶€ ì—°ê³„                          | ìœ íš¨ì„± ê²€ì‚¬                    |
| -------------- | ------------------ | ------------- | ---------------------------------- | ------------------------------ |
| UserService    | ë“±ë¡, íƒˆí‡´, í¬ì¸íŠ¸ | âœ…             | âŒ                                  | ì‚¬ìš©ì ìƒíƒœ, ì¤‘ë³µ              |
| OrderService   | ì£¼ë¬¸ ìƒì„±, ì·¨ì†Œ    | âœ…             | â˜‘ (ê°„ì ‘ì ìœ¼ë¡œ PaymentService ì—°ë™) | ìƒí’ˆ, ì¬ê³ , ì‚¬ìš©ì             |
| PaymentService | ê²°ì œ, ì·¨ì†Œ, ìƒíƒœ   | ë¶€ë¶„ âœ…        | âœ… PG API                           | ê²°ì œ ìš”ì²­ ê°€ëŠ¥ ì—¬ë¶€, ìƒíƒœ í™•ì¸ |