# 16. ë©”ì‹œì§•ê³¼ í†µí•©

## Kafka ì—°ë™

- ## Producer, Consumer

  ### ğŸ§© 1. Producerë€?

  > **ë©”ì‹œì§€ë¥¼ ìƒì„±í•´ì„œ ë¸Œë¡œì»¤(ì¤‘ê°„ì)ì—ê²Œ ì „ë‹¬í•˜ëŠ” ì—­í• **
  >  ì˜ˆ: ì£¼ë¬¸ ì™„ë£Œ ì‹œ ë©”ì‹œì§€ ë°œí–‰ â†’ â€œOrderCreatedâ€

  âœ… **ë¹„ë™ê¸° ì²˜ë¦¬ ì‹œì‘ì **
   âœ… Kafka, RabbitMQ, Redis ë“± ë©”ì‹œì§€ ë¸Œë¡œì»¤ì— `send/publish`

  ------

  ### ğŸ‘‚ 2. Consumerë€?

  > **ë¸Œë¡œì»¤ë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ì—¬ ì²˜ë¦¬í•˜ëŠ” ì—­í• **
  >  ì˜ˆ: ê²°ì œ ì‹œìŠ¤í…œì´ ì£¼ë¬¸ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ê³  ì²˜ë¦¬ ì‹œì‘

  âœ… **ë¹„ë™ê¸° ì²˜ë¦¬ ì¢…ì°©ì **
   âœ… ë©”ì‹œì§€ë¥¼ ë°›ì•„ì„œ DB ì €ì¥, API í˜¸ì¶œ ë“± ë‹¤ì–‘í•œ ì‘ì—… ìˆ˜í–‰

  ------

  ### ğŸ”„ 3. ì „ì²´ ë©”ì‹œì§€ íë¦„

  ```
  [Producer]
    â†“ publish
  [Broker]  (Kafka, RabbitMQ ë“±)
    â†“ subscribe
  [Consumer]
  ```

  ì˜ˆì‹œ:

  - ì£¼ë¬¸ ì„œë¹„ìŠ¤ â†’ "OrderCreated" ì´ë²¤íŠ¸ ë°œí–‰ (Producer)
  - ê²°ì œ ì„œë¹„ìŠ¤ê°€ í•´ë‹¹ ì´ë²¤íŠ¸ ìˆ˜ì‹  í›„ ê²°ì œ ì²˜ë¦¬ (Consumer)

  ------

  ### âš™ï¸ 4. Spring Boot ê¸°ë°˜ êµ¬ì„± ì˜ˆì‹œ

  > ì—¬ê¸°ì„  **Kafka** ê¸°ì¤€ìœ¼ë¡œ ì˜ˆì‹œ ì„¤ëª…í• ê²Œ
  >  RabbitMQë„ ê±°ì˜ ë™ì¼í•œ êµ¬ì¡°

  ------

  #### âœ… ì˜ì¡´ì„± ì¶”ê°€ (Gradle)

  ```
  implementation("org.springframework.kafka:spring-kafka")
  ```

  ------

  #### âœ… application.yml ì„¤ì •

  ```
  spring:
    kafka:
      bootstrap-servers: localhost:9092
      consumer:
        group-id: my-service
        auto-offset-reset: earliest
        key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
        value-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      producer:
        key-serializer: org.apache.kafka.common.serialization.StringSerializer
        value-serializer: org.apache.kafka.common.serialization.StringSerializer
  ```

  ------

  ### ğŸ“¤ 5. Producer êµ¬í˜„ ì˜ˆì‹œ

  ```
  @Service
  @RequiredArgsConstructor
  public class OrderProducer {
  
      private final KafkaTemplate<String, String> kafkaTemplate;
  
      public void publishOrderCreated(Long orderId) {
          String message = String.format("{\"orderId\": %d}", orderId);
          kafkaTemplate.send("order-created-topic", message);
      }
  }
  ```

  ------

  ### ğŸ“¥ 6. Consumer êµ¬í˜„ ì˜ˆì‹œ

  ```
  @Component
  public class OrderConsumer {
  
      @KafkaListener(topics = "order-created-topic", groupId = "payment-service")
      public void consume(String message) {
          System.out.println("âœ… ì£¼ë¬¸ ìƒì„± ì´ë²¤íŠ¸ ìˆ˜ì‹ : " + message);
          // íŒŒì‹± â†’ ì²˜ë¦¬ ë¡œì§ ìˆ˜í–‰
      }
  }
  ```

  ------

  ### ğŸ“˜ 7. ì‹¤ë¬´ ì ìš© ì‹œ ê³ ë ¤ì‚¬í•­

  | í•­ëª©            | Producer ì¸¡                 | Consumer ì¸¡                      |
  | --------------- | --------------------------- | -------------------------------- |
  | ë©”ì‹œì§€ ì¤‘ë³µ     | **idempotentí•˜ê²Œ ì²˜ë¦¬**     | âœ… í•„ìˆ˜                           |
  | ë©”ì‹œì§€ í¬ë§·     | JSON, Avro, Protobuf        | ìŠ¤í‚¤ë§ˆ í†µì¼                      |
  | ì‹¤íŒ¨ ì²˜ë¦¬       | Retry, Dead Letter Topic    | ì˜ˆì™¸/ë¡œê·¸ ì²˜ë¦¬                   |
  | ìˆœì„œ ë³´ì¥       | Partition ê´€ë¦¬              | Kafka: ê°™ì€ key â†’ ê°™ì€ partition |
  | ë¹„ë™ê¸° íŠ¸ëœì­ì…˜ | DB + ë©”ì‹œì§€ ì „ì†¡ ìˆœì„œ ë³´ì¥? | Outbox íŒ¨í„´ í•„ìš”                 |

  ------

  ### ğŸ§  8. Producer-Consumer íŒ¨í„´ì˜ ì¥ì 

  | ì¥ì         | ì„¤ëª…                           |
  | ----------- | ------------------------------ |
  | ë¹„ë™ê¸° ì²˜ë¦¬ | ì‘ë‹µ ì‹œê°„ ë‹¨ì¶•, ë³‘ë ¬ ì²˜ë¦¬ ê°€ëŠ¥ |
  | ì„œë¹„ìŠ¤ ë¶„ë¦¬ | ê°•í•œ ì˜ì¡´ ì œê±° (ëŠìŠ¨í•œ ì—°ê²°)   |
  | í™•ì¥ì„±      | Consumerë¥¼ ì—¬ëŸ¬ ê°œ í™•ì¥ ê°€ëŠ¥   |
  | ì¥ì•  ê²©ë¦¬   | í•œìª½ ë‹¤ìš´ë¼ë„ ë©”ì‹œì§€ëŠ” ë³´ì¡´ë¨  |

  ------

  ### âš ï¸ 9. ì‹¤ë¬´ ì„¤ê³„ íŒ

  | ì„¤ê³„ í•­ëª©     | ê¶Œì¥ ë°©ì‹                                  |
  | ------------- | ------------------------------------------ |
  | ë©”ì‹œì§€ ìŠ¤í‚¤ë§ˆ | DTO â†’ JSON ë³€í™˜ + ëª…í™•í•œ í•„ë“œ ì •ì˜         |
  | ë¡œê·¸          | ë°œí–‰ ì„±ê³µ/ì‹¤íŒ¨ ë¡œê¹… í•„ìˆ˜                   |
  | ì¬ì²˜ë¦¬        | ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë˜ëŠ” DLQ êµ¬ì„±               |
  | íŠ¸ëœì­ì…˜      | Kafka â†’ DB ë™ì‹œì— ë‹¤ë£° ë• Outbox íŒ¨í„´ ê³ ë ¤ |
  | í…ŒìŠ¤íŠ¸        | Embedded Kafka ë˜ëŠ” WireMock ì¡°í•© ì¶”ì²œ     |

  ------

  ### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½í‘œ

  | í•­ëª©          | ì„¤ëª…                                   |
  | ------------- | -------------------------------------- |
  | Producer      | ë©”ì‹œì§€ ë°œí–‰ì (`kafkaTemplate.send()`) |
  | Consumer      | ë©”ì‹œì§€ ìˆ˜ì‹ ì (`@KafkaListener`)       |
  | ë¸Œë¡œì»¤        | Kafka, RabbitMQ ë“± ë©”ì‹œì§€ ì¤‘ê³„         |
  | í¬ë§·          | JSON/AVRO ê¶Œì¥ (ëª…í™•í•œ ìŠ¤í‚¤ë§ˆ)         |
  | ì‹¤í–‰ íë¦„     | ë°œí–‰ â†’ í ì €ì¥ â†’ ìˆ˜ì‹ /ì²˜ë¦¬             |
  | íŠ¸ëœì­ì…˜ ì²˜ë¦¬ | ë©”ì‹œì§€/DB ë¶„ë¦¬ ì‹œ Outbox íŒ¨í„´ ê²€í†      |

- ## `@KafkaListener`

  ### ğŸ§© 1. ê°œë…

  > Spring Kafkaì—ì„œ Kafka ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ê³  ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜.

  - ë‚´ë¶€ì ìœ¼ë¡œ KafkaConsumerë¥¼ ë“±ë¡í•˜ì—¬ ë©”ì‹œì§€ë¥¼ **ìë™ ìˆ˜ì‹ **
  - `@KafkaListener`ê°€ ì„ ì–¸ëœ ë©”ì„œë“œëŠ” **ë¸Œë¡œì»¤ë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬**í•¨

  ------

  ### ğŸ“˜ 2. ê¸°ë³¸ ì‚¬ìš©ë²•

  ```
  @KafkaListener(topics = "order-created", groupId = "order-consumer")
  public void handleOrder(String message) {
      System.out.println("âœ… ì£¼ë¬¸ ë©”ì‹œì§€ ìˆ˜ì‹ : " + message);
  }
  ```

  | íŒŒë¼ë¯¸í„°  | ì˜ë¯¸                                                 |
  | --------- | ---------------------------------------------------- |
  | `topics`  | ìˆ˜ì‹ í•  Kafka í† í”½ ì´ë¦„                               |
  | `groupId` | Consumer Group ì´ë¦„ (ê°™ì€ ê·¸ë£¹ì€ íŒŒí‹°ì…˜ì„ ë‚˜ëˆ  ê°€ì§) |

  ------

  ### ğŸ” 3. Kafka ë©”ì‹œì§€ êµ¬ì¡° ë°”ì¸ë”©

  #### âœ… ë¬¸ìì—´ ë©”ì‹œì§€

  ```
  @KafkaListener(topics = "simple-topic")
  public void handle(String message) { ... }
  ```

  ------

  #### âœ… JSON ë©”ì‹œì§€ë¥¼ ê°ì²´ë¡œ ë§¤í•‘

  ```
  @KafkaListener(topics = "user-topic", containerFactory = "userKafkaListenerContainerFactory")
  public void handleUser(UserDto dto) {
      System.out.println("ğŸ‘¤ ì‚¬ìš©ì ì´ë²¤íŠ¸ ìˆ˜ì‹ : " + dto.getName());
  }
  ```

  ```
  @Bean
  public ConcurrentKafkaListenerContainerFactory<String, UserDto> userKafkaListenerContainerFactory() {
      var factory = new ConcurrentKafkaListenerContainerFactory<String, UserDto>();
      factory.setConsumerFactory(new DefaultKafkaConsumerFactory<>(consumerProps(), new StringDeserializer(), new JsonDeserializer<>(UserDto.class)));
      return factory;
  }
  ```

  ------

  ### ğŸ”‚ 4. Consumer Group ë™ì‘ êµ¬ì¡°

  | ê·¸ë£¹ | íŒŒí‹°ì…˜ ìˆ˜ | ì¸ìŠ¤í„´ìŠ¤ ìˆ˜ | ì²˜ë¦¬ ë°©ì‹                                                    |
  | ---- | --------- | ----------- | ------------------------------------------------------------ |
  | A    | 3         | 3           | ê° ì¸ìŠ¤í„´ìŠ¤ê°€ í•˜ë‚˜ì˜ íŒŒí‹°ì…˜ì„ ì²˜ë¦¬                           |
  | A    | 3         | 1           | í•˜ë‚˜ì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ëª¨ë“  íŒŒí‹°ì…˜ ì²˜ë¦¬                           |
  | A    | 3         | 4           | í•˜ë‚˜ëŠ” ëŒ€ê¸° ìƒíƒœ (íŒŒí‹°ì…˜ ìˆ˜ë³´ë‹¤ ì¸ìŠ¤í„´ìŠ¤ê°€ ë§ìœ¼ë©´ ì¼ë¶€ëŠ” idle) |

  âœ… ë™ì¼ Group IDë¥¼ ê°€ì§„ ì¸ìŠ¤í„´ìŠ¤ëŠ” **íŒŒí‹°ì…˜ ë‹¨ìœ„ë¡œ ë¶„ì‚° ì²˜ë¦¬**ë¨

  ------

  ### âš™ï¸ 5. ë³‘ë ¬ ì²˜ë¦¬ (Concurrency)

  ```
  @Bean
  public ConcurrentKafkaListenerContainerFactory<?, ?> kafkaListenerContainerFactory() {
      var factory = new ConcurrentKafkaListenerContainerFactory<>();
      factory.setConcurrency(3);  // ìµœëŒ€ 3ê°œ ìŠ¤ë ˆë“œë¡œ ë³‘ë ¬ ì²˜ë¦¬
      return factory;
  }
  ```

  > ë³‘ë ¬ì„±ì€ **íŒŒí‹°ì…˜ ìˆ˜ ì´í•˜ë¡œë§Œ ìœ íš¨**
  >  KafkaëŠ” ê° íŒŒí‹°ì…˜ì„ í•˜ë‚˜ì˜ Consumerê°€ ë…ì 

  ------

  ### ğŸ§¨ 6. ì˜ˆì™¸ ì²˜ë¦¬ ì „ëµ

  #### âœ… try-catch ì‚¬ìš©

  ```
  @KafkaListener(topics = "payment")
  public void handle(String message) {
      try {
          // ì²˜ë¦¬ ë¡œì§
      } catch (Exception e) {
          log.error("â— ë©”ì‹œì§€ ì²˜ë¦¬ ì‹¤íŒ¨: {}", message, e);
          // ì¬ì²˜ë¦¬ íì— ì ì¬ or DLQ ì „ì†¡
      }
  }
  ```

  ------

  #### âœ… ê¸€ë¡œë²Œ ì—ëŸ¬ í•¸ë“¤ëŸ¬ ì„¤ì •

  ```
  @Bean
  public ConcurrentKafkaListenerContainerFactory<String, String> kafkaListenerContainerFactory() {
      var factory = new ConcurrentKafkaListenerContainerFactory<String, String>();
      factory.setErrorHandler((thrownException, data) -> {
          log.error("â— ì˜ˆì™¸ ë°œìƒ: {}", data, thrownException);
      });
      return factory;
  }
  ```

  ------

  #### âœ… ì¬ì‹œë„ (Retry + Backoff)

  ```
  factory.setRetryTemplate(retryTemplate());
  
  private RetryTemplate retryTemplate() {
      var retry = new RetryTemplate();
      retry.setRetryPolicy(new SimpleRetryPolicy(3));  // ìµœëŒ€ 3ë²ˆ ì¬ì‹œë„
      retry.setBackOffPolicy(new FixedBackOffPolicy() {{
          setBackOffPeriod(2000); // 2ì´ˆ ê°„ê²©
      }});
      return retry;
  }
  ```

  ------

  ### ğŸ” 7. ë³´ì•ˆ / ì—­ì§ë ¬í™” ì‹¤íŒ¨ ëŒ€ë¹„

  - ë©”ì‹œì§€ í˜•ì‹ì´ ì˜ˆìƒê³¼ ë‹¤ë¥´ë©´ `DeserializationException` ë°œìƒ â†’ ë°˜ë“œì‹œ ì˜ˆì™¸ ì²˜ë¦¬
  - JsonDeserializer ì‚¬ìš© ì‹œ: `trusted.packages=*` ì„¤ì • í•„ìš” (ë˜ëŠ” ëª…ì‹œ ì§€ì •)

  ```
  spring:
    kafka:
      consumer:
        properties:
          spring.json.trusted.packages: "*"
  ```

  ------

  ### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½í‘œ

  | í•­ëª©                         | ì„¤ëª…                                                     |
  | ---------------------------- | -------------------------------------------------------- |
  | `@KafkaListener(topics = â€¦)` | ë©”ì‹œì§€ ìˆ˜ì‹  ë©”ì„œë“œ ë“±ë¡                                  |
  | `groupId`                    | ì»¨ìŠˆë¨¸ ê·¸ë£¹ ì„¤ì • (íŒŒí‹°ì…˜ ë¶„ë°° ê¸°ì¤€)                      |
  | `containerFactory`           | ë©”ì‹œì§€ ì—­ì§ë ¬í™” ë°©ì‹ ì§€ì •                                |
  | ë³‘ë ¬ ì²˜ë¦¬                    | `concurrency` ìˆ˜ë¡œ ì»¨ìŠˆë¨¸ ë™ì‹œì„± ì¡°ì ˆ                    |
  | ì˜ˆì™¸ ì²˜ë¦¬                    | try-catch, ê¸€ë¡œë²Œ ì—ëŸ¬í•¸ë“¤ëŸ¬, ì¬ì‹œë„ ì„¤ì • ê°€ëŠ¥           |
  | DTO ìˆ˜ì‹                      | `JsonDeserializer`ë¡œ ê°ì²´ ë§¤í•‘ ê°€ëŠ¥                      |
  | íŠ¸ëœì­ì…˜ ì—°ê³„                | `@KafkaListener`ëŠ” DB íŠ¸ëœì­ì…˜ê³¼ ë¶„ë¦¬ë¨ â†’ ìˆ˜ë™ ì œì–´ ê°€ëŠ¥ |

## RabbitMQ ì—°ë™

- ## `@RabbitListener`

  ### ğŸ§© 1. `@RabbitListener`ë€?

  > Spring AMQPì—ì„œ **RabbitMQ íì— ë°”ì¸ë”©ëœ ë©”ì‹œì§€ë¥¼ ë¹„ë™ê¸°ë¡œ ìˆ˜ì‹ **í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜

  âœ… `@KafkaListener`ì™€ ìœ ì‚¬í•˜ì§€ë§Œ, AMQP ê¸°ë°˜ìœ¼ë¡œ ë™ì‘
   âœ… Spring Boot + RabbitMQì—ì„œ ë©”ì‹œì§€ ê¸°ë°˜ ì†Œë¹„ ì²˜ë¦¬í•  ë•Œ ì‚¬ìš©

  ------

  ### âš™ï¸ 2. ê¸°ë³¸ ì‚¬ìš© ì˜ˆì‹œ

  ```
  @RabbitListener(queues = "order.queue")
  public void handleOrder(String message) {
      System.out.println("âœ… ë©”ì‹œì§€ ìˆ˜ì‹ : " + message);
  }
  ```

  | íŒŒë¼ë¯¸í„°   | ì„¤ëª…                                         |
  | ---------- | -------------------------------------------- |
  | `queues`   | ìˆ˜ì‹ í•  í ì´ë¦„                               |
  | `bindings` | (ì„ íƒ) Exchange/Queue/Binding ì„¤ì • ë™ì‹œ ì •ì˜ |

  ------

  ### ğŸ“˜ 3. í•„ìˆ˜ ì˜ì¡´ì„±

  #### âœ… Gradle

  ```
  implementation("org.springframework.boot:spring-boot-starter-amqp")
  ```

  ------

  ### ğŸ“‚ 4. application.yml ì„¤ì •

  ```
  spring:
    rabbitmq:
      host: localhost
      port: 5672
      username: guest
      password: guest
      listener:
        simple:
          retry:
            enabled: true
            max-attempts: 3
            initial-interval: 1000
  ```

  ------

  ### ğŸ“¦ 5. ë©”ì‹œì§€ ê°ì²´ ë°”ì¸ë”© (JSON â†’ DTO)

  #### âœ… ë©”ì‹œì§€ DTO

  ```
  public class OrderMessage {
      private Long orderId;
      private String userEmail;
      // getters/setters
  }
  ```

  #### âœ… ë¦¬ìŠ¤ë„ˆ

  ```
  @RabbitListener(queues = "order.queue")
  public void receiveOrder(OrderMessage message) {
      System.out.println("ğŸ“¦ ì£¼ë¬¸ ìˆ˜ì‹ : " + message.getOrderId());
  }
  ```

  â¡ï¸ Jackson ë©”ì‹œì§€ ë³€í™˜ ìë™ ì ìš©ë¨ (`MappingJackson2MessageConverter`)

  ------

  ### ğŸ”„ 6. í/ìµìŠ¤ì²´ì¸ì§€/ë°”ì¸ë”© ë™ì‹œ ì„ ì–¸

  ```
  @RabbitListener(
      bindings = @QueueBinding(
          value = @Queue(value = "order.queue", durable = "true"),
          exchange = @Exchange(value = "order.exchange", type = "topic"),
          key = "order.*"
      )
  )
  public void consume(String message) {
      System.out.println("ğŸ“¥ ìˆ˜ì‹ : " + message);
  }
  ```

  âœ… ì½”ë“œ ë‚´ì—ì„œ RabbitMQ êµ¬ì„± ìë™ ë“±ë¡ ê°€ëŠ¥

  ------

  ### ğŸ” 7. ë™ì‹œì„± ì²˜ë¦¬ (Concurrency)

  ```
  spring:
    rabbitmq:
      listener:
        simple:
          concurrency: 3
          max-concurrency: 10
  ```

  > ì»¨ìŠˆë¨¸ ë™ì‹œ ì²˜ë¦¬ ìŠ¤ë ˆë“œ ìˆ˜ ì„¤ì • (íŒŒí‹°ì…˜ ê°œë… ì—†ìŒ)

  ------

  ### ğŸ§¨ 8. ì˜ˆì™¸ ì²˜ë¦¬

  #### âœ… ê¸°ë³¸: ì˜ˆì™¸ ë°œìƒ ì‹œ ì¬ì‹œë„ or DLQ

  - `listener.simple.retry.enabled=true` ì„¤ì • ì‹œ ìë™ ì¬ì‹œë„
  - ì¬ì‹œë„ ì´ˆê³¼ ì‹œ ë©”ì‹œì§€ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë²„ë ¤ì§ or DLQ êµ¬ì„± í•„ìš”

  ------

  #### âœ… try-catchë¡œ ìˆ˜ë™ ì²˜ë¦¬

  ```
  @RabbitListener(queues = "alert.queue")
  public void consumeWithError(String msg) {
      try {
          // ë¹„ì¦ˆë‹ˆìŠ¤ ì²˜ë¦¬
      } catch (Exception e) {
          log.error("â— ì²˜ë¦¬ ì‹¤íŒ¨: {}", msg, e);
          // ì‹¤íŒ¨ ì‹œ ì¬ì²˜ë¦¬ ë¡œì§ or ì‹¤íŒ¨ ë¡œê·¸ ì €ì¥
      }
  }
  ```

  ------

  #### âœ… Dead Letter Queue ì„¤ì • ì˜ˆì‹œ

  ```
  spring:
    rabbitmq:
      listener:
        simple:
          default-requeue-rejected: false
  ```

  ê·¸ë¦¬ê³  Queue ì„ ì–¸ ì‹œ:

  ```
  @Bean
  public Queue orderQueue() {
      return QueueBuilder.durable("order.queue")
          .withArgument("x-dead-letter-exchange", "dlx.exchange")
          .withArgument("x-dead-letter-routing-key", "dlx.routing")
          .build();
  }
  ```

  ------

  ### ğŸ§  9. ì‹¤ë¬´ ì„¤ê³„ íŒ

  | í•­ëª©         | ê¶Œì¥ ì „ëµ                                                 |
  | ------------ | --------------------------------------------------------- |
  | ë©”ì‹œì§€ í¬ë§·  | JSON + DTO ëª…í™•í•œ êµ¬ì¡°ë¡œ í†µì¼                             |
  | í ì„¤ê³„      | ë„ë©”ì¸ ê¸°ë°˜ í ì´ë¦„ ì„¤ê³„ (`order.queue`, `payment.queue`) |
  | ë°”ì¸ë”© ì„¤ì •  | ì½”ë“œë¡œ í•¨ê»˜ ì •ì˜ or YAMLë¡œ ì„ ì–¸                           |
  | ì˜ˆì™¸ ì²˜ë¦¬    | ì¬ì‹œë„ â†’ DLQ or ë³´ìƒ ë¡œì§ êµ¬ì„±                            |
  | ë‹¤ì¤‘ í ìˆ˜ì‹  | `@RabbitListener(queues = {"a", "b"})` ê°€ëŠ¥               |
  | ìˆœì„œ ë³´ì¥    | RabbitMQëŠ” í ë‹¨ìœ„ ìˆœì„œë¥¼ ë³´ì¥í•˜ë¯€ë¡œ íŒŒí‹°ì…˜ í•„ìš” ì—†ìŒ     |

  ------

  ### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½

  | í•­ëª©              | ì„¤ëª…                                                  |
  | ----------------- | ----------------------------------------------------- |
  | `@RabbitListener` | ë©”ì‹œì§€ë¥¼ íì—ì„œ ë¹„ë™ê¸° ìˆ˜ì‹                            |
  | í ì§€ì •           | `queues = "..."` ë˜ëŠ” `bindings`ë¡œ Exchange í¬í•¨ ì„ ì–¸ |
  | ë©”ì‹œì§€ íƒ€ì…       | DTO ìë™ ë§¤í•‘ (Jackson)                               |
  | ë™ì‹œì„±            | `concurrency`, `max-concurrency` ì„¤ì •                 |
  | ì˜ˆì™¸ ì²˜ë¦¬         | ìë™ ì¬ì‹œë„ + DLQ êµ¬ì„± ê°€ëŠ¥                           |
  | ì‹¤ë¬´ í™œìš©         | ì£¼ë¬¸, ì•Œë¦¼, ì´ë²¤íŠ¸ ì²˜ë¦¬ ë“± ë©”ì‹œì§€ ê¸°ë°˜ ì²˜ë¦¬           |

## ë©”ì‹œì§€ ì»¨ë²„í„°

### ğŸ§© 1. ë©”ì‹œì§€ ì»¨ë²„í„°ë€?

> **ë©”ì‹œì§€ ë°”ì´íŠ¸/í…ìŠ¤íŠ¸ë¥¼ ê°ì²´(ìë°” POJO)ë¡œ ì§ë ¬í™”Â·ì—­ì§ë ¬í™”**í•˜ëŠ” êµ¬ì„± ìš”ì†Œ

| ë°©í–¥              | ë™ì‘                                   |
| ----------------- | -------------------------------------- |
| Producer â†’ Broker | ê°ì²´ â†’ ë°”ì´íŠ¸/ë¬¸ìì—´ (ì§ë ¬í™”)          |
| Broker â†’ Consumer | ë°”ì´íŠ¸/ë¬¸ìì—´ â†’ ê°ì²´ (ì—­ì§ë ¬í™”) âœ… í•µì‹¬ |

Springì—ì„œëŠ” ë©”ì‹œì§€ ì»¨ë²„í„°ë¥¼ í†µí•´
 âœ… JSON â†’ DTO ìë™ ë§¤í•‘,
 âœ… DTO â†’ JSON ìë™ ì§ë ¬í™”ê°€ ê°€ëŠ¥í•¨

------

### ğŸ“¦ 2. ì£¼ìš” ë©”ì‹œì§€ ì»¨ë²„í„° ì¢…ë¥˜

| ì»¨ë²„í„° í´ë˜ìŠ¤                           | ì„¤ëª…                                      |
| --------------------------------------- | ----------------------------------------- |
| `StringMessageConverter`                | ë¬¸ìì—´ â†” ë¬¸ìì—´ (ê¸°ë³¸)                    |
| `MappingJackson2MessageConverter`       | JSON â†” DTO ìë™ ë§¤í•‘ (AMQP, WebSocket ë“±) |
| `JsonMessageConverter` (`spring-kafka`) | Kafka ì „ìš© Jackson ê¸°ë°˜ JSON ì»¨ë²„í„°       |
| `ByteArrayMessageConverter`             | ë°”ì´íŠ¸ ë°°ì—´ â†” ê°ì²´                        |
| ì»¤ìŠ¤í…€ ì»¨ë²„í„°                           | ì‚¬ìš©ì ì •ì˜ ì§ë ¬í™”/ì—­ì§ë ¬í™” ë°©ì‹ êµ¬í˜„     |

------

### ğŸ“˜ 3. Spring Kafkaì—ì„œ ë©”ì‹œì§€ ì»¨ë²„í„° ë“±ë¡

#### âœ… JSON â†’ DTO ë§¤í•‘ ì˜ˆì‹œ

```
@Bean
public ConcurrentKafkaListenerContainerFactory<String, MyEvent> kafkaListenerContainerFactory(
        ConsumerFactory<String, MyEvent> consumerFactory) {

    ConcurrentKafkaListenerContainerFactory<String, MyEvent> factory = new ConcurrentKafkaListenerContainerFactory<>();
    factory.setConsumerFactory(consumerFactory);
    factory.setMessageConverter(new StringJsonMessageConverter());  // í•µì‹¬!
    return factory;
}
```

â¡ï¸ `@KafkaListener`ëŠ” JSON ë¬¸ìì—´ì„ DTOë¡œ ìë™ ë³€í™˜

```
@KafkaListener(topics = "my-topic", containerFactory = "kafkaListenerContainerFactory")
public void handle(MyEvent event) {
    System.out.println("ğŸ“¨ ìˆ˜ì‹ : " + event.getName());
}
```

------

### ğŸ° 4. Spring AMQP(RabbitMQ)ì—ì„œ ë©”ì‹œì§€ ì»¨ë²„í„° ì„¤ì •

```
@Bean
public MessageConverter jsonMessageConverter() {
    return new Jackson2JsonMessageConverter();
}

@Bean
public RabbitTemplate rabbitTemplate(ConnectionFactory cf) {
    RabbitTemplate template = new RabbitTemplate(cf);
    template.setMessageConverter(jsonMessageConverter());
    return template;
}

@Bean
public SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory(ConnectionFactory cf) {
    SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory();
    factory.setConnectionFactory(cf);
    factory.setMessageConverter(jsonMessageConverter());  // ìˆ˜ì‹  ì‹œ ì»¨ë²„í„°
    return factory;
}
```

â¡ï¸ RabbitMQì—ì„œë„ `@RabbitListener`ì—ì„œ DTO ìˆ˜ì‹  ê°€ëŠ¥

```
@RabbitListener(queues = "order.queue")
public void handle(OrderEvent event) {
    System.out.println("ğŸ“¦ ì£¼ë¬¸ ìˆ˜ì‹ : " + event.getOrderId());
}
```

------

### ğŸ”§ 5. ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ì»¨ë²„í„° ì˜ˆì‹œ

```
public class CustomUpperCaseConverter implements MessageConverter {

    @Override
    public Message toMessage(Object object, MessageProperties props) throws MessageConversionException {
        String payload = ((String) object).toUpperCase();
        return new Message(payload.getBytes(), props);
    }

    @Override
    public Object fromMessage(Message message) throws MessageConversionException {
        return new String(message.getBody()).toLowerCase();
    }
}
```

â¡ï¸ ë¬¸ì ë³€í™˜, ì•”í˜¸í™”, ì••ì¶• ë“±ë„ ê°€ëŠ¥

------

### ğŸ§¨ 6. ì˜ˆì™¸ ì²˜ë¦¬

- JSON íŒŒì‹± ì‹¤íŒ¨ â†’ `DeserializationException`, `MessageConversionException` ë°œìƒ
- Springì—ì„œëŠ” `ErrorHandler`ë‚˜ try-catchì—ì„œ ì²˜ë¦¬

```
@KafkaListener(topics = "user")
public void handleSafe(String json) {
    try {
        UserDto dto = objectMapper.readValue(json, UserDto.class);
    } catch (JsonProcessingException e) {
        log.error("â— ë©”ì‹œì§€ ì—­ì§ë ¬í™” ì‹¤íŒ¨", e);
    }
}
```

------

### ğŸ§  7. ì‹¤ë¬´ ì„¤ê³„ íŒ

| í•­ëª©        | ê¶Œì¥ ì „ëµ                                           |
| ----------- | --------------------------------------------------- |
| í¬ë§·        | JSON í†µì¼ + Jackson ì»¨ë²„í„° ì‚¬ìš©                     |
| ë©”ì‹œì§€ êµ¬ì¡° | DTO ì„¤ê³„ ì‹œ ëª…í™•í•œ í•„ë“œì™€ íƒ€ì… ì‚¬ìš©                 |
| ì—ëŸ¬ ì²˜ë¦¬   | íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¡œê·¸ ì €ì¥ + DLQ ì „ì†¡ ê³ ë ¤              |
| í†µí•©        | Kafka, RabbitMQ, WebSocket ë“± ë™ì¼ ì»¨ë²„í„° ë°©ì‹ ìœ ì§€ |
| í…ŒìŠ¤íŠ¸      | Consumer ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹œ ì»¨ë²„í„°ê¹Œì§€ í¬í•¨í•˜ì—¬ ê²€ì¦    |

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½

| í•­ëª©          | ì„¤ëª…                                              |
| ------------- | ------------------------------------------------- |
| ë©”ì‹œì§€ ì»¨ë²„í„° | ë©”ì‹œì§€ë¥¼ DTOë¡œ ìë™ ë³€í™˜í•´ì£¼ëŠ” ì»´í¬ë„ŒíŠ¸           |
| Kafka ì „ìš©    | `StringJsonMessageConverter`                      |
| AMQP ì „ìš©     | `Jackson2JsonMessageConverter`                    |
| ë“±ë¡ ìœ„ì¹˜     | ListenerFactory ë˜ëŠ” Templateì— ëª…ì‹œ              |
| ì‹¤ë¬´ í™œìš©     | JSON â†’ DTO, DTO â†’ JSON ìë™ ì²˜ë¦¬                  |
| ì˜ˆì™¸ ì²˜ë¦¬     | JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ `DeserializationException` ë°œìƒ |

## ë©”ì‹œì§€ ì¬ì²˜ë¦¬ì™€ ë¦¬íŠ¸ë¼ì´ ì „ëµ

### ğŸ§© 1. ì™œ ë©”ì‹œì§€ ì¬ì²˜ë¦¬ê°€ ì¤‘ìš”í•œê°€?

> ë©”ì‹œì§€ ì†Œë¹„ ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ **ê·¸ ë©”ì‹œì§€ë¥¼ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜**,
>  **ì‹¤íŒ¨ ë©”ì‹œì§€ë¥¼ ë³„ë„ íë¡œ ë¶„ë¦¬(DLQ)**í•´ì•¼ ì‹œìŠ¤í…œì´ **ì•ˆì •ì ì´ê³  ê²¬ê³ **í•´ì§

#### âœ… ì˜ˆ:

- DB ì¼ì‹œì  ì¥ì•  â†’ ë©”ì‹œì§€ ì¬ì²˜ë¦¬ í•„ìš”
- ì™¸ë¶€ API íƒ€ì„ì•„ì›ƒ â†’ ì¬ì‹œë„ í›„ ì„±ê³µ ê°€ëŠ¥ì„± ìˆìŒ
- ë¹„ì •ìƒ ë©”ì‹œì§€ â†’ DLQë¡œ ë³´ë‚´ê³  ë¡œê·¸/ëª¨ë‹ˆí„°ë§

------

### âš™ï¸ 2. Kafka vs RabbitMQ ê¸°ë³¸ ë™ì‘ ì°¨ì´

| í•­ëª©        | Kafka                                    | RabbitMQ           |
| ----------- | ---------------------------------------- | ------------------ |
| ë©”ì‹œì§€ ì €ì¥ | ë””ìŠ¤í¬ì— ì˜êµ¬ ì €ì¥                       | ë©”ëª¨ë¦¬/ë””ìŠ¤í¬      |
| ë©”ì‹œì§€ ì‚­ì œ | Consumerê°€ commit ì‹œ                     | Consumerê°€ ack ì‹œ  |
| ì‹¤íŒ¨ ì²˜ë¦¬   | ê¸°ë³¸ ì¬ì‹œë„ ì—†ìŒ                         | ê¸°ë³¸ ìë™ ì¬ì „ì†¡   |
| DLQ         | ë³„ë„ êµ¬ì„± í•„ìš”                           | ê³µì‹ DLX ì„¤ì • ì¡´ì¬ |
| ì¬ì‹œë„ ì œì–´ | ìˆ˜ë™ êµ¬í˜„ (`SeekToCurrent`, retry topic) | ìë™ or ìˆ˜ë™ ê°€ëŠ¥  |

------

### ğŸ“˜ 3. Spring Kafka: ì¬ì‹œë„ + ì—ëŸ¬ í•¸ë“¤ë§

#### âœ… ë°©ì‹ 1: ìˆ˜ë™ `try-catch`

```
@KafkaListener(topics = "order")
public void handle(String msg) {
    try {
        // ì²˜ë¦¬
    } catch (Exception e) {
        log.error("â— ì²˜ë¦¬ ì‹¤íŒ¨: {}", msg);
        // ì¬ì‹œë„ íë¡œ ì´ë™ or ë¬´ì‹œ
    }
}
```

------

#### âœ… ë°©ì‹ 2: ì»¨í…Œì´ë„ˆ ë ˆë²¨ ë¦¬íŠ¸ë¼ì´ ì„¤ì •

```
@Bean
public ConcurrentKafkaListenerContainerFactory<String, String> kafkaListenerContainerFactory() {
    var factory = new ConcurrentKafkaListenerContainerFactory<>();
    factory.setRetryTemplate(retryTemplate());
    factory.setRecoveryCallback(context -> {
        String msg = (String) context.getAttribute("record");
        log.error("âŒ ìµœì¢… ì‹¤íŒ¨ ë©”ì‹œì§€ ì²˜ë¦¬: {}", msg);
        return null;
    });
    return factory;
}
```

```
private RetryTemplate retryTemplate() {
    RetryTemplate retry = new RetryTemplate();

    retry.setRetryPolicy(new SimpleRetryPolicy(3)); // ìµœëŒ€ 3íšŒ
    retry.setBackOffPolicy(new FixedBackOffPolicy() {{
        setBackOffPeriod(2000); // 2ì´ˆ ê°„ê²©
    }});

    return retry;
}
```

------

#### âœ… Kafka ê³ ê¸‰ ì „ëµ: Retry Topic + DLQ

- Spring Kafka v2.7+ ë¶€í„° `@RetryableTopic`, `@DltHandler` ì§€ì›

```
@RetryableTopic(
  attempts = "3",
  backoff = @Backoff(delay = 2000),
  dltTopicSuffix = "-dlt"
)
@KafkaListener(topics = "payment")
public void handle(String msg) {
    ...
}

@DltHandler
public void handleDlt(String dltMessage) {
    log.error("ğŸ’€ DLQ ë„ë‹¬ ë©”ì‹œì§€: {}", dltMessage);
}
```

â¡ï¸ ìë™ìœ¼ë¡œ `payment-retry`, `payment-dlt` í† í”½ì´ ìƒì„±ë˜ê³  ì¬ì‹œë„/ì‹¤íŒ¨ ë©”ì‹œì§€ ë¶„ë¦¬ë¨

------

### ğŸ° 4. Spring RabbitMQ ì¬ì‹œë„ ì „ëµ

#### âœ… ê¸°ë³¸ ìë™ ì¬ì „ì†¡ (ack ì•ˆ í•˜ë©´ ì¬ì „ë‹¬)

```
@RabbitListener(queues = "order.queue")
public void handle(String msg) {
    throw new RuntimeException("ì‹¤íŒ¨!"); // ack ì•ˆë¨ â†’ ìë™ ì¬ì‹œë„
}
```

#### âœ… ë¦¬íŠ¸ë¼ì´ êµ¬ì„± (`application.yml`)

```
spring:
  rabbitmq:
    listener:
      simple:
        retry:
          enabled: true
          max-attempts: 3
          initial-interval: 1000
          multiplier: 2.0
```

â¡ï¸ ê¸°ë³¸ì ìœ¼ë¡œ ì¬ì‹œë„ í›„ ì‹¤íŒ¨ ì‹œ message discard

------

#### âœ… DLQ ì„¤ì •

```
@Bean
public Queue orderQueue() {
    return QueueBuilder.durable("order.queue")
        .withArgument("x-dead-letter-exchange", "dlx.exchange")
        .withArgument("x-dead-letter-routing-key", "dlx.routing")
        .build();
}
```

------

### ğŸ§  5. ì‹¤ë¬´ ì¬ì‹œë„ ì„¤ê³„ ì „ëµ

| í•­ëª©          | ì„¤ê³„ ê¸°ì¤€                                  |
| ------------- | ------------------------------------------ |
| ë‹¨ìˆœ ì˜ˆì™¸     | ì¬ì‹œë„ (ex: DB connection timeout)         |
| ë¹„ì •ìƒ ë©”ì‹œì§€ | DLQë¡œ ë¶„ë¦¬ í›„ ìˆ˜ë™ í™•ì¸                    |
| ë¦¬íŠ¸ë¼ì´ ê°„ê²© | Fixed or Exponential Backoff               |
| ìµœëŒ€ íšŸìˆ˜     | 3~5íšŒ, ì´í›„ DLQë¡œ ì´ë™                     |
| DLQ ëª¨ë‹ˆí„°ë§  | Slack, email, dashboard ì—°ë™               |
| ì²˜ë¦¬ ë³´ì¥     | Idempotent ì²˜ë¦¬ í•„ìˆ˜ (ì¬ì „ì†¡ ì‹œ ì¤‘ë³µ ë°©ì§€) |

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½í‘œ

| í•­ëª©               | Kafka                                | RabbitMQ                                              |
| ------------------ | ------------------------------------ | ----------------------------------------------------- |
| ê¸°ë³¸ ì¬ì‹œë„        | âŒ (ìˆ˜ë™)                             | âœ…                                                     |
| ë¦¬ìŠ¤ë„ˆ ì¬ì‹œë„ ì„¤ì • | RetryTemplate or `@RetryableTopic`   | `spring.rabbitmq.listener.simple.retry.*`             |
| DLQ êµ¬ì„±           | ìˆ˜ë™ í† í”½ êµ¬ì„± or `@DltHandler`      | `x-dead-letter-exchange`, `x-dead-letter-routing-key` |
| Backoff            | Fixed/Exponential                    | YAMLì—ì„œ ì„¤ì •                                         |
| ë©”ì‹œì§€ ë³´ì¡´        | ë””ìŠ¤í¬ ê¸°ë°˜ (ì¬ì‹œë„ ì£¼ì²´ëŠ” consumer) | í ë‚´ ë³´ì¡´ í›„ ì¬ì „ì†¡                                  |

## Dead Letter Queue (DLQ)

### ğŸ§© 1. DLQë€?

> ë©”ì‹œì§€ê°€ ì†Œë¹„ ì¤‘ **ì§€ì†ì ìœ¼ë¡œ ì‹¤íŒ¨í•˜ê±°ë‚˜ ê±°ë¶€ë˜ì—ˆì„ ë•Œ**,
>  í•´ë‹¹ ë©”ì‹œì§€ë¥¼ **ë³„ë„ì˜ í(í† í”½)ë¡œ ì´ë™**ì‹œì¼œ ê²©ë¦¬/ë³´ì¡´í•˜ëŠ” êµ¬ì¡°

âœ… **ì¬ì²˜ë¦¬ ì‹¤íŒ¨ ë©”ì‹œì§€ë¥¼ ë¶„ë¦¬í•˜ê³ **,
 âœ… ì •ìƒ íë¦„ì„ ìœ ì§€í•˜ë©°
 âœ… **ì¥ì•  ë¶„ì„, ë³´ìƒ ì²˜ë¦¬, ì¶”ì **ì´ ê°€ëŠ¥í•˜ê²Œ í•¨

------

### ğŸ”„ 2. ë™ì‘ íë¦„ ìš”ì•½

```
Producer â†’ Main Queue/Topic
            â†“ (ì‹¤íŒ¨ NíšŒ, ì˜ˆì™¸, nack ë“±)
         Dead Letter Queue (DLQ)
```

ì˜ˆ:

- 3ë²ˆ ì¬ì‹œë„ í›„ ì‹¤íŒ¨ â†’ DLQë¡œ ì „ì†¡
- JSON íŒŒì‹± ì‹¤íŒ¨ â†’ DLQ ì „ì†¡ í›„ ì•Œë¦¼

------

### âš™ï¸ 3. Kafka ê¸°ë°˜ DLQ êµ¬ì„±

#### âœ… ë°©ë²• 1: `@RetryableTopic` + `@DltHandler` (Spring Kafka 2.7+)

```
@RetryableTopic(
  attempts = "3",
  backoff = @Backoff(delay = 2000),
  dltTopicSuffix = "-dlt"
)
@KafkaListener(topics = "order")
public void consume(OrderMessage msg) {
    throw new RuntimeException("ì²˜ë¦¬ ì‹¤íŒ¨");
}
```

â¡ï¸ ìë™ìœ¼ë¡œ ë‹¤ìŒ í† í”½ ìƒì„±:

- `order-retry-0`, `order-retry-1` (ì¬ì‹œë„ìš©)
- `order-dlt` (DLQ)

#### âœ… DLQ ì²˜ë¦¬

```
@DltHandler
public void handleDlq(OrderMessage msg) {
    log.error("ğŸ’€ DLQ ë©”ì‹œì§€ ë„ì°©: {}", msg);
    // ì•Œë¦¼ ì „ì†¡, DB ì €ì¥, ìˆ˜ë™ ë³´ìƒ
}
```

------

#### âœ… ë°©ë²• 2: ìˆ˜ë™ DLQ Producer ì „ì†¡

```
@KafkaListener(topics = "order")
public void handle(String msg) {
    try {
        ...
    } catch (Exception ex) {
        kafkaTemplate.send("order-dlq", msg); // DLQ ìˆ˜ë™ ì „ì†¡
    }
}
```

------

### ğŸ° 4. RabbitMQ ê¸°ë°˜ DLQ êµ¬ì„±

#### âœ… Queue ì„¤ì •: `x-dead-letter-exchange`

```
@Bean
public Queue mainQueue() {
    return QueueBuilder.durable("order.queue")
        .withArgument("x-dead-letter-exchange", "dlx.exchange")
        .withArgument("x-dead-letter-routing-key", "order.dlq")
        .build();
}

@Bean
public Queue deadLetterQueue() {
    return QueueBuilder.durable("order.dlq").build();
}

@Bean
public DirectExchange dlxExchange() {
    return new DirectExchange("dlx.exchange");
}

@Bean
public Binding dlqBinding() {
    return BindingBuilder.bind(deadLetterQueue())
        .to(dlxExchange()).with("order.dlq");
}
```

â¡ï¸ ë©”ì‹œì§€ ì†Œë¹„ ì¤‘ ì˜ˆì™¸ ë°œìƒ ì‹œ DLQë¡œ ìë™ ì „ì†¡ë¨

------

### ğŸ“˜ 5. Spring Rabbitì—ì„œ DLQ ìë™ ì „ì†¡ ì¡°ê±´

| ì¡°ê±´       | ì„¤ëª…                                  |
| ---------- | ------------------------------------- |
| ì˜ˆì™¸ ë°œìƒ  | `@RabbitListener`ì—ì„œ Exception throw |
| Ack ì‹¤íŒ¨   | ìˆ˜ë™ ack ì‹¤íŒ¨ ì‹œ                      |
| TTL ë§Œë£Œ   | ë©”ì‹œì§€ ì§€ì—° í›„ ë§Œë£Œë˜ë©´ DLQë¡œ ì´ë™    |
| Queue full | í ì´ˆê³¼ ì‹œ ì •ì±… ì„¤ì •ì— ë”°ë¼ DLQ ì „ì†¡  |

------

### ğŸ” 6. DLQ ì¬ì²˜ë¦¬ ì „ëµ

| ì „ëµ            | ì„¤ëª…                                |
| --------------- | ----------------------------------- |
| ìˆ˜ë™ ì¬ì²˜ë¦¬     | DLQ ë©”ì‹œì§€ë¥¼ ì½ê³ , ì›ë˜ íë¡œ ì¬ì „ì†¡ |
| ëŒ€ì‹œë³´ë“œ + ìŠ¹ì¸ | ê´€ë¦¬ìê°€ ìŠ¹ì¸ ì‹œ ì¬ì „ì†¡ or Drop     |
| ìë™ ì¬ì²˜ë¦¬     | ì¼ì • ì‹œê°„ í›„ pollingí•˜ì—¬ ì¬ì‹œë„     |

```
@Scheduled(fixedDelay = 60000)
public void reconsumeDlq() {
    List<Message> dlqMsgs = dlqRepo.fetch();
    for (Message msg : dlqMsgs) {
        mainProducer.send(msg.getPayload());  // ì›ë˜ íë¡œ ì¬ì „ì†¡
    }
}
```

------

### ğŸ“Š 7. DLQ ëª¨ë‹ˆí„°ë§ êµ¬ì„±

| ë„êµ¬                 | ì„¤ëª…                                 |
| -------------------- | ------------------------------------ |
| Spring Boot Actuator | Kafka, RabbitMQ ìƒíƒœ í™•ì¸ ê°€ëŠ¥       |
| Prometheus + Grafana | DLQ ë©”ì‹œì§€ ìˆ˜, ì—ëŸ¬ ìˆ˜ ëŒ€ì‹œë³´ë“œ      |
| Log Alert            | DLQ ìˆ˜ì‹  ë¡œê·¸ Slack ì—°ë™             |
| Dead Letter Audit    | DB í…Œì´ë¸”ì— DLQ ë©”ì‹œì§€ ì €ì¥ + íŠ¸ë˜í‚¹ |

------

### ğŸ§  8. ì‹¤ë¬´ ì„¤ê³„ íŒ

| í•­ëª©          | ê¶Œì¥ ì „ëµ                                    |
| ------------- | -------------------------------------------- |
| DLQ ì´ë¦„ ê·œì¹™ | `order.dlq`, `user.dlt`, `topic-name-dlq`    |
| ë©”ì‹œì§€ í¬ë§·   | DTO + ì‹¤íŒ¨ ì´ìœ  í¬í•¨ (`reason`, `timestamp`) |
| DLQ ë³´ì¡´ ê¸°ê°„ | TTL ì„¤ì • + ìˆ˜ë™ or ìë™ ì •ë¦¬                 |
| ì•Œë¦¼ ì‹œìŠ¤í…œ   | DLQ ë„ì°© ì‹œ Slack, Email, JIRA ì—°ë™          |
| ë³´ìƒ ì²˜ë¦¬     | ê´€ë¦¬ì ìŠ¹ì¸ + ì¬ì²˜ë¦¬ API or Batch ìŠ¤ì¼€ì¤„ëŸ¬   |

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½

| í•­ëª©      | ì„¤ëª…                                                  |
| --------- | ----------------------------------------------------- |
| DLQ ëª©ì   | ì‹¤íŒ¨ ë©”ì‹œì§€ ê²©ë¦¬, ì •ìƒ íë¦„ ë³´í˜¸, ì‚¬í›„ ë¶„ì„           |
| Kafka     | `@RetryableTopic` + `@DltHandler`, or ìˆ˜ë™ DLQ        |
| RabbitMQ  | `x-dead-letter-exchange`, `x-dead-letter-routing-key` |
| ì¬ì²˜ë¦¬    | ìˆ˜ë™ or ìë™ ì¬ì „ì†¡ êµ¬ì¡° êµ¬ì„±                         |
| ëª¨ë‹ˆí„°ë§  | ëŒ€ì‹œë³´ë“œ, ë¡œê·¸, ì•Œë¦¼ ì—°ê³„ í•„ìˆ˜                        |
| ì‹¤ë¬´ ê¸°ì¤€ | DLQëŠ” â€œì‹¤íŒ¨ë¥¼ ê¸°ë¡í•˜ê³  ë‹¤ì‹œ ì„±ê³µí•  ê¸°íšŒë¥¼ ì£¼ëŠ” êµ¬ì¡°â€  |

## Spring Integration ê¸°ë³¸ êµ¬ì¡°

### ğŸ§© 1. Spring Integrationì´ë€?

> ë‹¤ì–‘í•œ ì‹œìŠ¤í…œ, í”„ë¡œí† ì½œ, ë©”ì‹œì§•ì„ Spring ê¸°ë°˜ìœ¼ë¡œ **ëª¨ë“ˆí™”ëœ ë°©ì‹ìœ¼ë¡œ í†µí•©**í•˜ê¸° ìœ„í•œ í”„ë ˆì„ì›Œí¬.

âœ… EIP(Enterprise Integration Patterns) êµ¬í˜„
 âœ… MQ, HTTP, JMS, TCP/UDP, FTP, Mail, File ë“± ë‹¤ì–‘í•œ **ì…ì¶œë ¥ ì—°ë™** ê°€ëŠ¥
 âœ… ë©”ì‹œì§€ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ **ë¹„ë™ê¸°/ë™ê¸° ì´ë²¤íŠ¸ íë¦„ì„ ì„¤ê³„**

------

### ğŸ¯ 2. ì™œ ì‚¬ìš©í•˜ëŠ”ê°€?

- ì‹œìŠ¤í…œ ê°„ **ë¹„ë™ê¸° ë°ì´í„° íë¦„**ì„ êµ¬ì„±
- Kafka, RabbitMQ, File, REST API, DB ë“± ë‹¤ì–‘í•œ ì±„ë„ì„ í†µí•©
- **ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ / íŒŒì´í”„ë¼ì¸ ì²˜ë¦¬ / ë©”ì‹œì§€ ë¼ìš°íŒ… / ë³€í™˜** ë“± êµ¬í˜„
- ì´ë²¤íŠ¸ ë“œë¦¬ë¸ ì•„í‚¤í…ì²˜ë¥¼ **ì½”ë“œê°€ ì•„ë‹Œ DSL êµ¬ì„±ìœ¼ë¡œ ì„¤ê³„**

------

### ğŸ“¦ 3. Spring Integration í•µì‹¬ ê°œë… êµ¬ì¡°

```
[Inbound Adapter] â†’ [Message Channel] â†’ [Message Handler or Router] â†’ [Outbound Adapter]
```

| êµ¬ì„± ìš”ì†Œ             | ì„¤ëª…                                                         |
| --------------------- | ------------------------------------------------------------ |
| **Message**           | ì‹¤ì œ ë°ì´í„° (`payload`) + ë©”íƒ€ ì •ë³´ (`headers`)              |
| **Channel**           | ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•˜ëŠ” í†µë¡œ (`DirectChannel`, `QueueChannel`, `PublishSubscribeChannel`) |
| **Gateway**           | ì™¸ë¶€ ìš”ì²­ì„ ì‹œìŠ¤í…œ ë©”ì‹œì§€ë¡œ ë³€í™˜                             |
| **Adapter**           | ì™¸ë¶€ ì‹œìŠ¤í…œê³¼ ì—°ë™ (e.g. Kafka, Mail, FTP)                   |
| **Transformer**       | ë©”ì‹œì§€ë¥¼ ë‹¤ë¥¸ í˜•ì‹ìœ¼ë¡œ ë³€í™˜                                  |
| **Router**            | ì¡°ê±´ì— ë”°ë¼ ë©”ì‹œì§€ íë¦„ì„ ë¶„ê¸°                               |
| **Filter**            | ë©”ì‹œì§€ë¥¼ í•„í„°ë§ (drop or pass)                               |
| **Service Activator** | ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬ê¸°                                    |
| **Bridge**            | ì±„ë„ ê°„ ë©”ì‹œì§€ë¥¼ ì—°ê²°                                        |

------

### ğŸ”— 4. ì „ì²´ íë¦„ ì˜ˆì‹œ (ì˜ˆ: REST â†’ Kafka)

```
HTTP â†’ Inbound Gateway â†’ Channel â†’ Transformer â†’ Kafka Outbound Adapter
```

1. í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ (`/send`)
2. ë©”ì‹œì§€ ìƒì„± â†’ Channelë¡œ ì „ë‹¬
3. Transformerê°€ ë©”ì‹œì§€ ê°€ê³µ
4. Kafkaë¡œ ì „ì†¡ë¨

------

### ğŸ› ï¸ 5. ê¸°ë³¸ ì„¤ì • ì˜ˆì‹œ (Java DSL)

```
@Configuration
@EnableIntegration
public class IntegrationFlowConfig {

    @Bean
    public IntegrationFlow sampleFlow() {
        return IntegrationFlows.from(Http.inboundGateway("/send"))
            .transform(String.class, String::toUpperCase) // ëŒ€ë¬¸ì ë³€í™˜
            .handle(m -> System.out.println("ğŸ”” ìˆ˜ì‹  ë©”ì‹œì§€: " + m.getPayload()))
            .get();
    }
}
```

â¡ï¸ `/send`ë¡œ POSTí•˜ë©´ ë©”ì‹œì§€ê°€ ëŒ€ë¬¸ìë¡œ ë³€í™˜ë˜ì–´ ì¶œë ¥ë¨

------

### ğŸ“˜ 6. ì£¼ìš” ì»´í¬ë„ŒíŠ¸ ì •ë¦¬

#### âœ… Channel (ë©”ì‹œì§€ í†µë¡œ)

```
@Bean
public MessageChannel inputChannel() {
    return new DirectChannel();
}
```

- `DirectChannel`: ì‹±ê¸€ ì†Œë¹„ì, ë™ê¸° ì²˜ë¦¬
- `QueueChannel`: ë¹„ë™ê¸° ëŒ€ê¸° ê°€ëŠ¥
- `PublishSubscribeChannel`: ë¸Œë¡œë“œìºìŠ¤íŠ¸

------

#### âœ… Transformer (ë©”ì‹œì§€ ë³€í™˜)

```
.transform(String.class, msg -> "Hello, " + msg)
```

------

#### âœ… Router (ì¡°ê±´ ë¶„ê¸°)

```
.route(String.class, msg -> msg.contains("VIP") ? "vipChannel" : "normalChannel")
```

------

#### âœ… Service Activator (í•¸ë“¤ëŸ¬)

```
.handle(MyMessageHandler.class, "process")
```

ë˜ëŠ” ëŒë‹¤ë¡œ ì²˜ë¦¬

```
.handle(msg -> processMessage(msg.getPayload()))
```

------

### ğŸ’¡ 7. ì‹¤ì „ ì‚¬ìš© ì˜ˆì‹œ

| ì‹œë‚˜ë¦¬ì˜¤                | êµ¬ì„±                                                  |
| ----------------------- | ----------------------------------------------------- |
| ì£¼ë¬¸ ìˆ˜ì‹  í›„ Kafka ì „ì†¡ | `Http â†’ Transformer â†’ Kafka.outboundChannelAdapter()` |
| DB â†’ Polling â†’ MQ       | `JdbcInboundAdapter â†’ Channel â†’ RabbitAdapter`        |
| íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬        | `FileInboundAdapter â†’ Filter â†’ ServiceActivator`      |
| ì´ë©”ì¼ ìˆ˜ì‹  ìë™ ì²˜ë¦¬   | `MailInboundAdapter â†’ Transformer â†’ SlackNotifier`    |

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½í‘œ

| êµ¬ì„± ìš”ì†Œ         | ì—­í•                                                 |
| ----------------- | --------------------------------------------------- |
| Message           | payload + headers                                   |
| Channel           | ë©”ì‹œì§€ ê²½ë¡œ (`Direct`, `Queue`, `PublishSubscribe`) |
| Gateway           | ì™¸ë¶€ í˜¸ì¶œ â†” ë©”ì‹œì§€ ë³€í™˜                             |
| Adapter           | ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ë™ (Kafka, FTP, Mail ë“±)              |
| Transformer       | ë©”ì‹œì§€ í˜•ì‹ ë³€í™˜                                    |
| Filter            | ë©”ì‹œì§€ í†µê³¼ ì—¬ë¶€ ê²°ì •                               |
| Router            | ì¡°ê±´ì— ë”°ë¼ ë¶„ê¸° ì²˜ë¦¬                               |
| Service Activator | ì‹¤ì œ ë¡œì§ ìˆ˜í–‰ ìœ„ì¹˜                                 |

