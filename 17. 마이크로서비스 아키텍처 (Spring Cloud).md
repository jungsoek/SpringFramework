# 17. ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ (Spring Cloud)

## ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬: Eureka

### ğŸ§© 1. ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ë€?

> ë¶„ì‚° ì‹œìŠ¤í…œ(MSA)ì—ì„œ **ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ì˜ ìœ„ì¹˜(IP, PORT)ë¥¼ ìë™ìœ¼ë¡œ ë“±ë¡í•˜ê³  íƒìƒ‰**í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ê¸°ëŠ¥

âœ… IPê°€ ë™ì ìœ¼ë¡œ ë°”ë€ŒëŠ” ì„œë¹„ìŠ¤ í™˜ê²½ì—ì„œ
 âœ… í´ë¼ì´ì–¸íŠ¸ê°€ ì§ì ‘ ì£¼ì†Œë¥¼ ì•Œì§€ ì•Šê³ ë„
 âœ… **ì„œë¹„ìŠ¤ ì´ë¦„ ê¸°ë°˜ìœ¼ë¡œ ìš”ì²­ ê°€ëŠ¥**

------

### ğŸ” 2. Eurekaë€?

> Netflixê°€ ë§Œë“  ì˜¤í”ˆì†ŒìŠ¤ **ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ ì„œë²„**

- Spring Cloud Netflixì—ì„œ ê³µì‹ ì§€ì›
- **Eureka Server**: ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì„œë²„
- **Eureka Client**: ì„œë¹„ìŠ¤ ì œê³µì + íƒìƒ‰ì

------

### âš™ï¸ 3. êµ¬ì„± íë¦„

```
[Service A] â† (ì„œë¹„ìŠ¤ëª…ìœ¼ë¡œ íƒìƒ‰) â† Eureka â† (ë“±ë¡) â† [Service B]
```

1. ì„œë¹„ìŠ¤ Bê°€ Eurekaì— ìì‹ ì„ ë“±ë¡
2. ì„œë¹„ìŠ¤ Aê°€ Eurekaì—ì„œ â€œservice-bâ€ì˜ ìœ„ì¹˜ ì¡°íšŒ
3. EurekaëŠ” ì„œë¹„ìŠ¤ ëª©ë¡ì„ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì‘ë‹µ

------

### ğŸ“˜ 4. Eureka ê¸°ë³¸ êµ¬ì„± ìš”ì†Œ

| êµ¬ì„±                  | ì—­í•                                           |
| --------------------- | --------------------------------------------- |
| **Eureka Server**     | ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì—­í• : ë“±ë¡ëœ ì„œë¹„ìŠ¤ ì •ë³´ë¥¼ ê´€ë¦¬    |
| **Eureka Client**     | ë“±ë¡ì + íƒìƒ‰ì ì—­í•                           |
| **Service Registry**  | ì¸ìŠ¤í„´ìŠ¤ ëª©ë¡, ìƒíƒœ ì •ë³´, heartbeat ê¸°ë°˜ ê°±ì‹  |
| **Self-preservation** | ëŒ€ëŸ‰ ë“±ë¡ í•´ì œ ë°©ì§€ ë³´í˜¸ ëª¨ë“œ                 |

------

### ğŸ› ï¸ 5. Eureka Server ì„¤ì • (Spring Boot)

#### âœ… 1) ì˜ì¡´ì„± ì¶”ê°€

```
dependencies {
    implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-server'
}
```

#### âœ… 2) ì–´ë…¸í…Œì´ì…˜ ì„¤ì •

```
@SpringBootApplication
@EnableEurekaServer
public class EurekaServerApplication { ... }
```

#### âœ… 3) application.yml

```
server:
  port: 8761

eureka:
  client:
    register-with-eureka: false
    fetch-registry: false
```

â¡ï¸ ì‹¤í–‰ í›„ http://localhost:8761 ì—ì„œ Eureka Dashboard í™•ì¸ ê°€ëŠ¥

------

### ğŸ§© 6. Eureka Client ì„¤ì •

#### âœ… 1) ì˜ì¡´ì„± ì¶”ê°€

```
implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'
```

#### âœ… 2) application.yml

```
spring:
  application:
    name: user-service

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka
```

â¡ï¸ ì´ ì„¤ì •ìœ¼ë¡œ `user-service`ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ Eurekaì— ìë™ ë“±ë¡ë¨

------

### ğŸ”„ 7. í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ í˜¸ì¶œí•˜ê¸°

#### âœ… ë°©ë²• 1: RestTemplate + `@LoadBalanced`

```
@Bean
@LoadBalanced
public RestTemplate restTemplate() {
    return new RestTemplate();
}
```

```
String response = restTemplate.getForObject("http://order-service/orders", String.class);
```

â¡ï¸ `order-service`ë¼ëŠ” **ì„œë¹„ìŠ¤ ì´ë¦„ìœ¼ë¡œ** í˜¸ì¶œ ê°€ëŠ¥
 (Spring Cloud LoadBalancerê°€ Eurekaì—ì„œ ì£¼ì†Œë¥¼ ì¡°íšŒí•¨)

------

#### âœ… ë°©ë²• 2: Feign Client ì‚¬ìš©

```
implementation 'org.springframework.cloud:spring-cloud-starter-openfeign'
```

```
@FeignClient(name = "order-service")
public interface OrderClient {
    @GetMapping("/orders")
    List<OrderDto> getOrders();
}
```

â¡ï¸ Feignì´ Eurekaì—ì„œ `order-service`ì˜ ìœ„ì¹˜ë¥¼ ì°¾ì•„ ìë™ í˜¸ì¶œ

------

### ğŸ§  8. ì‹¤ë¬´ì—ì„œì˜ Eureka ì„¤ê³„ íŒ

| í•­ëª©          | ì „ëµ                                                  |
| ------------- | ----------------------------------------------------- |
| í¬íŠ¸ ì¶©ëŒ     | ì„œë¹„ìŠ¤ë§ˆë‹¤ ëœë¤ í¬íŠ¸(`server.port=0`) ì¶”ì²œ            |
| health-check  | actuator ì—°ë™ or `management.health` ì§ì ‘ êµ¬í˜„        |
| ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ | EurekaëŠ” í´ëŸ¬ìŠ¤í„°ë§ ì§€ì› (`peer-eureka-nodes`)        |
| í†µì‹  ë³´ì•ˆ     | TLS ì ìš© or gateway ì•ë‹¨ ì²˜ë¦¬                         |
| íƒìƒ‰ ì£¼ê¸°     | ê¸°ë³¸ 30ì´ˆ â†’ `leaseRenewalIntervalInSeconds` ì¡°ì • ê°€ëŠ¥ |

------

### ğŸš¨ 9. Eureka ë‹¨ì  & ë³´ì™„

| ì´ìŠˆ                   | ì„¤ëª…                                  | í•´ê²°             |
| ---------------------- | ------------------------------------- | ---------------- |
| Self-preservation ëª¨ë“œ | ì¥ì•  ì‹œ ì„œë¹„ìŠ¤ ì œê±° ì•ˆ ë¨             | ì„¤ì •ìœ¼ë¡œ êº¼ì•¼ í•¨ |
| ìë™ ì œê±° ì§€ì—°         | ì‹¤íŒ¨í•œ ì¸ìŠ¤í„´ìŠ¤ê°€ UIì— ë‚¨ìŒ           | TTL ì„¤ì • ë‹¨ì¶•    |
| Scale ë¬¸ì œ             | ìˆ˜ì²œ ê°œ ì´ìƒ ì‹œ Consul/Zookeeper ê³ ë ¤ | ë¶„ì‚° ìºì‹œ ì—°ê³„   |

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½í‘œ

| êµ¬ì„±          | ì„¤ëª…                                             |
| ------------- | ------------------------------------------------ |
| Eureka Server | ì„œë¹„ìŠ¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì„œë²„ ì—­í•                       |
| Eureka Client | ì„œë¹„ìŠ¤ ë“±ë¡ + íƒìƒ‰ ê°€ëŠ¥                          |
| íƒìƒ‰ ë°©ì‹     | ì„œë¹„ìŠ¤ëª… ê¸°ë°˜ â†’ IP ë™ì  ë§¤í•‘                     |
| ì—°ë™ ë°©ì‹     | `RestTemplate + @LoadBalanced`, Feign, WebClient |
| ì‹¤ë¬´ í™œìš©     | API Gateway â†” ì„œë¹„ìŠ¤ íƒìƒ‰, ë™ì  ìŠ¤ì¼€ì¼ë§ ì§€ì›    |

## êµ¬ì„± ì„œë²„: Spring Cloud Config

### ğŸ§© 1. Spring Cloud Configë€?

> ë¶„ì‚°ëœ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í™˜ê²½ì—ì„œ **ì„¤ì • íŒŒì¼(application.yml)ì„ ì¤‘ì•™ ì§‘ì¤‘í™”**í•˜ì—¬ ê´€ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” Spring Cloud êµ¬ì„± ìš”ì†Œ.

âœ… í™˜ê²½ ì„¤ì •(application.yml ë“±)ì„ **Git, SVN, íŒŒì¼ ì‹œìŠ¤í…œ ë“±ì— ì €ì¥**
âœ… ê° ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ëŠ” í•´ë‹¹ ì„¤ì •ì„ **Config Serverë¡œë¶€í„° ì‹¤ì‹œê°„ìœ¼ë¡œ fetch**

------

### ğŸ” 2. ì™œ í•„ìš”í•œê°€?

| ê¸°ì¡´ ë°©ì‹ ë¬¸ì œ               | Config Serverì˜ í•´ê²°    |
| ---------------------------- | ----------------------- |
| ì„œë¹„ìŠ¤ë§ˆë‹¤ ì„¤ì • ì¤‘ë³µ/ë¶ˆì¼ì¹˜  | ì„¤ì • ì¤‘ì•™ ì§‘ì¤‘í™”        |
| ë°°í¬ ì—†ì´ ì„¤ì • ìˆ˜ì • ë¶ˆê°€     | ì„¤ì • ë³€ê²½ â†’ ì‹¤ì‹œê°„ ë°˜ì˜ |
| ìš´ì˜í™˜ê²½ë³„ ì„¤ì • ê´€ë¦¬ ì–´ë ¤ì›€  | profile ê¸°ë°˜ í™˜ê²½ ë¶„ë¦¬  |
| ì‹œí¬ë¦¿/ë¯¼ê° ì •ë³´ ê´€ë¦¬ ì–´ë ¤ì›€ | ì•”í˜¸í™”/ë³µí˜¸í™” ì§€ì›      |

------

### ğŸ§± 3. êµ¬ì„± êµ¬ì¡°

```
[Git Repo] â† (ì„¤ì • íŒŒì¼)
   â†‘
[Config Server]
   â†“
[Service A], [Service B], ...
```

- Git ì €ì¥ì†Œì— ì„¤ì • ì €ì¥ (`application.yml`, `user-service.yml`, ...)
- Config Serverê°€ Gitì—ì„œ ì„¤ì •ì„ ì½ì–´ ì„œë¹„ìŠ¤ì— ì „ë‹¬
- ê° ì„œë¹„ìŠ¤ëŠ” ìì‹ ì˜ ì„¤ì •ì„ `/config` ì„œë²„ì—ì„œ fetch

------

### âš™ï¸ 4. Config Server êµ¬ì„±

#### âœ… 1) ì˜ì¡´ì„± ì¶”ê°€

```
implementation 'org.springframework.cloud:spring-cloud-config-server'
```

#### âœ… 2) ì„¤ì • ë° ì–´ë…¸í…Œì´ì…˜

```
@SpringBootApplication
@EnableConfigServer
public class ConfigServerApplication { ... }
```

------

#### âœ… 3) application.yml

```
server:
  port: 8888

spring:
  cloud:
    config:
      server:
        git:
          uri: https://github.com/my-org/my-config-repo
          default-label: main
```

> GitHub, GitLab, Bitbucket, ì‚¬ì„¤ Git ëª¨ë‘ ì§€ì›

------

#### âœ… 4) Git ì €ì¥ì†Œ íŒŒì¼ êµ¬ì¡° ì˜ˆì‹œ

```
/config-repo/
â”œâ”€â”€ application.yml             # ê³µí†µ ì„¤ì •
â”œâ”€â”€ user-service.yml            # user-service ì „ìš© ì„¤ì •
â”œâ”€â”€ order-service-dev.yml       # order-service + dev í”„ë¡œíŒŒì¼
```

------

### ğŸ”„ 5. Config Client ì„¤ì •

#### âœ… 1) ì˜ì¡´ì„± ì¶”ê°€

```
implementation 'org.springframework.cloud:spring-cloud-starter-config'
```

------

#### âœ… 2) bootstrap.yml ë˜ëŠ” application.yml

```
spring:
  application:
    name: user-service
  cloud:
    config:
      uri: http://localhost:8888
      profile: dev
      label: main
```

> ```
> application.name`ì´ Config Serverì—ì„œ ê²€ìƒ‰ë˜ëŠ” íŒŒì¼ëª…ì— ëŒ€ì‘ë¨: `user-service-dev.yml
> ```

------

### ğŸ“² 6. ì‹¤í–‰ í›„ ë™ì‘

ì„œë¹„ìŠ¤ ì‹œì‘ ì‹œ:

```
GET http://localhost:8888/user-service/dev
â†’ user-service-dev.yml + application.yml ë³‘í•© í›„ ë°˜í™˜
```

Spring BootëŠ” ì´ë¥¼ ë‚´ë¶€ ì„¤ì •ìœ¼ë¡œ ì ìš©

------

### ğŸ’¥ 7. ì„¤ì • ë³€ê²½ â†’ ì‹¤ì‹œê°„ ë°˜ì˜

#### âœ… Actuator + Bus ì—°ë™ í•„ìš”

- Config Server: RabbitMQ ë“± ë©”ì‹œì§€ ë¸Œë¡œì»¤ ì—°ë™
- Clientì— `spring-boot-starter-actuator`, `spring-cloud-starter-bus-amqp` ì¶”ê°€

```
curl -X POST http://localhost:8080/actuator/refresh
```

> ìµœì‹  Spring Cloud Bus ì‚¬ìš© ì‹œ `/actuator/busrefresh`ë¡œ ë‹¤ìˆ˜ ì¸ìŠ¤í„´ìŠ¤ ë™ì‹œ ë°˜ì˜ ê°€ëŠ¥

------

### ğŸ” 8. ë¯¼ê° ì •ë³´(ì‹œí¬ë¦¿) ì•”í˜¸í™”

#### âœ… ì„œë²„ì— ëŒ€ì¹­í‚¤ ì„¤ì •

```
encrypt:
  key: my-secret-key
```

#### âœ… Git ì„¤ì • íŒŒì¼ì— ì•”í˜¸í™”ëœ ê°’ ì…ë ¥

```
db-password: '{cipher}d43ed3...'
```

â¡ï¸ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìë™ ë³µí˜¸í™”ë¨

------

### ğŸ§  9. ì‹¤ë¬´ ì„¤ê³„ íŒ

| í•­ëª©       | ì „ëµ                                               |
| ---------- | -------------------------------------------------- |
| Git ë¸Œëœì¹˜ | `main`, `dev`, `prod` ë¶„ë¦¬ + `label`ë¡œ ë§¤í•‘        |
| êµ¬ì¡°       | `application.yml` â†’ ê³µí†µ, ì„œë¹„ìŠ¤ë³„ íŒŒì¼ì€ ë®ì–´ì“°ê¸° |
| ë™ì  ë³€ê²½  | `@RefreshScope`ë¡œ Bean ì¬ë¡œë”© ê°€ëŠ¥                 |
| ë³´ì•ˆ       | Config Serverì— ì¸ì¦ í•„í„° ì¶”ê°€ (`Spring Security`) |
| ìºì‹œ       | `spring.cloud.config.cache` ì„¤ì • ê³ ë ¤              |

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½í‘œ

| í•­ëª©          | ì„¤ëª…                                                      |
| ------------- | --------------------------------------------------------- |
| Config Server | ì„¤ì • íŒŒì¼ì„ ì¤‘ì•™ì—ì„œ ì œê³µí•˜ëŠ” ì„œë²„                        |
| ì„¤ì • ì €ì¥ì†Œ   | Git, SVN, íŒŒì¼ ì‹œìŠ¤í…œ ë“± ê°€ëŠ¥                             |
| Client êµ¬ì„±   | `spring.application.name` + `profile` + `label`           |
| ì‹¤ì‹œê°„ ë°˜ì˜   | `/actuator/refresh` or Spring Cloud Bus                   |
| ì•”í˜¸í™” ì§€ì›   | `{cipher}` + ëŒ€ì¹­í‚¤ ê¸°ë°˜ ë³µí˜¸í™”                           |
| ì‹¤ë¬´ ì ìš©     | ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê³µí†µ ì„¤ì •, ì™¸ë¶€í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬, ì‹œí¬ë¦¿ ë¶„ë¦¬ |

## API Gateway: Spring Cloud Gateway

### ğŸ§© 1. Spring Cloud Gatewayë€?

> Spring Cloudì—ì„œ ì œê³µí•˜ëŠ” **ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ìš© API Gateway ì†”ë£¨ì…˜**

âœ… ëª¨ë“  ì™¸ë¶€ ìš”ì²­ì„ **ì¤‘ì•™ ê´€ë¬¸(Gateway)**ì„ í†µí•´ ì²˜ë¦¬
 âœ… ë¼ìš°íŒ…, í•„í„°ë§, ì¸ì¦, ì†ë„ ì œí•œ, ë¡œê¹… ë“±
 âœ… Netflix Zuulì˜ ëŒ€ì²´ë¡œ, Spring 5ì˜ WebFlux ê¸°ë°˜ ë¹„ë™ê¸° ì²˜ë¦¬ ì§€ì›

------

### ğŸ¯ 2. ì™œ API Gatewayê°€ í•„ìš”í•œê°€?

| ë¬¸ì œ            | Gateway ì—­í•                         |
| --------------- | ----------------------------------- |
| ì„œë¹„ìŠ¤ URL ë…¸ì¶œ | ë‹¨ì¼ ì§„ì…ì  ì œê³µ (`api.domain.com`) |
| ì¸ì¦ ì¤‘ë³µ       | ê³µí†µ ì¸ì¦ í•„í„° ì²˜ë¦¬                 |
| CORS ë¬¸ì œ       | Gatewayì—ì„œ ì¼ê´„ ì„¤ì • ê°€ëŠ¥          |
| ìš”ì²­ ë¡œê¹…/ì¶”ì   | ì¼ê´€ëœ ë¡œê¹… ë° íŠ¸ë˜í”½ ì œì–´          |
| ë™ì  ë¼ìš°íŒ…     | Eureka ì—°ë™ìœ¼ë¡œ ìë™ ë¼ìš°íŒ…         |

------

### ğŸ§± 3. ê¸°ë³¸ êµ¬ì„± íë¦„

```
[Client]
  â†“
[Spring Cloud Gateway]
  â†“          â†“            â†“
Auth Filter  Logging      Rate Limit
  â†“
[Route] â†’ [User Service, Order Service, ...]
```

------

### âš™ï¸ 4. ê¸°ë³¸ ì„¤ì •

#### âœ… 1) ì˜ì¡´ì„± ì¶”ê°€

```
implementation 'org.springframework.cloud:spring-cloud-starter-gateway'
```

> í•„ìš” ì‹œ: `spring-cloud-starter-netflix-eureka-client`ë„ í•¨ê»˜

------

#### âœ… 2) application.yml ë¼ìš°íŒ… ì„¤ì •

```
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: http://localhost:8081
          predicates:
            - Path=/user/**
          filters:
            - AddRequestHeader=X-Request-Gateway, Gateway
```

> `/user/**` ìš”ì²­ â†’ `http://localhost:8081`ìœ¼ë¡œ ì „ë‹¬

------

### ğŸ›£ï¸ 5. í•µì‹¬ ìš”ì†Œ ì •ë¦¬

| ìš”ì†Œ              | ì„¤ëª…                                                         |
| ----------------- | ------------------------------------------------------------ |
| **Route**         | ìš”ì²­ URL, ì¡°ê±´, ëª©ì ì§€ URI ì„¤ì •                              |
| **Predicate**     | ê²½ë¡œ/ë©”ì„œë“œ/í—¤ë” ë“± ì¡°ê±´ ì§€ì • (`Path`, `Method`, `Header`)   |
| **Filter**        | ì „/í›„ì²˜ë¦¬ ì‘ì—… ìˆ˜í–‰ (`AddHeader`, `StripPrefix`, ì»¤ìŠ¤í…€ í•„í„° ë“±) |
| **URI**           | LB (`lb://user-service`), HTTP ë“± ëª©ì ì§€ ì§€ì • ë°©ì‹           |
| **Global Filter** | ì „ì²´ ìš”ì²­ì— ì ìš©ë˜ëŠ” í•„í„° (@Component)                       |

------

### ğŸ§­ 6. Eureka ì—°ë™ + ì„œë¹„ìŠ¤ëª… ê¸°ë°˜ ë¼ìš°íŒ…

```
spring:
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
```

> `http://gateway/api/user-service/**` â†’ `lb://user-service`ë¡œ ì „ë‹¬ë¨
>  (ì„œë¹„ìŠ¤ëª… ê¸°ë°˜ ë™ì  ë¼ìš°íŒ…)

------

### ğŸ” 7. ì¸ì¦/ë³´ì•ˆ ì ìš© ì˜ˆ

#### âœ… 1) ì»¤ìŠ¤í…€ ì¸ì¦ í•„í„° ì‘ì„±

```
@Component
public class AuthFilter implements GlobalFilter {

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String token = exchange.getRequest().getHeaders().getFirst("Authorization");

        if (!isValid(token)) {
            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
            return exchange.getResponse().setComplete();
        }

        return chain.filter(exchange);
    }
}
```

------

#### âœ… 2) CORS, HTTPS, JWT, OAuth2ë„ Gatewayì—ì„œ ì¼ê´„ ì„¤ì • ê°€ëŠ¥

```
spring:
  cloud:
    gateway:
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods: "*"
```

------

### ğŸ“Š 8. ê³ ê¸‰ í•„í„° ì˜ˆì‹œ

```
filters:
  - name: RequestRateLimiter
    args:
      redis-rate-limiter.replenishRate: 10
      redis-rate-limiter.burstCapacity: 20
```

â¡ï¸ IPë‹¹ ì´ˆë‹¹ 10ê±´, ìµœëŒ€ ë²„ìŠ¤íŠ¸ 20ê±´ â†’ ì†ë„ ì œí•œ

```
filters:
  - name: Retry
    args:
      retries: 3
      statuses: BAD_GATEWAY
```

â¡ï¸ 502 ì—ëŸ¬ ë°œìƒ ì‹œ ìµœëŒ€ 3íšŒ ì¬ì‹œë„

------

### ğŸ’¡ 9. ì‹¤ë¬´ ì„¤ê³„ íŒ

| í•­ëª©        | ì „ëµ                                                         |
| ----------- | ------------------------------------------------------------ |
| ì„œë¹„ìŠ¤ ì´ë¦„ | Eureka ë“±ë¡ëª…ê³¼ ë™ì¼í•˜ê²Œ ì„¤ì •                                |
| ì¸ì¦        | JWT í•„í„°ë¥¼ Gatewayì— ê³µí†µ ì ìš©                               |
| ë¡œê¹…        | GlobalFilterì—ì„œ ìš”ì²­/ì‘ë‹µ ë¡œê¹… ì²˜ë¦¬                         |
| Rate Limit  | Redis ê¸°ë°˜ RequestRateLimiter ì‚¬ìš©                           |
| ì¥ì•  ê²©ë¦¬   | Fallback route ì„¤ì • ê°€ëŠ¥ (`Hystrix` ì œê±°ë¨ â†’ Resilience4j ì¶”ì²œ) |

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½í‘œ

| í•­ëª©         | ì„¤ëª…                                           |
| ------------ | ---------------------------------------------- |
| Gateway ì—­í•  | MSA ì™¸ë¶€ ì§„ì…ì , ë¼ìš°íŒ… + ì¸ì¦/í•„í„°            |
| Predicate    | ìš”ì²­ ì¡°ê±´ ì •ì˜ (`Path`, `Header`, `Method`)    |
| Filter       | ì „í›„ì²˜ë¦¬ ì‘ì—… (`Auth`, `RateLimit`, `Logging`) |
| Eureka ì—°ë™  | `lb://user-service` ê¸°ë°˜ ë¼ìš°íŒ… ìë™ êµ¬ì„±      |
| ì‹¤ë¬´ í™œìš©    | ê³µí†µ ì¸ì¦, ë¡œê¹…, ë³´ì•ˆ ì²˜ë¦¬, ë™ì  URI êµ¬ì„±      |

## ë¡œë“œ ë°¸ëŸ°ì‹±: Spring Cloud LoadBalancer

### ğŸ§© 1. Spring Cloud LoadBalancerë€?

> **Spring Cloudê°€ ì œê³µí•˜ëŠ” í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë¡œë“œ ë°¸ëŸ°ì„œ**
>  ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í™˜ê²½ì—ì„œ **ì„œë¹„ìŠ¤ëª…ìœ¼ë¡œ ìš”ì²­ì„ ë³´ë‚´ë©´**,
>  **ìë™ìœ¼ë¡œ ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì„œ ìš”ì²­**ì„ ì „ë‹¬í•´ì¤Œ.

âœ… í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ â†’ ë¡œì»¬ ë¡œë“œ ë°¸ëŸ°ì„œ â†’ ì¸ìŠ¤í„´ìŠ¤ ì„ íƒ â†’ ì„œë¹„ìŠ¤ í˜¸ì¶œ

------

### ğŸ”„ 2. ì™œ í•„ìš”í•œê°€?

| ë¬¸ì œ                             | í•´ê²°                     |
| -------------------------------- | ------------------------ |
| íŠ¹ì • ì¸ìŠ¤í„´ìŠ¤ì— íŠ¸ë˜í”½ ì§‘ì¤‘      | íŠ¸ë˜í”½ ë¶„ì‚°              |
| IP/PORT ê´€ë¦¬ ë³µì¡                | ì„œë¹„ìŠ¤ëª… ê¸°ë°˜ í˜¸ì¶œ       |
| ìŠ¤ì¼€ì¼ ì•„ì›ƒëœ ì¸ìŠ¤í„´ìŠ¤ ìë™ íƒìƒ‰ | Eureka, Consul ë“±ê³¼ ì—°ë™ |

------

### ğŸ” 3. ê¸°ì¡´ Ribbonê³¼ì˜ ì°¨ì´

| í•­ëª©         | Ribbon (Deprecated)    | Spring Cloud LoadBalancer                 |
| ------------ | ---------------------- | ----------------------------------------- |
| ë¼ì´ë¸ŒëŸ¬ë¦¬   | Netflix Ribbon         | Spring ìì²´ êµ¬í˜„                          |
| ìœ ì§€ë³´ìˆ˜     | ì¤‘ë‹¨ë¨                 | âœ… í™œì„±                                    |
| ë™ê¸°í™”       | RestTemplate ë“±ê³¼ ì—°ë™ | âœ… RestTemplate, âœ… WebClient, âœ… Feign ì§€ì› |
| ì»¤ìŠ¤í„°ë§ˆì´ì§• | ì œí•œì                  | ì „ëµ êµ¬ì„± ì™„ì „ ê°€ëŠ¥                       |

> Spring Boot 2.4 ì´í›„ ê¸°ë³¸ ë¡œë“œë°¸ëŸ°ì„œëŠ” **Spring Cloud LoadBalancer**

------

### âš™ï¸ 4. ê¸°ë³¸ ë™ì‘ êµ¬ì¡°

```
[RestTemplate or WebClient or Feign]
        â†“
lb://user-service (ì„œë¹„ìŠ¤ëª…)
        â†“
ServiceInstanceListSupplier
        â†“
LoadBalancerClient (ê¸°ë³¸ì€ RoundRobin)
        â†“
http://IP:PORT ë¡œ ìš”ì²­
```

------

### ğŸ”Œ 5. RestTemplate ì—°ë™ ì˜ˆì‹œ

#### âœ… 1) ì„¤ì •

```
@Bean
@LoadBalanced
public RestTemplate restTemplate() {
    return new RestTemplate();
}
```

#### âœ… 2) ì‚¬ìš©

```
String res = restTemplate.getForObject("http://order-service/orders", String.class);
```

â¡ï¸ `order-service`ëŠ” Eurekaì— ë“±ë¡ëœ ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ ì¤‘ í•˜ë‚˜ê°€ ì„ íƒë¨

------

### ğŸŒ 6. WebClient ì—°ë™ ì˜ˆì‹œ

```
@Bean
@LoadBalanced
public WebClient.Builder webClientBuilder() {
    return WebClient.builder();
}
```

```
String res = webClientBuilder.build()
    .get()
    .uri("http://payment-service/pay")
    .retrieve()
    .bodyToMono(String.class)
    .block();
```

------

### ğŸ¤ 7. Feign Client ì—°ë™

```
@FeignClient(name = "inventory-service")
public interface InventoryClient {
    @GetMapping("/inventory/check")
    boolean isAvailable();
}
```

â¡ï¸ ìë™ìœ¼ë¡œ Spring Cloud LoadBalancerë¥¼ í†µí•´ ì¸ìŠ¤í„´ìŠ¤ ì„ íƒ

------

### ğŸ”„ 8. ë¼ìš´ë“œë¡œë¹ˆ ì „ëµ (ê¸°ë³¸ê°’)

```
@Bean
public ReactorLoadBalancer<ServiceInstance> loadBalancer(Environment env,
    LoadBalancerClientFactory factory) {
    String name = env.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);
    return new RoundRobinLoadBalancer(factory.getLazyProvider(name, ServiceInstanceListSupplier.class), name);
}
```

â¡ï¸ ì¸ìŠ¤í„´ìŠ¤ë“¤ì„ ìˆœì°¨ì ìœ¼ë¡œ ëŒì•„ê°€ë©° ì„ íƒ

------

### âš™ï¸ 9. ì»¤ìŠ¤í…€ ë¡œë“œë°¸ëŸ°ì‹± ì „ëµ ì˜ˆì‹œ

```
public class MyCustomLoadBalancer implements ReactorServiceInstanceLoadBalancer {

    private final ObjectProvider<ServiceInstanceListSupplier> serviceInstanceListSupplierProvider;
    private final String serviceId;

    public MyCustomLoadBalancer(ObjectProvider<ServiceInstanceListSupplier> provider, String serviceId) {
        this.serviceInstanceListSupplierProvider = provider;
        this.serviceId = serviceId;
    }

    @Override
    public Mono<Response<ServiceInstance>> choose(Request request) {
        return serviceInstanceListSupplierProvider.getIfAvailable()
            .get()
            .next()
            .map(instances -> {
                // IP ê¸°ë°˜ ì„ íƒ, ëœë¤, Hash ê¸°ë°˜ ë“± ì „ëµ ê°€ëŠ¥
                return new DefaultResponse(instances.get(0));
            });
    }
}
```

------

### ğŸ§  10. ì‹¤ë¬´ ì„¤ê³„ íŒ

| í•­ëª©      | ì „ëµ                                                         |
| --------- | ------------------------------------------------------------ |
| ê¸°ë³¸ ì „ëµ | `RoundRobin`ìœ¼ë¡œ ì¶©ë¶„, íŠ¹ì • ìš”êµ¬ì‹œ `Weighted`, `IPHash`      |
| ë¡œê¹…      | ë¡œë“œë°¸ëŸ°ì„œ ì„ íƒëœ ì¸ìŠ¤í„´ìŠ¤ ë¡œê¹… â†’ ë¬¸ì œ ì¶”ì  ë„ì›€             |
| ì¥ì•  ëŒ€ì‘ | HealthCheck ì—†ì´ Eureka ê¸°ë°˜ë§Œ ì‚¬ìš© ì‹œ, ì¥ì•  ì¸ìŠ¤í„´ìŠ¤ ì„ íƒ ìœ„í—˜ ìˆìŒ |
| ë¶„ì‚° ì •ì±… | ì„œë¹„ìŠ¤ íŠ¹ì„±ì— ë”°ë¼ ë‹¤ë¥´ê²Œ êµ¬ì„± ê°€ëŠ¥ (ì½ê¸° ì „ìš©, ì“°ê¸° ì „ìš© ì¸ìŠ¤í„´ìŠ¤ ë“±) |
| í™•ì¥ì„±    | `LoadBalancerClientFilter`, `ReactorLoadBalancer`ë¡œ ê³ ê¸‰ êµ¬ì„± ê°€ëŠ¥ |

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½í‘œ

| í•­ëª©             | ì„¤ëª…                                           |
| ---------------- | ---------------------------------------------- |
| ê¸°ë³¸ ì „ëµ        | `RoundRobinLoadBalancer`                       |
| ì§€ì› ëŒ€ìƒ        | `RestTemplate`, `WebClient`, `FeignClient`     |
| Eureka ì—°ë™      | `lb://service-name` ì£¼ì†Œ â†’ IP:PORT ì„ íƒ        |
| ì»¤ìŠ¤í…€ ì „ëµ      | `ReactorLoadBalancer` êµ¬í˜„ìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥       |
| ì‹¤ë¬´ ì¤‘ìš” í¬ì¸íŠ¸ | ë¶„ì‚° ì²˜ë¦¬ + ì¸ìŠ¤í„´ìŠ¤ ì¥ì•  ëŒ€ì‘ + ë¡œê¹… + í…ŒìŠ¤íŠ¸ |

## ì¥ì•  ëŒ€ì‘: Resilience4j

### ğŸ§© 1. Resilience4jë€?

> ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê°„ í†µì‹ ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” **ì§€ì—°, ì‹¤íŒ¨, ì¥ì•  ìƒí™©ì„ ì œì–´í•˜ê³  ë³´í˜¸**í•˜ê¸° ìœ„í•œ ê²½ëŸ‰ ë¼ì´ë¸ŒëŸ¬ë¦¬

ğŸ“Œ **Netflix Hystrixì˜ ëŒ€ì²´**ë¡œ ê°œë°œë¨
 ğŸ“Œ **í•¨ìˆ˜í˜•(FP), ëŒë‹¤ ê¸°ë°˜ êµ¬ì¡°**, Spring Bootì™€ ì™„ë²½ ì—°ë™

------

### ğŸ” 2. ì™œ í•„ìš”í•œê°€?

| ë¬¸ì œ ìƒí™©                         | í•´ê²°ì±… (Resilience4j) |
| --------------------------------- | --------------------- |
| ì™¸ë¶€ ì„œë¹„ìŠ¤ ì‘ë‹µ ì§€ì—° â†’ ì „ì²´ ì§€ì—° | â›” Circuit Breaker     |
| ì¼ì‹œì  ì˜¤ë¥˜ â†’ ì „ì²´ ì‹¤íŒ¨           | ğŸ” Retry               |
| íŠ¸ë˜í”½ í­ì¦ â†’ ë‹¤ìš´                | â±ï¸ Rate Limiter        |
| ë¦¬ì†ŒìŠ¤ ì´ˆê³¼ â†’ íƒ€ì„ì•„ì›ƒ            | â³ Timeout             |
| ì¥ì•  ë°œìƒ ì‹œ Fallback ì—†ìŒ        | ğŸ” Fallback ì²˜ë¦¬       |

------

### ğŸ§± 3. Resilience4jì˜ ì£¼ìš” ëª¨ë“ˆ

| ëª¨ë“ˆ             | ì„¤ëª…                                |
| ---------------- | ----------------------------------- |
| âœ… CircuitBreaker | ì¥ì•  ê°ì§€ ì‹œ íšŒë¡œ ì°¨ë‹¨ (Fail Fast)  |
| âœ… Retry          | ì‹¤íŒ¨ ìš”ì²­ ìë™ ì¬ì‹œë„               |
| âœ… RateLimiter    | ì´ˆë‹¹ ìš”ì²­ ì œí•œ (Throttling)         |
| âœ… Bulkhead       | ë™ì‹œ ì‹¤í–‰ ìˆ˜ ì œí•œ (ê²©ë¦¬)            |
| âœ… TimeLimiter    | íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬                       |
| âœ… Cache          | ì‹¤íŒ¨ ì‹œ ì´ì „ ê²°ê³¼ ì¬ì‚¬ìš© (optional) |

------

### âš™ï¸ 4. Spring Boot + Resilience4j ê¸°ë³¸ ì„¤ì •

#### âœ… 1) ì˜ì¡´ì„± ì¶”ê°€

```
implementation 'io.github.resilience4j:resilience4j-spring-boot3'
implementation 'org.springframework.boot:spring-boot-starter-aop'
```

------

#### âœ… 2) application.yml ì„¤ì •

```
resilience4j:
  circuitbreaker:
    instances:
      myService:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 5s
  retry:
    instances:
      myService:
        maxAttempts: 3
        waitDuration: 1s
```

------

### ğŸ› ï¸ 5. ì‚¬ìš© ì˜ˆì‹œ (Spring ë°©ì‹)

```
@Service
public class RemoteUserService {

    @CircuitBreaker(name = "myService", fallbackMethod = "fallback")
    @Retry(name = "myService")
    public String getUser() {
        return restTemplate.getForObject("http://user-service/users", String.class);
    }

    public String fallback(Throwable t) {
        return "âš ï¸ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨ (fallback)";
    }
}
```

------

### ğŸ” 6. Circuit Breaker ë™ì‘ ì›ë¦¬

```
CLOSED  â†’ ì˜¤ë¥˜ìœ¨ â†‘ â†’ OPEN â†’ ì¼ì • ì‹œê°„ í›„ HALF-OPEN â†’ ì„±ê³µ ì‹œ CLOSED
```

| ìƒíƒœ      | ì„¤ëª…                                           |
| --------- | ---------------------------------------------- |
| CLOSED    | ì •ìƒ í†µì‹  ìƒíƒœ                                 |
| OPEN      | í˜¸ì¶œ ì°¨ë‹¨ ìƒíƒœ (fallback ìˆ˜í–‰)                 |
| HALF-OPEN | ì¼ë¶€ í—ˆìš© â†’ ì„±ê³µ íŒë‹¨ í›„ CLOSED ë³µê·€ or ì¬ì˜¤í”ˆ |

> ì‹¤ì‹œê°„ ì¥ì• ë¥¼ ê°ì§€í•˜ê³  **ì¥ì•  ì „íŒŒ ì°¨ë‹¨**ì´ í•µì‹¬

------

### ğŸ”‚ 7. Retry ë™ì‘ ì›ë¦¬

```
ìš”ì²­ ì‹¤íŒ¨ â†’ ìë™ ì¬ì‹œë„ (níšŒ) â†’ fallback
```

- ë„¤íŠ¸ì›Œí¬ ë‹¨ì ˆ, ì¼ì‹œì  ì˜¤ë¥˜ì— ìœ íš¨
- ì£¼ì˜: **DB íŠ¸ëœì­ì…˜ì—ì„œ ì¬ì‹œë„ ì‹œ ì¤‘ë³µ ì²˜ë¦¬ ë°œìƒ ê°€ëŠ¥ì„±** â†’ `@Transactional` ì¡°í•© ì‹ ì¤‘

------

### â±ï¸ 8. RateLimiter / TimeLimiter / Bulkhead

| ëª¨ë“ˆ            | ì„¤ì • ì˜ˆì‹œ                                                    |
| --------------- | ------------------------------------------------------------ |
| **RateLimiter** | ì´ˆë‹¹ ìš”ì²­ ìˆ˜ ì œí•œ â†’ `limitForPeriod: 10`, `limitRefreshPeriod: 1s` |
| **TimeLimiter** | `timeoutDuration: 2s` â†’ ì‘ë‹µì´ 2ì´ˆ ë„˜ìœ¼ë©´ ê°•ì œ ì¢…ë£Œ          |
| **Bulkhead**    | `maxConcurrentCalls: 5` â†’ ë™ì‹œì— 5ê°œë§Œ ì‹¤í–‰ ê°€ëŠ¥ (ThreadPool ê²©ë¦¬) |

â¡ï¸ ì„¤ì •ì€ ëª¨ë‘ `resilience4j.<module>.instances.<name>` í•˜ìœ„ì— êµ¬ì„±

------

### ğŸ“Š 9. ì‹¤ì‹œê°„ ìƒíƒœ ëª¨ë‹ˆí„°ë§

Spring Boot Actuatorì™€ ì—°ë™í•˜ë©´ ìƒíƒœ í™•ì¸ ê°€ëŠ¥:

```
/actuator/circuitbreakerevents  
/actuator/metrics/resilience4j.circuitbreaker.state
```

> Prometheus + Grafanaë¡œ ëŒ€ì‹œë³´ë“œ ì‹œê°í™” ê°€ëŠ¥

------

### ğŸ§  10. ì‹¤ë¬´ ì„¤ê³„ íŒ

| í•­ëª©           | ì „ëµ                                          |
| -------------- | --------------------------------------------- |
| Retry          | ë¹„ì¦ˆë‹ˆìŠ¤ ë¬´ê²°ì„± ìœ ì§€ê°€ ì¤‘ìš”í•œ ì‘ì—…ì—” ì‹ ì¤‘í•˜ê²Œ |
| CircuitBreaker | ì™¸ë¶€ API, DB, ê²°ì œ ì‹œìŠ¤í…œ ë“±ì— ê¼­ ì„¤ì •        |
| RateLimiter    | ì¸ì¦/ê²€ìƒ‰ ì„œë¹„ìŠ¤ì— ì ìš© ì¶”ì²œ                  |
| Fallback       | ë‹¨ìˆœ ë©”ì‹œì§€ or ìºì‹œ ì‘ë‹µ ë“± ì „ëµì ìœ¼ë¡œ ì„¤ê³„   |
| ëª¨ë‹ˆí„°ë§       | actuator, log, slack ì•Œë¦¼ìœ¼ë¡œ ì‹¤ì‹œê°„ ì¶”ì      |

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½í‘œ

| ëª¨ë“ˆ              | í•µì‹¬ ê¸°ëŠ¥                         |
| ----------------- | --------------------------------- |
| `@CircuitBreaker` | ì˜¤ë¥˜ ê°ì§€ ì‹œ í˜¸ì¶œ ì°¨ë‹¨ + fallback |
| `@Retry`          | ìë™ ì¬ì‹œë„                       |
| `@RateLimiter`    | ì´ˆë‹¹ í˜¸ì¶œ ìˆ˜ ì œí•œ                 |
| `@TimeLimiter`    | ì‘ë‹µ ì‹œê°„ ì´ˆê³¼ ì œì–´               |
| `@Bulkhead`       | ê²©ë¦¬ ì‹¤í–‰ (ì“°ë ˆë“œ or semaphore)   |
| fallbackMethod    | ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ì‘ë‹µ ë°©ì‹ ì§€ì •       |

## íŠ¸ë ˆì´ì‹±: Sleuth, Zipkin

### ğŸ§© 1. ê°œë…: ë¶„ì‚° íŠ¸ë ˆì´ì‹±ì´ë€?

> ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í™˜ê²½ì—ì„œ **í•˜ë‚˜ì˜ ìš”ì²­ì´ ì—¬ëŸ¬ ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬**ë  ë•Œ,
>  ê·¸ **ì „ì²´ ìš”ì²­ íë¦„ì„ ì¶”ì (trace)** í•˜ê³ 
>  **ì‹œê°í™”í•˜ì—¬ ë³‘ëª©, ì¥ì•  ì›ì¸ì„ ë¶„ì„**í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” êµ¬ì¡°.

âœ… ë‹¨ì¼ ë¡œê·¸ë¡œëŠ” íë¦„ íŒŒì•…ì´ ì–´ë ¤ì›€
 âœ… Sleuthê°€ **Trace ID/Span ID ë¶€ì—¬**, Zipkinì´ **ì‹œê°í™”**

------

### ğŸ” 2. Sleuthë€?

> Springì—ì„œ **ë¡œê·¸ì— Trace ID/Span IDë¥¼ ìë™ìœ¼ë¡œ ì‚½ì…**í•˜ì—¬
>  ìš”ì²­ ê°„ ê´€ê³„ë¥¼ ì¶”ì í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ë¶„ì‚° íŠ¸ë ˆì´ì‹± ë¼ì´ë¸ŒëŸ¬ë¦¬

#### âœ… í•µì‹¬ ìš©ì–´

| ìš©ì–´            | ì„¤ëª…                                |
| --------------- | ----------------------------------- |
| **Trace ID**    | í•˜ë‚˜ì˜ ì „ì²´ ìš”ì²­ íë¦„ì„ ì‹ë³„í•˜ëŠ” ID |
| **Span ID**     | í•˜ë‚˜ì˜ ì„¸ë¶€ ì‘ì—… ë‹¨ìœ„ë¥¼ ì‹ë³„í•˜ëŠ” ID |
| **Parent Span** | í•˜ìœ„ ì‘ì—…ì˜ ë¶€ëª¨ ì‘ì—… ID            |
| **Tags/Logs**   | ë©”íƒ€ ì •ë³´ (URI, status, time ë“±)    |

------

### ğŸ§© 3. Zipkinì´ë€?

> Sleuthê°€ ìƒì„±í•œ íŠ¸ë ˆì´ìŠ¤ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ì—¬
>  **ì‹œê°ì ìœ¼ë¡œ ìš”ì²­ íë¦„ì„ ë³´ì—¬ì£¼ëŠ” íŠ¸ë ˆì´ì‹± ì„œë²„**

âœ… ì›¹ UIì—ì„œ **ìš”ì²­ ë‹¨ìœ„ ì‹œê°í™”**, **ì§€ì—° êµ¬ê°„ ë¶„ì„**, **í˜¸ì¶œ ìˆœì„œ íŒŒì•…**

------

### âš™ï¸ 4. Sleuth + Zipkin ì•„í‚¤í…ì²˜ êµ¬ì¡°

```
[Client]
  â†“
[Gateway]
  â†“           â†“
TraceID   SpanID ë¶€ì—¬
  â†“
[Service A] â†’ [Service B]
      â†˜
     [Zipkin Server] â† ë¡œê·¸ ì „ì†¡
```

â¡ï¸ ëª¨ë“  ì„œë¹„ìŠ¤ì— Sleuth ì ìš© ì‹œ
 â¡ï¸ Trace IDê°€ **ëª¨ë“  ë¡œê·¸ì— í¬í•¨**ë˜ê³ 
 â¡ï¸ Zipkinì€ ì „ì²´ ìš”ì²­ íŠ¸ë¦¬ íë¦„ì„ ë³´ì—¬ì¤Œ

------

### ğŸ“¦ 5. ì˜ì¡´ì„± êµ¬ì„± (Gradle)

```
implementation 'org.springframework.cloud:spring-cloud-starter-sleuth'
implementation 'org.springframework.cloud:spring-cloud-starter-zipkin'
```

------

### ğŸ“˜ 6. ê¸°ë³¸ ì„¤ì • ì˜ˆì‹œ (application.yml)

```
spring:
  zipkin:
    base-url: http://localhost:9411
    enabled: true
  sleuth:
    sampler:
      probability: 1.0  # 100% ì¶”ì  (ìš´ì˜ì—ì„œëŠ” 0.1~0.5 ê¶Œì¥)
```

------

### ğŸŒ 7. Zipkin ì„œë²„ ì‹¤í–‰ ë°©ë²•

#### âœ… ë°©ë²• 1: ë„ì»¤ ì‹¤í–‰

```
docker run -d -p 9411:9411 openzipkin/zipkin
```

â¡ï¸ http://localhost:9411 ì—ì„œ ì›¹ UI í™•ì¸ ê°€ëŠ¥

------

#### âœ… ë°©ë²• 2: Spring Boot ê¸°ë°˜ ì„œë²„ ì§ì ‘ ì‹¤í–‰

```
implementation 'io.zipkin.java:zipkin-server'
implementation 'io.zipkin.java:zipkin-autoconfigure-ui'
```

```
@SpringBootApplication
@EnableZipkinServer
public class ZipkinServerApplication { ... }
```

------

### ğŸ“ 8. Sleuthê°€ ë¡œê·¸ì— ì¶”ê°€í•˜ëŠ” í•­ëª©

```
[INFO] [user-service, 1234567890abcdef, abc12345] ìš”ì²­ ì‹œì‘
```

| í•­ëª©             | ì„¤ëª…                     |
| ---------------- | ------------------------ |
| application name | ì„œë¹„ìŠ¤ ì´ë¦„              |
| traceId          | ì „ì²´ ìš”ì²­ ì‹ë³„ì         |
| spanId           | í˜„ì¬ ì‘ì—…ì˜ ID           |
| parentId         | ìƒìœ„ ì‘ì—… ID (ìˆì„ ê²½ìš°) |

------

### ğŸ› ï¸ 9. ì‹¤ì „ ì˜ˆì œ íë¦„ (FeignClient í¬í•¨)

#### âœ… Service A (user-service)

```
@FeignClient(name = "order-service")
public interface OrderClient {
    @GetMapping("/orders")
    List<Order> getOrders();
}
```

â¡ï¸ Sleuthê°€ ìë™ìœ¼ë¡œ **Trace ID/Span IDë¥¼ Feign ìš”ì²­ í—¤ë”ì— ì‚½ì…**

------

#### âœ… Service B (order-service)

```
GET /orders
â†’ í—¤ë”ì— traceId, spanId, parentSpanId í¬í•¨
â†’ Zipkinì— trace ì •ë³´ ì „ì†¡ë¨
```

------

### ğŸ§  10. ì‹¤ë¬´ ì„¤ê³„ íŒ

| í•­ëª©      | ì „ëµ                                                    |
| --------- | ------------------------------------------------------- |
| ì¶”ì  ë²”ìœ„ | ìš´ì˜ í™˜ê²½ì—ì„  `sampler.probability = 0.1` ì •ë„ë¡œ ì„¤ì •   |
| ì—°ë™ ëŒ€ìƒ | Gateway, Service, DB, Kafka ë“± ëª¨ë‘ ì¶”ì  ê°€ëŠ¥           |
| ë³´ì•ˆ      | ë¯¼ê°í•œ ë°ì´í„°ëŠ” Span tagì— ì§ì ‘ ë„£ì§€ ì•Šê¸°               |
| ì§€ì—° ë¶„ì„ | Trace ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ë³‘ëª© ì§€ì  ì‹œê°ì ìœ¼ë¡œ í™•ì¸           |
| ë¡œê·¸ ì—°ê³„ | ELK (ElasticSearch + Kibana)ì™€ í•¨ê»˜ ì—°ë™ ì‹œ ê²€ìƒ‰ë„ ê°€ëŠ¥ |

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½í‘œ

| í•­ëª©            | ì„¤ëª…                                      |
| --------------- | ----------------------------------------- |
| Sleuth          | Trace ID/Span ID ë¶€ì—¬ â†’ ë¡œê·¸ ìë™ ì‚½ì…    |
| Zipkin          | Trace ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ì‹œê°í™”            |
| ì—°ë™ ë°©ë²•       | ì˜ì¡´ì„± + base-url ì„¤ì •                    |
| Feign/WebClient | ìë™ìœ¼ë¡œ traceId ì „ë‹¬                     |
| ì‹¤ë¬´ í™œìš©       | ì¥ì•  ì¶”ì , ì„±ëŠ¥ ë³‘ëª© ë¶„ì„, ìš”ì²­ íë¦„ ì¶”ì  |

## ì´ë²¤íŠ¸ ê¸°ë°˜ ì—°ë™: Spring Cloud Stream

### ğŸ§© 1. Spring Cloud Streamì´ë€?

> Kafka, RabbitMQ ë“± ë©”ì‹œì§• ì‹œìŠ¤í…œì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ”
>  **ì´ë²¤íŠ¸ ê¸°ë°˜ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì—°ë™ì„ ìœ„í•œ ì¶”ìƒí™” í”„ë ˆì„ì›Œí¬**

ğŸ“Œ ë©”ì‹œì§€ ë¸Œë¡œì»¤ì— ì¢…ì†ë˜ì§€ ì•Šê³ ,
 ğŸ“Œ ìƒì‚°ì(Publisher)ì™€ ì†Œë¹„ì(Consumer)ë¥¼ **ì• í”Œë¦¬ì¼€ì´ì…˜ ë‹¨ìœ„ë¡œ ì„ ì–¸**
 ğŸ“Œ ì½”ë“œë¥¼ ë³€ê²½í•˜ì§€ ì•Šê³ ë„ **ë¸Œë¡œì»¤ë¥¼ êµì²´**í•  ìˆ˜ ìˆìŒ (ë°”ì¸ë” ê°œë…)

------

### ğŸ§± 2. êµ¬ì„± êµ¬ì¡°

```
[Service A] -- emits Event --> [Broker] --> [Service B] -- handles Event
```

â¡ï¸ ì„œë¹„ìŠ¤ A, BëŠ” ì„œë¡œ ì§ì ‘ ì•Œì§€ ì•ŠìŒ (Loosely Coupled)

------

### ğŸ§° 3. í•µì‹¬ êµ¬ì„± ìš”ì†Œ

| êµ¬ì„± ìš”ì†Œ          | ì„¤ëª…                                           |
| ------------------ | ---------------------------------------------- |
| **Binder**         | Kafka, RabbitMQ ë“±ê³¼ ì—°ê²°ì„ ë‹´ë‹¹í•˜ëŠ” ì–´ëŒ‘í„°    |
| **Binding**        | ì• í”Œë¦¬ì¼€ì´ì…˜ â†’ ë°”ì¸ë” ê°„ ë©”ì‹œì§€ ì±„ë„ ì—°ê²°      |
| **Producer**       | ì´ë²¤íŠ¸ ë°œí–‰ ì£¼ì²´ (`@Output`)                   |
| **Consumer**       | ì´ë²¤íŠ¸ ìˆ˜ì‹  ì£¼ì²´ (`@Input`, `@StreamListener`) |
| **MessageChannel** | ë©”ì‹œì§€ ì „ë‹¬ ê²½ë¡œ (`Flux<Message<T>>` ë“±)       |

------

### ğŸ“¦ 4. ì§€ì›í•˜ëŠ” ë°”ì¸ë”(Binder)

| ë°”ì¸ë”                            | ì„¤ëª…                         |
| --------------------------------- | ---------------------------- |
| `kafka`                           | Apache Kafka                 |
| `rabbit`                          | RabbitMQ                     |
| `kinesis`                         | AWS Kinesis (ì¶”ê°€ ì„¤ì • í•„ìš”) |
| `solace`, `azure-event-hubs`, ... | ë‹¤ì–‘í•œ ë°”ì¸ë” í™•ì¥ ê°€ëŠ¥      |

------

### âš™ï¸ 5. ì˜ì¡´ì„± (ì˜ˆ: Kafka ë°”ì¸ë” ì‚¬ìš© ì‹œ)

```
implementation 'org.springframework.cloud:spring-cloud-starter-stream-kafka'
```

RabbitMQ ì‚¬ìš© ì‹œ:

```
implementation 'org.springframework.cloud:spring-cloud-starter-stream-rabbit'
```

------

### ğŸ“˜ 6. ì„¤ì • ì˜ˆì‹œ (Kafka ê¸°ì¤€)

```
spring:
  cloud:
    stream:
      default-binder: kafka
      bindings:
        user-events-out:
          destination: user.events
          content-type: application/json
        user-events-in:
          destination: user.events
          group: user-service
```

| í•­ëª©           | ì˜ë¯¸                             |
| -------------- | -------------------------------- |
| `destination`  | Kafka í† í”½ ì´ë¦„ ë˜ëŠ” RabbitMQ í |
| `group`        | Kafka consumer group             |
| `content-type` | ë©”ì‹œì§€ ë³€í™˜ í˜•ì‹ (JSON, AVRO ë“±) |

------

### ğŸ”„ 7. ì´ë²¤íŠ¸ ë°œí–‰ (Producer)

```
@RequiredArgsConstructor
@EnableBinding(UserEventSource.class)
public class UserEventPublisher {

    private final UserEventSource source;

    public void publish(UserEvent event) {
        source.output().send(MessageBuilder.withPayload(event).build());
    }
}
```

```
public interface UserEventSource {
    @Output("user-events-out")
    MessageChannel output();
}
```

â¡ï¸ `user-events-out` â†’ Kafka í† í”½ `user.events`ë¡œ ë°”ì¸ë”©ë¨

------

### ğŸ“¥ 8. ì´ë²¤íŠ¸ ìˆ˜ì‹  (Consumer)

```
@EnableBinding(UserEventSink.class)
public class UserEventHandler {

    @StreamListener("user-events-in")
    public void handle(UserEvent event) {
        System.out.println("ğŸ“¥ ì‚¬ìš©ì ì´ë²¤íŠ¸ ìˆ˜ì‹ : " + event.getUsername());
    }
}
```

```
public interface UserEventSink {
    @Input("user-events-in")
    SubscribableChannel input();
}
```

------

### âš¡ 9. Spring Cloud Streamì˜ ì¥ì 

| ê¸°ëŠ¥          | ì„¤ëª…                                        |
| ------------- | ------------------------------------------- |
| ë¸Œë¡œì»¤ ì¶”ìƒí™” | ì½”ë“œ ë³€ê²½ ì—†ì´ Kafka â†” Rabbit êµì²´ ê°€ëŠ¥     |
| ì´ë²¤íŠ¸ ì¤‘ì‹¬   | ì§„ì§œ ë¹„ë™ê¸°, ëŠìŠ¨í•œ ê²°í•© êµ¬ì¡°               |
| í™•ì¥ì„±        | í™•ì¥ì„± ì¢‹ì€ Kafka ê¸°ë°˜ìœ¼ë¡œ ì†ì‰½ê²Œ ë¶„ì‚° ì²˜ë¦¬ |
| í…ŒìŠ¤íŠ¸ í¸ì˜   | Embedded Kafka, Test Binder ì œê³µ            |

------

### ğŸ§  10. ì‹¤ë¬´ ì„¤ê³„ íŒ

| í•­ëª©          | ì „ëµ                                                         |
| ------------- | ------------------------------------------------------------ |
| ì´ë²¤íŠ¸ ì„¤ê³„   | `Event Sourcing`ê³¼ëŠ” ë‹¤ë¥´ê²Œ **ëª…í™•í•œ ì˜ë¯¸(Event DTO)**ë¥¼ ì„¤ê³„ |
| ë©”ì‹œì§€ ì‹ ë¢°ì„± | Kafkaì˜ ê²½ìš° `acks`, Rabbitì˜ ê²½ìš° `manual ack` ê³ ë ¤         |
| ì¬ì²˜ë¦¬        | DLQ ì„¤ì • í•„ìš” (Kafka: retry topic / Rabbit: DLX)             |
| ë©±ë“±ì„±        | ë©”ì‹œì§€ ì¤‘ë³µ ìˆ˜ì‹  ëŒ€ë¹„ â†’ `idempotent` ì²˜ë¦¬ í•„ìš”               |
| ê´€ì¸¡ì„±        | Zipkin + Sleuth ì—°ë™ ê°€ëŠ¥ (TraceID ì „íŒŒ)                     |

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½í‘œ

| í•­ëª©           | ì„¤ëª…                                           |
| -------------- | ---------------------------------------------- |
| ë°”ì¸ë”(Binder) | Kafka, RabbitMQ ë“± ë©”ì‹œì§• ì—°ë™ ì–´ëŒ‘í„°          |
| Producer       | `@Output`, `MessageChannel`ì„ í†µí•´ ì´ë²¤íŠ¸ ë°œí–‰ |
| Consumer       | `@Input`, `@StreamListener`ë¡œ ì´ë²¤íŠ¸ ìˆ˜ì‹       |
| ì„¤ì • ì¤‘ì‹¬      | `bindings.*` í†µí•´ í† í”½/í/ì»¨ìŠˆë¨¸ ê·¸ë£¹ ì„¤ì •     |
| ì¶”ìƒí™” ìˆ˜ì¤€    | ê³ ìˆ˜ì¤€ â†’ ë¸Œë¡œì»¤ ì¢…ì†ì„± ì œê±° + í†µì¼ëœ êµ¬ì¡° ì œê³µ |

## ì¸ì¦ê³¼ ë³´ì•ˆ: OAuth2 Resource Server

### 1. ê°œë… ìš”ì•½

**OAuth2 Resource Server**ëŠ” ì™¸ë¶€ì—ì„œ ë°œê¸‰í•œ ì•¡ì„¸ìŠ¤ í† í°(Access Token)ì„ ê²€ì¦í•˜ê³ , **ì¸ì¦ëœ ì‚¬ìš©ìë¡œë¶€í„° ë³´í˜¸ëœ ìì›(Resource)**ì— ëŒ€í•œ ì ‘ê·¼ì„ ì œì–´í•˜ëŠ” ì—­í• ì„ í•œë‹¤.

- **Resource Server**ëŠ” ì¸ì¦ ê¸°ëŠ¥ì„ í•˜ì§€ ì•ŠìŒ
- í† í°ì€ ì™¸ë¶€ **Authorization Server**(ì˜ˆ: Keycloak, Auth0, Okta ë“±)ì—ì„œ ë°œê¸‰
- Resource ServerëŠ” ì£¼ì–´ì§„ í† í°ì˜ ìœ íš¨ì„±ì„ ê²€ì¦í•˜ê³ , í•´ë‹¹ ì‚¬ìš©ìì˜ ê¶Œí•œ(claims)ì„ ê¸°ë°˜ìœ¼ë¡œ ì ‘ê·¼ì„ ì œì–´

#### ì‹œìŠ¤í…œ êµ¬ì„±

```
[Client] -- Access Token --> [Resource Server (Spring Boot API)]
                          |
                [Authorization Server (Keycloak, Auth0...)]
```

------

### 2. Spring Boot êµ¬ì„± ê°œìš”

#### í•„ìˆ˜ ì˜ì¡´ì„± (Gradle ì˜ˆì‹œ)

```
dependencies {
  implementation 'org.springframework.boot:spring-boot-starter-oauth2-resource-server'
  implementation 'org.springframework.boot:spring-boot-starter-security'
}
```

------

### 3. ê¸°ë³¸ ì„¤ì • ë°©ë²• (`application.yml`)

#### âœ… JWT ê¸°ë°˜ í† í° ì‚¬ìš© ì˜ˆì‹œ

```
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: https://auth.example.com/realms/myrealm
```

> `issuer-uri`ëŠ” JWT í† í°ì˜ **iss (issuer)** í´ë ˆì„ ê°’ê³¼ ë§¤ì¹­ë˜ëŠ” URLë¡œ, `.well-known/openid-configuration`ì„ í†µí•´ ë©”íƒ€ ì •ë³´ë¥¼ ë°›ì•„ì™€ ê³µê°œ í‚¤ë¥¼ íšë“í•˜ê³  í† í°ì„ ê²€ì¦í•œë‹¤.

------

### 4. SecurityFilterChain ì„¤ì •

```
@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/public/**").permitAll()
                .anyRequest().authenticated()
            )
            .oauth2ResourceServer(oauth2 -> oauth2
                .jwt() // JWT ë°©ì‹ ëª…ì‹œ
            );
        return http.build();
    }
}
```

------

### 5. JWT Claim ë§¤í•‘

ê¸°ë³¸ì ìœ¼ë¡œ `sub`, `scope`, `authorities` ë“±ì˜ claimì´ Spring Securityì˜ **Principal ì •ë³´**ë¡œ ë§¤í•‘ëœë‹¤. ë” ìì„¸íˆ ì„¤ì •í•˜ë ¤ë©´ **Converter**ë¥¼ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•´ì•¼ í•œë‹¤.

```
@Bean
public JwtAuthenticationConverter jwtAuthenticationConverter() {
    JwtGrantedAuthoritiesConverter authoritiesConverter = new JwtGrantedAuthoritiesConverter();
    authoritiesConverter.setAuthorityPrefix("ROLE_");
    authoritiesConverter.setAuthoritiesClaimName("roles");

    JwtAuthenticationConverter converter = new JwtAuthenticationConverter();
    converter.setJwtGrantedAuthoritiesConverter(authoritiesConverter);
    return converter;
}
```

ê·¸ë¦¬ê³  `SecurityFilterChain`ì— ì¶”ê°€:

```
.oauth2ResourceServer(oauth2 -> oauth2
    .jwt(jwt -> jwt
        .jwtAuthenticationConverter(jwtAuthenticationConverter())
    )
);
```

------

### 6. í† í° ê²€ì¦ íë¦„

1. í´ë¼ì´ì–¸íŠ¸ê°€ Authorization Serverë¡œë¶€í„° Access Tokenì„ ë°œê¸‰ë°›ìŒ

2. í•´ë‹¹ í† í°ì„ Resource Serverì— ìš”ì²­ í—¤ë”ì— í¬í•¨í•˜ì—¬ ì „ì†¡

   ```
   Authorization: Bearer eyJhbGciOiJIUzI1...
   ```

3. Resource ServerëŠ” `.well-known/openid-configuration`ì—ì„œ ê°€ì ¸ì˜¨ ê³µê°œ í‚¤ë¡œ JWTë¥¼ ê²€ì¦

4. ê²€ì¦ì´ ì„±ê³µí•˜ë©´ SecurityContextì— ì¸ì¦ ì •ë³´ë¥¼ ì„¤ì •

5. ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ `@AuthenticationPrincipal`ì´ë‚˜ `SecurityContextHolder`ë¥¼ í†µí•´ ì‚¬ìš©ì ì •ë³´ ì‚¬ìš© ê°€ëŠ¥

------

### 7. ì‚¬ìš©ì ì •ë³´ ì ‘ê·¼ ì˜ˆì‹œ

```
@GetMapping("/user/info")
public ResponseEntity<?> getUserInfo(@AuthenticationPrincipal Jwt jwt) {
    String username = jwt.getSubject(); // "sub" claim
    List<String> roles = jwt.getClaimAsStringList("roles");

    return ResponseEntity.ok(Map.of("username", username, "roles", roles));
}
```

------

### 8. ì‹¤ì „ ì£¼ì˜ ì‚¬í•­

| í•­ëª©            | ì„¤ëª…                                                         |
| --------------- | ------------------------------------------------------------ |
| **ì‹œê°„ ë™ê¸°í™”** | JWT í† í°ì˜ `exp`, `iat` ê²€ì¦ ì‹œ ì‹œìŠ¤í…œ ì‹œê°„ì´ ì¤‘ìš”í•¨ (ì„œë²„ ì‹œê°„ ì˜¤ì°¨ í—ˆìš© ë²”ìœ„ ë‚´ ìœ ì§€ í•„ìš”) |
| **í† í° ë¬´íš¨í™”** | JWTëŠ” ìƒíƒœê°€ ì—†ê¸° ë•Œë¬¸ì—, ë¬´íš¨í™”ëœ í† í° ê´€ë¦¬ê°€ ì–´ë µë‹¤. Redis ë˜ëŠ” ë¸”ë™ë¦¬ìŠ¤íŠ¸ë¥¼ í•¨ê»˜ ì‚¬ìš©í•˜ê¸°ë„ í•¨ |
| **HTTPS í•„ìˆ˜**  | ì•¡ì„¸ìŠ¤ í† í°ì€ ë¯¼ê° ì •ë³´. ë°˜ë“œì‹œ HTTPS í™˜ê²½ì—ì„œë§Œ ì‚¬ìš©í•´ì•¼ í•¨ |
| **í† í° í¬ê¸°**   | JWTëŠ” í—¤ë”ì— ë‹´ê¸°ê¸° ë•Œë¬¸ì— í¬ê¸° ì œí•œ ìœ ì˜. ë„ˆë¬´ ë§ì€ Claimì€ X |

------

### 9. í† í° ìœ í˜• ë¹„êµ

| í•­ëª©        | Bearer Token (JWT)    | Opaque Token                |
| ----------- | --------------------- | --------------------------- |
| ë‚´ìš© í•´ì„   | ê°€ëŠ¥ (Base64 ë””ì½”ë”©)  | ë¶ˆê°€ëŠ¥                      |
| ê²€ì¦ ë°©ì‹   | ì„œëª… í™•ì¸ (ìì²´ ê²€ì¦) | introspection endpoint ìš”ì²­ |
| Spring ì§€ì› | âœ… `jwt` ë°©ì‹          | âœ… `opaque-token` ë°©ì‹       |
| ì„±ëŠ¥        | ë¹ ë¦„ (ìì²´ ê²€ì¦)      | ëŠë¦¼ (ì›ê²© í˜¸ì¶œ í•„ìš”)       |

------

### 10. OAuth2 Resource Server vs OAuth2 Client

| í•­ëª©        | Resource Server                          | OAuth2 Client                   |
| ----------- | ---------------------------------------- | ------------------------------- |
| ëª©ì         | ë³´í˜¸ëœ ë¦¬ì†ŒìŠ¤ë¥¼ ì œê³µ                     | ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ë¥¼ ì†Œë¹„              |
| ëŒ€ìƒ        | API ì„œë²„                                 | ë¸Œë¼ìš°ì €, ì›¹ ì•±                 |
| ì£¼ìš” í´ë˜ìŠ¤ | `spring-security-oauth2-resource-server` | `spring-security-oauth2-client` |
| ì¸ì¦ ì£¼ì²´   | í† í° ê¸°ë°˜                                | ë¡œê·¸ì¸ ì„¸ì…˜ ê¸°ë°˜                |

## ë¶„ì‚° í™˜ê²½ì—ì„œì˜ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ (Saga, Eventual Consistency)

### 1. ë°°ê²½: ì™œ ë¶„ì‚° íŠ¸ëœì­ì…˜ì´ í•„ìš”í•œê°€?

#### ë‹¨ì¼ ì‹œìŠ¤í…œ ë‚´ íŠ¸ëœì­ì…˜

- JPA, JDBC ë“±ì„ í†µí•œ **ë¡œì»¬ íŠ¸ëœì­ì…˜**ì€ `@Transactional`ë¡œ ì‰½ê²Œ ì²˜ë¦¬ ê°€ëŠ¥
- ë™ì¼ DB, ë™ì¼ ì„œë¹„ìŠ¤ ë‚´ë¶€ì—ì„œë§Œ ìœ íš¨í•¨

#### ë¬¸ì œ ë°œìƒ ì§€ì 

- ì—¬ëŸ¬ **ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤**ê°€ ê°ì **ìì‹ ì˜ DB**ë¥¼ ê°€ì§€ëŠ” êµ¬ì¡°ì—ì„œ
- ì„œë¡œ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ê°„ì— **ë™ì‹œì— ì„±ê³µí•´ì•¼ í•˜ëŠ” ì‘ì—…**ì´ í•„ìš”í•  ë•Œ ë°œìƒ

> ì˜ˆ: ì£¼ë¬¸ ì„œë¹„ìŠ¤ â†’ ê²°ì œ ì„œë¹„ìŠ¤ â†’ ë°°ì†¡ ì„œë¹„ìŠ¤
>  í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ì „ì²´ë¥¼ ë˜ëŒë ¤ì•¼ í•˜ëŠ”ë°, **DB ê°„ ë¡¤ë°±ì€ ê¸°ë³¸ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥**

------

### 2. ì „í†µì ì¸ í•´ê²° ë°©ì‹: ë¶„ì‚° íŠ¸ëœì­ì…˜ (XA, 2PC)

| íŠ¹ì§•        | ì„¤ëª…                                        |
| ----------- | ------------------------------------------- |
| XA í”„ë¡œí† ì½œ | Two-Phase Commit (2PC) ê¸°ë°˜ì˜ ë¶„ì‚° íŠ¸ëœì­ì…˜ |
| ì¥ì         | ì›ìì„± ë³´ì¥ (ëª¨ë‘ ì„±ê³µ or ëª¨ë‘ ì‹¤íŒ¨)        |
| ë‹¨ì         | ëŠë¦¼, ë³µì¡í•¨, í™•ì¥ì„± ì €í•˜, ì¥ì•  ì‹œ ìœ„í—˜     |

> ë”°ë¼ì„œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì—ì„œëŠ” ë³´í†µ **Saga íŒ¨í„´**ì´ë‚˜ **ì´ë²¤íŠ¸ ê¸°ë°˜ì˜ Eventually Consistent íŒ¨í„´**ìœ¼ë¡œ ëŒ€ì²´í•¨

------

### 3. âœ… Saga íŒ¨í„´ (Choreography & Orchestration)

#### ê°œìš”

- **Saga**ëŠ” ê° ì„œë¹„ìŠ¤ê°€ **ìì‹ ì˜ ë¡œì»¬ íŠ¸ëœì­ì…˜ì„ ìˆ˜í–‰**í•˜ê³ ,
- ì´í›„ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì— **ì´ë²¤íŠ¸ ë˜ëŠ” ëª…ë ¹(Command)**ë¥¼ ì „ë‹¬í•´ ì „ì²´ íë¦„ì„ ì¡°ìœ¨í•˜ëŠ” íŒ¨í„´

#### 2ê°€ì§€ ëª¨ë¸

| ë°©ì‹              | ì„¤ëª…                                                  |
| ----------------- | ----------------------------------------------------- |
| **Choreography**  | ì´ë²¤íŠ¸ ê¸°ë°˜, ì„œë¹„ìŠ¤ë“¤ë¼ë¦¬ ì„œë¡œ ì´ë²¤íŠ¸ë¥¼ êµ¬ë…í•˜ê³  ë°˜ì‘ |
| **Orchestration** | ì¤‘ì•™ ì»¨íŠ¸ë¡¤ëŸ¬(Saga Coordinator)ê°€ ì „ì²´ íë¦„ì„ ì œì–´    |

------

#### Choreography Saga êµ¬ì¡°

```
[Order Service]
  â†“ OrderCreatedEvent
[Payment Service]
  â†“ PaymentCompletedEvent
[Inventory Service]
  â†“ InventoryReservedEvent
[Shipping Service]
  â†“ ProductShippedEvent
```

- ì¥ì : íƒˆì¤‘ì•™í™”, ëŠìŠ¨í•œ ê²°í•©
- ë‹¨ì : ì„œë¹„ìŠ¤ ê°„ ì´ë²¤íŠ¸ ê´€ê³„ê°€ ë§ì•„ì§€ë©´ **ìŠ¤íŒŒê²Œí‹° êµ¬ì¡°**ë¡œ ë°œì „ ê°€ëŠ¥

------

#### Orchestration Saga êµ¬ì¡°

```
[Saga Coordinator]
  â†’ Start Order
  â† Order Success / Fail
  â†’ Trigger Payment
  â† Payment Success / Fail
  ...
```

- ì¥ì : ì „ì²´ íë¦„ì´ ëª…í™•, ë””ë²„ê¹… ì‰¬ì›€
- ë‹¨ì : ì¤‘ì•™ ì§‘ì¤‘í˜•ì´ë¯€ë¡œ **Coordinator ì¥ì• ê°€ ì¹˜ëª…ì **

------

### 4. ë³´ìƒ íŠ¸ëœì­ì…˜ (Compensating Transaction)

Sagaì—ì„œëŠ” **ë¡¤ë°± ëŒ€ì‹  ë³´ìƒ**ì„ ì‚¬ìš©í•¨.

ì˜ˆì‹œ:

1. ì£¼ë¬¸ ìƒì„± ì„±ê³µ
2. ê²°ì œ ì„±ê³µ
3. ë°°ì†¡ ì‹¤íŒ¨ â†’ "ê²°ì œ ì·¨ì†Œ"ë¼ëŠ” ë³´ìƒ ì‘ì—… ìˆ˜í–‰
4. ìƒíƒœë¥¼ "ì£¼ë¬¸ ì‹¤íŒ¨"ë¡œ ë³€ê²½

```
public void compensatePayment(String orderId) {
    paymentService.cancelPayment(orderId);
}
```

------

### 5. Eventually Consistent (ìµœì¢… ì¼ê´€ì„±)

#### ê°œë…

- íŠ¸ëœì­ì…˜ì˜ ì¼ê´€ì„±ì„ ê°•ì œë¡œ ë§ì¶”ëŠ” ëŒ€ì‹ ,
- ì‹œê°„ì´ ì¢€ ì§€ë‚˜ë”ë¼ë„ **ê²°êµ­ ìƒíƒœê°€ ì¼ê´€ë˜ê²Œ ìˆ˜ë ´ë˜ë„ë¡ ì„¤ê³„**

#### ì˜ˆì‹œ

- Kafka ë“± **ë©”ì‹œì§€ ë¸Œë¡œì»¤**ë¥¼ í†µí•´ ì´ë²¤íŠ¸ë¥¼ ë¹„ë™ê¸° ì „ë‹¬
- ê° ì„œë¹„ìŠ¤ëŠ” ìì‹ ì´ ë°›ì€ ë©”ì‹œì§€ ê¸°ë°˜ìœ¼ë¡œ ìƒíƒœë¥¼ ë§ì¶°ê°

```
@KafkaListener(topics = "order-created")
public void handleOrderCreated(OrderEvent event) {
    // ìƒíƒœ ë§ì¶¤, ë¡œì»¬ DB ë°˜ì˜
}
```

------

### 6. Spring Cloud ê¸°ë°˜ êµ¬í˜„

#### í•µì‹¬ êµ¬ì„± ìš”ì†Œ

- **Spring Cloud Stream**: Kafka, RabbitMQ ê¸°ë°˜ ì´ë²¤íŠ¸ ë°œí–‰/êµ¬ë…
- **Spring State Machine**: Saga Coordinatorì˜ ìƒíƒœ ê´€ë¦¬
- **Spring Boot + @Transactional**: ê° ë¡œì»¬ íŠ¸ëœì­ì…˜ ê´€ë¦¬
- **Kafka**: Saga ì´ë²¤íŠ¸ ì „ë‹¬ ìˆ˜ë‹¨
- **Dead Letter Topic (DLT)**: ì‹¤íŒ¨í•œ ì´ë²¤íŠ¸ ì¬ì²˜ë¦¬ ë˜ëŠ” ë³´ìƒìš©

------

### 7. Saga ìƒíƒœ ê´€ë¦¬ ì˜ˆì‹œ (Orchestration)

```
enum OrderStatus {
  PENDING, PAID, INVENTORY_RESERVED, SHIPPED, FAILED
}
```

#### ìƒíƒœ ì „ì´ íë¦„

```
PENDING
  â†“ (PaymentSuccess)
PAID
  â†“ (InventoryReserved)
INVENTORY_RESERVED
  â†“ (ShippingDone)
SHIPPED
```

ì‹¤íŒ¨ ë°œìƒ ì‹œ â†’ **ë³´ìƒ íŠ¸ëœì­ì…˜ ìˆ˜í–‰ í›„ ìƒíƒœë¥¼ `FAILED`ë¡œ ë³€ê²½**

------

### 8. íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ì „ëµ ìš”ì•½

| ì „ëµ                  | ì¥ì               | ë‹¨ì                    | ì ìš© ìƒí™©                  |
| --------------------- | ----------------- | ---------------------- | -------------------------- |
| ë¡œì»¬ íŠ¸ëœì­ì…˜         | ë¹ ë¦„, ê°„ë‹¨í•¨      | ë¶„ì‚° ë¶ˆê°€              | ë‹¨ì¼ DB                    |
| XA (2PC)              | ì›ìì„± ë³´ì¥       | ì„±ëŠ¥ ì €í•˜              | ë ˆê±°ì‹œ ì‹œìŠ¤í…œ, ê°•í•œ ì¼ê´€ì„± |
| Saga                  | í™•ì¥ì„±, ì¥ì•  ê²¬ë”¤ | ë³µì¡í•¨, ë³´ìƒ ì„¤ê³„ í•„ìš” | ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤             |
| Eventually Consistent | í™•ì¥ì„±, ìœ ì—°í•¨    | ì¼ì‹œì  ë¶ˆì¼ì¹˜ í—ˆìš©     | ë¹„ë™ê¸° ì´ë²¤íŠ¸ ê¸°ë°˜ ì‹œìŠ¤í…œ  |

------

### 9. ì‹¤ì „ ì ìš© ì‹œ ê³ ë ¤ ì‚¬í•­

- ì‹¤íŒ¨ ì‹œ **ì¬ì‹œë„/ë¦¬íŠ¸ë¼ì´ ì „ëµ** ëª…í™•íˆ
- **Idempotency ë³´ì¥**: ì¤‘ë³µ ë©”ì‹œì§€ì— ëŒ€ë¹„í•´ì•¼ í•¨
- ìƒíƒœ ì¶”ì ì„ ìœ„í•œ **State Store** ë„ì… ê¶Œì¥
- ë©”ì‹œì§€ ìˆœì„œ ë³´ì¥ í•„ìš” ì‹œ Kafkaì˜ **íŒŒí‹°ì…˜ í‚¤** í™œìš©
- ì¥ì•  ë¶„ì„ì„ ìœ„í•œ **ë¶„ì‚° íŠ¸ë ˆì´ì‹±** ë„ì… (ì˜ˆ: Sleuth + Zipkin)

------

### 10. ì—°ê´€ ë„êµ¬

| ë„êµ¬                  | ì—­í•                           |
| --------------------- | ----------------------------- |
| Kafka / RabbitMQ      | ì´ë²¤íŠ¸ ì „ë‹¬                   |
| Debezium              | CDC ê¸°ë°˜ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°        |
| Axon Framework        | Saga êµ¬í˜„ ì§€ì›                |
| Temporal.io / Camunda | ì›Œí¬í”Œë¡œìš° ê¸°ë°˜ Orchestration |
| Spring Cloud Stream   | ì´ë²¤íŠ¸ ë°œí–‰/ì†Œë¹„              |

------

### ì •ë¦¬

- `@Transactional`ì€ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì—ì„œëŠ” **ì™„ì „í•œ íŠ¸ëœì­ì…˜ ì œì–´ ë¶ˆê°€**
- Saga íŒ¨í„´ì„ ì‚¬ìš©í•˜ë©´ **ì„œë¹„ìŠ¤ ê°„ í˜‘ë ¥ ê¸°ë°˜ì˜ íŠ¸ëœì­ì…˜ ê´€ë¦¬** ê°€ëŠ¥
- Eventually Consistent êµ¬ì¡°ëŠ” **ì„±ëŠ¥ê³¼ ìœ ì—°ì„±ì€ ë›°ì–´ë‚˜ì§€ë§Œ**, **ë¶ˆì¼ì¹˜ ê´€ë¦¬ ì±…ì„**ì´ ì„œë¹„ìŠ¤ì— ìˆìŒ
- Springì—ì„œëŠ” `Spring Cloud Stream`, `Kafka`, `State Machine`, `Resilience4j` ë“±ì„ í†µí•´ robustí•œ êµ¬í˜„ ê°€ëŠ¥