# 21. ì‹¤ì „ í”„ë¡œì íŠ¸ ì„¤ê³„ ì˜ˆì‹œ

## ê²Œì‹œíŒ ë° ëŒ“ê¸€ ì‹œìŠ¤í…œ

### ğŸ“Œ 1. í•µì‹¬ ìš”êµ¬ì‚¬í•­

| ê¸°ëŠ¥        | ì„¤ëª…                                      |
| ----------- | ----------------------------------------- |
| ê²Œì‹œê¸€ CRUD | ê²Œì‹œê¸€ ì‘ì„±, ì¡°íšŒ, ìˆ˜ì •, ì‚­ì œ             |
| ëŒ“ê¸€ CRUD   | íŠ¹ì • ê²Œì‹œê¸€ì— ëŒ“ê¸€ ì‘ì„±, ì¡°íšŒ, ìˆ˜ì •, ì‚­ì œ |
| í˜ì´ì§•      | ê²Œì‹œê¸€ ë° ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ëŠ” í˜ì´ì§€ ë‹¨ìœ„ë¡œ     |
| ì •ë ¬        | ìµœì‹ ìˆœ, ì¶”ì²œìˆœ ë“± (ì„ íƒì )                |
| ì—°ê´€ê´€ê³„    | ê²Œì‹œê¸€ 1:N ëŒ“ê¸€ êµ¬ì¡°                      |
| íŠ¸ëœì­ì…˜    | ëŒ“ê¸€ ì‘ì„± ì‹œ ê²Œì‹œê¸€ ì¡´ì¬ ì—¬ë¶€ ê²€ì¦ í¬í•¨   |

------

### ğŸ§± 2. ë„ë©”ì¸ ëª¨ë¸ ì„¤ê³„

#### ğŸ”¸ Entity êµ¬ì¡°

```
Post ---< Comment
```

- ê²Œì‹œê¸€(Post)ì€ ì—¬ëŸ¬ ëŒ“ê¸€(Comment)ì„ ê°€ì§ˆ ìˆ˜ ìˆìŒ
- ëŒ“ê¸€ì€ í•˜ë‚˜ì˜ ê²Œì‹œê¸€ì—ë§Œ ì†í•¨

------

#### ğŸ”¹ Post Entity

```
@Entity
public class Post {
    @Id @GeneratedValue
    private Long id;

    private String title;
    private String content;
    private String writer;

    @OneToMany(mappedBy = "post", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Comment> comments = new ArrayList<>();

    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;

    @PrePersist
    public void created() {
        createdAt = updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    public void updated() {
        updatedAt = LocalDateTime.now();
    }
}
```

------

#### ğŸ”¹ Comment Entity

```
@Entity
public class Comment {
    @Id @GeneratedValue
    private Long id;

    private String content;
    private String writer;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "post_id")
    private Post post;

    private LocalDateTime createdAt;

    @PrePersist
    public void created() {
        createdAt = LocalDateTime.now();
    }
}
```

------

### ğŸ” 3. DTO ê³„ì¸µ ì„¤ê³„

#### PostDto

```
public class PostDto {
    private Long id;
    private String title;
    private String content;
    private String writer;
    private LocalDateTime createdAt;
    private int commentCount;
}
```

#### CommentDto

```
public class CommentDto {
    private Long id;
    private String content;
    private String writer;
    private LocalDateTime createdAt;
}
```

------

### ğŸ§© 4. Repository ê³„ì¸µ

```
public interface PostRepository extends JpaRepository<Post, Long> {
}

public interface CommentRepository extends JpaRepository<Comment, Long> {
    List<Comment> findByPostId(Long postId);
}
```

------

### ğŸ§  5. Service ê³„ì¸µ

```
@Service
@RequiredArgsConstructor
public class PostService {
    private final PostRepository postRepository;

    @Transactional
    public Long createPost(PostDto dto) {
        Post post = new Post();
        post.setTitle(dto.getTitle());
        post.setContent(dto.getContent());
        post.setWriter(dto.getWriter());
        return postRepository.save(post).getId();
    }

    public PostDto getPost(Long id) {
        Post post = postRepository.findById(id).orElseThrow();
        return mapToDto(post);
    }

    @Transactional
    public void updatePost(Long id, PostDto dto) {
        Post post = postRepository.findById(id).orElseThrow();
        post.setTitle(dto.getTitle());
        post.setContent(dto.getContent());
    }

    @Transactional
    public void deletePost(Long id) {
        postRepository.deleteById(id);
    }

    private PostDto mapToDto(Post post) {
        return new PostDto(
            post.getId(),
            post.getTitle(),
            post.getContent(),
            post.getWriter(),
            post.getCreatedAt(),
            post.getComments().size()
        );
    }
}
```

------

#### CommentService

```
@Service
@RequiredArgsConstructor
public class CommentService {
    private final CommentRepository commentRepository;
    private final PostRepository postRepository;

    @Transactional
    public Long addComment(Long postId, CommentDto dto) {
        Post post = postRepository.findById(postId).orElseThrow();
        Comment comment = new Comment();
        comment.setContent(dto.getContent());
        comment.setWriter(dto.getWriter());
        comment.setPost(post);
        return commentRepository.save(comment).getId();
    }

    public List<CommentDto> getComments(Long postId) {
        return commentRepository.findByPostId(postId)
                .stream()
                .map(this::mapToDto)
                .toList();
    }

    @Transactional
    public void deleteComment(Long commentId) {
        commentRepository.deleteById(commentId);
    }

    private CommentDto mapToDto(Comment comment) {
        return new CommentDto(
            comment.getId(),
            comment.getContent(),
            comment.getWriter(),
            comment.getCreatedAt()
        );
    }
}
```

------

### ğŸŒ 6. Controller ê³„ì¸µ

```
@RestController
@RequestMapping("/api/posts")
@RequiredArgsConstructor
public class PostController {
    private final PostService postService;

    @PostMapping
    public ResponseEntity<Long> createPost(@RequestBody PostDto dto) {
        return ResponseEntity.ok(postService.createPost(dto));
    }

    @GetMapping("/{id}")
    public ResponseEntity<PostDto> getPost(@PathVariable Long id) {
        return ResponseEntity.ok(postService.getPost(id));
    }

    @PutMapping("/{id}")
    public void updatePost(@PathVariable Long id, @RequestBody PostDto dto) {
        postService.updatePost(id, dto);
    }

    @DeleteMapping("/{id}")
    public void deletePost(@PathVariable Long id) {
        postService.deletePost(id);
    }
}
```

```
@RestController
@RequestMapping("/api/posts/{postId}/comments")
@RequiredArgsConstructor
public class CommentController {
    private final CommentService commentService;

    @PostMapping
    public ResponseEntity<Long> addComment(@PathVariable Long postId, @RequestBody CommentDto dto) {
        return ResponseEntity.ok(commentService.addComment(postId, dto));
    }

    @GetMapping
    public ResponseEntity<List<CommentDto>> getComments(@PathVariable Long postId) {
        return ResponseEntity.ok(commentService.getComments(postId));
    }

    @DeleteMapping("/{commentId}")
    public void deleteComment(@PathVariable Long commentId) {
        commentService.deleteComment(commentId);
    }
}
```

------

### ğŸ“ˆ 7. í™•ì¥ í¬ì¸íŠ¸

| ê¸°ëŠ¥        | í™•ì¥ ë°©í–¥                                          |
| ----------- | -------------------------------------------------- |
| ì¡°íšŒìˆ˜ ê¸°ëŠ¥ | `@Version` ë˜ëŠ” ë³„ë„ `viewCount` í•„ë“œ              |
| ì¢‹ì•„ìš” ê¸°ëŠ¥ | `PostLike` ì—”í‹°í‹° ì¶”ê°€                             |
| ëŒ€ëŒ“ê¸€ ê¸°ëŠ¥ | `Comment`ì— `parentId` í•„ë“œ ì¶”ê°€                   |
| Soft Delete | `deleted` í”Œë˜ê·¸ ì¶”ê°€                              |
| í˜ì´ì§•/ì •ë ¬ | `Pageable` í™œìš© (Spring Data JPA)                  |
| ê²€ìƒ‰ ê¸°ëŠ¥   | `PostRepository`ì— `findByTitleContaining` ë“± ì¶”ê°€ |

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½

| êµ¬ì„± ìš”ì†Œ | í•µì‹¬ ë‚´ìš©                                  |
| --------- | ------------------------------------------ |
| ì—”í‹°í‹°    | `Post`, `Comment` â€“ 1:N ê´€ê³„               |
| ì„œë¹„ìŠ¤    | íŠ¸ëœì­ì…˜ ë‹¨ìœ„ë¡œ ì‘ì„±, DTO ë§¤í•‘ í¬í•¨        |
| ì»¨íŠ¸ë¡¤ëŸ¬  | RESTful ë°©ì‹ìœ¼ë¡œ ì„¤ê³„                      |
| ì—°ê´€ê´€ê³„  | `@OneToMany`, `@ManyToOne` ì‚¬ìš©            |
| í™•ì¥ì„±    | ì¢‹ì•„ìš”, ëŒ€ëŒ“ê¸€, ì¡°íšŒìˆ˜ ë“± êµ¬ì¡°ì  í™•ì¥ ê°€ëŠ¥ |

## ì‡¼í•‘ëª° ì£¼ë¬¸ ì‹œìŠ¤í…œ

### ğŸ“Œ 1. ì£¼ìš” ìš”êµ¬ì‚¬í•­

| ê¸°ëŠ¥      | ì„¤ëª…                        |
| --------- | --------------------------- |
| ìƒí’ˆ ì¡°íšŒ | ì¹´íƒˆë¡œê·¸, ìƒì„¸ ë³´ê¸°         |
| ì¥ë°”êµ¬ë‹ˆ  | ë‹´ê¸°, ìˆ˜ì •, ì‚­ì œ, ì¡°íšŒ      |
| ì£¼ë¬¸ ìƒì„± | ì¥ë°”êµ¬ë‹ˆ ê¸°ë°˜ ì£¼ë¬¸ ìƒì„±     |
| ê²°ì œ ì²˜ë¦¬ | PG ì—°ë™ ë˜ëŠ” ëª¨ì˜ ê²°ì œ      |
| ì£¼ë¬¸ ì¡°íšŒ | ë‚´ ì£¼ë¬¸ ëª©ë¡, ìƒì„¸ í™•ì¸     |
| ì¬ê³  ì°¨ê° | ì£¼ë¬¸ ì™„ë£Œ ì‹œ ìƒí’ˆ ì¬ê³  ê°ì†Œ |
| ì·¨ì†Œ ì²˜ë¦¬ | ì£¼ë¬¸ ì·¨ì†Œ ë° ì¬ê³  ë³µêµ¬      |

------

### ğŸ§± 2. ë„ë©”ì¸ ëª¨ë¸ ì„¤ê³„ (Entity)

```
Member
Product ---< Stock
        \---< CartItem
        \---< OrderItem ---< Order
```

------

#### ğŸ”¹ Member (íšŒì›)

```
@Entity
public class Member {
    @Id @GeneratedValue
    private Long id;
    private String username;
    private String email;
    private String password;
}
```

------

#### ğŸ”¹ Product (ìƒí’ˆ)

```
@Entity
public class Product {
    @Id @GeneratedValue
    private Long id;
    private String name;
    private int price;
    private String description;

    private int stockQuantity;

    public void decreaseStock(int quantity) {
        if (this.stockQuantity < quantity)
            throw new IllegalStateException("ì¬ê³  ë¶€ì¡±");
        this.stockQuantity -= quantity;
    }

    public void increaseStock(int quantity) {
        this.stockQuantity += quantity;
    }
}
```

------

#### ğŸ”¹ CartItem (ì¥ë°”êµ¬ë‹ˆ í•­ëª©)

```
@Entity
public class CartItem {
    @Id @GeneratedValue
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    private Member member;

    @ManyToOne(fetch = FetchType.LAZY)
    private Product product;

    private int quantity;
}
```

------

#### ğŸ”¹ Order / OrderItem (ì£¼ë¬¸)

```
@Entity
public class Order {
    @Id @GeneratedValue
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    private Member member;

    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL)
    private List<OrderItem> items = new ArrayList<>();

    private LocalDateTime orderDate;
    private OrderStatus status;

    public static Order createOrder(Member member, List<OrderItem> items) {
        Order order = new Order();
        order.member = member;
        order.orderDate = LocalDateTime.now();
        order.status = OrderStatus.ORDERED;
        for (OrderItem item : items) {
            order.items.add(item);
            item.setOrder(order);
        }
        return order;
    }

    public void cancel() {
        this.status = OrderStatus.CANCELLED;
        for (OrderItem item : items)
            item.cancel();
    }
}

@Entity
public class OrderItem {
    @Id @GeneratedValue
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    private Order order;

    @ManyToOne(fetch = FetchType.LAZY)
    private Product product;

    private int orderPrice;
    private int quantity;

    public void cancel() {
        product.increaseStock(quantity);
    }
}
```

------

### ğŸ¯ 3. ì„œë¹„ìŠ¤ ê³„ì¸µ

#### ğŸ”¹ CartService

```
@Service
@RequiredArgsConstructor
public class CartService {
    private final CartItemRepository cartItemRepository;
    private final ProductRepository productRepository;
    private final MemberRepository memberRepository;

    @Transactional
    public void addToCart(Long memberId, Long productId, int quantity) {
        Member member = memberRepository.findById(memberId).orElseThrow();
        Product product = productRepository.findById(productId).orElseThrow();

        CartItem item = cartItemRepository.findByMemberAndProduct(member, product)
                .orElseGet(() -> new CartItem(member, product, 0));
        item.setQuantity(item.getQuantity() + quantity);
        cartItemRepository.save(item);
    }

    public List<CartItemDto> getCart(Long memberId) {
        return cartItemRepository.findByMemberId(memberId)
                .stream()
                .map(CartItemDto::from)
                .toList();
    }

    @Transactional
    public void removeFromCart(Long itemId) {
        cartItemRepository.deleteById(itemId);
    }
}
```

------

#### ğŸ”¹ OrderService

```
@Service
@RequiredArgsConstructor
public class OrderService {
    private final MemberRepository memberRepository;
    private final CartItemRepository cartItemRepository;
    private final OrderRepository orderRepository;

    @Transactional
    public Long createOrder(Long memberId) {
        Member member = memberRepository.findById(memberId).orElseThrow();
        List<CartItem> cartItems = cartItemRepository.findByMemberId(memberId);
        if (cartItems.isEmpty()) throw new IllegalStateException("ì¥ë°”êµ¬ë‹ˆ ë¹„ì–´ìˆìŒ");

        List<OrderItem> orderItems = cartItems.stream().map(item -> {
            Product product = item.getProduct();
            product.decreaseStock(item.getQuantity());
            return new OrderItem(product, item.getQuantity(), product.getPrice());
        }).toList();

        Order order = Order.createOrder(member, orderItems);
        cartItemRepository.deleteAll(cartItems);
        return orderRepository.save(order).getId();
    }

    public OrderDto getOrder(Long orderId) {
        return OrderDto.from(orderRepository.findById(orderId).orElseThrow());
    }

    @Transactional
    public void cancelOrder(Long orderId) {
        Order order = orderRepository.findById(orderId).orElseThrow();
        order.cancel();
    }
}
```

------

### ğŸŒ 4. API Controller êµ¬ì¡°

```
@RestController
@RequestMapping("/api/cart")
@RequiredArgsConstructor
public class CartController {
    private final CartService cartService;

    @PostMapping
    public void addToCart(@RequestBody CartRequest req) {
        cartService.addToCart(req.memberId(), req.productId(), req.quantity());
    }

    @GetMapping("/{memberId}")
    public List<CartItemDto> getCart(@PathVariable Long memberId) {
        return cartService.getCart(memberId);
    }

    @DeleteMapping("/{itemId}")
    public void remove(@PathVariable Long itemId) {
        cartService.removeFromCart(itemId);
    }
}
```

```
@RestController
@RequestMapping("/api/orders")
@RequiredArgsConstructor
public class OrderController {
    private final OrderService orderService;

    @PostMapping("/{memberId}")
    public Long createOrder(@PathVariable Long memberId) {
        return orderService.createOrder(memberId);
    }

    @GetMapping("/{orderId}")
    public OrderDto getOrder(@PathVariable Long orderId) {
        return orderService.getOrder(orderId);
    }

    @PostMapping("/cancel/{orderId}")
    public void cancelOrder(@PathVariable Long orderId) {
        orderService.cancelOrder(orderId);
    }
}
```

------

### ğŸ“¦ 5. íŠ¸ëœì­ì…˜ ë° ì˜ˆì™¸ ì²˜ë¦¬ ì „ëµ

| í•­ëª©      | ì „ëµ                                              |
| --------- | ------------------------------------------------- |
| ì£¼ë¬¸ ìƒì„± | `@Transactional` ì „ì²´ ë¬¶ìŒ, ì¬ê³  ì°¨ê° í¬í•¨        |
| ì£¼ë¬¸ ì·¨ì†Œ | `@Transactional`ë¡œ ìƒíƒœ ë³€ê²½ + ì¬ê³  ë³µêµ¬          |
| ì˜ˆì™¸ ìƒí™© | ì¬ê³  ë¶€ì¡± â†’ `IllegalStateException`, 404/400 ì²˜ë¦¬ |

------

### ğŸ“ˆ 6. í™•ì¥ í¬ì¸íŠ¸

| ê¸°ëŠ¥             | í™•ì¥                                                 |
| ---------------- | ---------------------------------------------------- |
| ê²°ì œ ì—°ë™        | PGì‚¬ API ì—°ë™ í›„ `ê²°ì œ ì„±ê³µ â†’ ì£¼ë¬¸ ì €ì¥` ìˆœìœ¼ë¡œ      |
| ì¿ í°             | `Coupon`, `CouponUse`, `Order.couponDiscount`        |
| ë°°ì†¡             | `Delivery` ì—”í‹°í‹° ì¶”ê°€, ìƒíƒœê°’ `READY`, `SHIPPED` ë“± |
| ì£¼ë¬¸ ìƒíƒœë³„ ë¶„ê¸° | `ORDERED`, `PAID`, `SHIPPED`, `CANCELLED`            |
| ì´ë²¤íŠ¸ ì²˜ë¦¬      | ì£¼ë¬¸ ì™„ë£Œ â†’ Kafka ì•Œë¦¼, ì´ë©”ì¼ ë°œì†¡ ë“±               |

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½

| êµ¬ì„± ìš”ì†Œ | ë‚´ìš©                                           |
| --------- | ---------------------------------------------- |
| ë„ë©”ì¸    | Member, Product, CartItem, Order, OrderItem    |
| ì£¼ìš” ê¸°ëŠ¥ | ì¥ë°”êµ¬ë‹ˆ ê´€ë¦¬, ì£¼ë¬¸ ìƒì„±, ì¬ê³  ì°¨ê°, ì£¼ë¬¸ ì·¨ì†Œ |
| íŠ¸ëœì­ì…˜  | ì£¼ë¬¸ ìƒì„±/ì·¨ì†ŒëŠ” ë‹¨ì¼ íŠ¸ëœì­ì…˜ ë³´ì¥            |
| í™•ì¥ì„±    | ê²°ì œ, ë°°ì†¡, ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ ë“± ì—°ê³„ ê°€ëŠ¥         |
| íŒ¨í„´      | DDD ìŠ¤íƒ€ì¼, ì„œë¹„ìŠ¤ ê³„ì¸µ ì¤‘ì‹¬ êµ¬ì¡°              |

------

### ë‹¤ìŒ ì£¼ì œ

- ğŸ“¦ ì£¼ë¬¸ ìƒíƒœë³„ íë¦„ë„/ì‹œë‚˜ë¦¬ì˜¤ ì„¤ê³„
- ğŸ“¬ ê²°ì œ ëª¨ë“ˆ ì—°ë™ (KGì´ë‹ˆì‹œìŠ¤, TossPayments ë“±)
- ğŸ›’ í”„ë¡ íŠ¸ì—”ë“œ ì—°ê²° (React + REST)
- ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ + í†µí•© í…ŒìŠ¤íŠ¸ êµ¬ì¡° ì„¤ê³„
- ğŸ”„ CQRS / ì´ë²¤íŠ¸ ê¸°ë°˜ ì£¼ë¬¸ ì²˜ë¦¬ (Kafka)

## íšŒì›ê°€ì… ë° JWT ì¸ì¦ ì‹œìŠ¤í…œ

### ğŸ“Œ 1. ì£¼ìš” ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­

| ê¸°ëŠ¥      | ì„¤ëª…                                         |
| --------- | -------------------------------------------- |
| íšŒì›ê°€ì…  | ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸/ë‹‰ë„¤ì„ ë“±ë¡, ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” |
| ë¡œê·¸ì¸    | ë¡œê·¸ì¸ ì„±ê³µ ì‹œ JWT í† í° ë°œê¸‰                 |
| JWT ì¸ì¦  | í† í°ìœ¼ë¡œ ìœ ì € ì¸ì¦, ì„¸ì…˜ ì—†ìŒ                |
| ì¸ì¦ í•„í„° | ìš”ì²­ë§ˆë‹¤ í† í° ê²€ì¦ ë° ì¸ì¦ ì²˜ë¦¬              |
| ì¸ê°€ ì²˜ë¦¬ | íŠ¹ì • APIëŠ” ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ì ‘ê·¼ ê°€ëŠ¥       |

------

### ğŸ“¦ 2. Entity ë° DTO

#### ğŸ”¹ User Entity

```
@Entity
@Table(name = "users")
public class User {
    @Id @GeneratedValue
    private Long id;

    @Column(unique = true)
    private String email;

    private String password;
    private String nickname;

    private String role = "USER"; // ê¸°ë³¸ ì—­í• 
}
```

------

#### ğŸ”¹ DTO ì •ì˜

```
public record SignupRequest(String email, String password, String nickname) {}

public record LoginRequest(String email, String password) {}

public record TokenResponse(String accessToken) {}
```

------

### ğŸ”’ 3. ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ë° íšŒì›ê°€ì…

#### ğŸ”¹ BCrypt ì•”í˜¸í™”

```
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}
```

------

#### ğŸ”¹ íšŒì›ê°€ì… ì„œë¹„ìŠ¤

```
@Service
@RequiredArgsConstructor
public class AuthService {
    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;

    @Transactional
    public void signup(SignupRequest request) {
        if (userRepository.existsByEmail(request.email())) {
            throw new IllegalArgumentException("ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.");
        }

        User user = new User();
        user.setEmail(request.email());
        user.setNickname(request.nickname());
        user.setPassword(passwordEncoder.encode(request.password()));
        userRepository.save(user);
    }
}
```

------

### ğŸ” 4. JWT í† í° ë°œê¸‰

#### ğŸ”¹ JWT ì˜ì¡´ì„± (Gradle)

```
implementation 'io.jsonwebtoken:jjwt-api:0.11.5'
runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.11.5'
runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.11.5'
```

------

#### ğŸ”¹ JwtTokenProvider

```
@Component
public class JwtTokenProvider {
    @Value("${jwt.secret}")
    private String secret;

    private final long EXPIRATION = 1000L * 60 * 60;

    public String generateToken(String email) {
        Date now = new Date();
        Date expiry = new Date(now.getTime() + EXPIRATION);

        return Jwts.builder()
                .setSubject(email)
                .setIssuedAt(now)
                .setExpiration(expiry)
                .signWith(Keys.hmacShaKeyFor(secret.getBytes(StandardCharsets.UTF_8)))
                .compact();
    }

    public String getEmailFromToken(String token) {
        return Jwts.parserBuilder()
                .setSigningKey(secret.getBytes(StandardCharsets.UTF_8))
                .build()
                .parseClaimsJws(token)
                .getBody()
                .getSubject();
    }

    public boolean validate(String token) {
        try {
            getEmailFromToken(token);
            return true;
        } catch (Exception e) {
            return false;
        }
    }
}
```

------

### ğŸ” 5. ë¡œê·¸ì¸ ë° í† í° ì‘ë‹µ

```
@RequiredArgsConstructor
@RestController
@RequestMapping("/api/auth")
public class AuthController {
    private final AuthService authService;
    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;
    private final JwtTokenProvider jwtProvider;

    @PostMapping("/signup")
    public ResponseEntity<Void> signup(@RequestBody SignupRequest request) {
        authService.signup(request);
        return ResponseEntity.ok().build();
    }

    @PostMapping("/login")
    public ResponseEntity<TokenResponse> login(@RequestBody LoginRequest request) {
        User user = userRepository.findByEmail(request.email())
                .orElseThrow(() -> new UsernameNotFoundException("ì´ë©”ì¼ ì—†ìŒ"));

        if (!passwordEncoder.matches(request.password(), user.getPassword())) {
            throw new BadCredentialsException("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜");
        }

        String token = jwtProvider.generateToken(user.getEmail());
        return ResponseEntity.ok(new TokenResponse(token));
    }
}
```

------

### ğŸ” 6. JWT ì¸ì¦ í•„í„°

```
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    private final JwtTokenProvider jwtProvider;
    private final UserRepository userRepository;

    public JwtAuthenticationFilter(JwtTokenProvider jwtProvider, UserRepository userRepository) {
        this.jwtProvider = jwtProvider;
        this.userRepository = userRepository;
    }

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain chain) throws ServletException, IOException {

        String header = request.getHeader("Authorization");
        if (header != null && header.startsWith("Bearer ")) {
            String token = header.substring(7);
            if (jwtProvider.validate(token)) {
                String email = jwtProvider.getEmailFromToken(token);
                User user = userRepository.findByEmail(email).orElseThrow();
                UsernamePasswordAuthenticationToken auth =
                        new UsernamePasswordAuthenticationToken(user, null,
                                List.of(new SimpleGrantedAuthority(user.getRole())));
                SecurityContextHolder.getContext().setAuthentication(auth);
            }
        }

        chain.doFilter(request, response);
    }
}
```

------

### ğŸ” 7. Spring Security ì„¤ì •

```
@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {
    private final JwtTokenProvider jwtProvider;
    private final UserRepository userRepository;

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        return http
                .csrf(AbstractHttpConfigurer::disable)
                .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/api/auth/**").permitAll()
                        .anyRequest().authenticated()
                )
                .addFilterBefore(new JwtAuthenticationFilter(jwtProvider, userRepository),
                        UsernamePasswordAuthenticationFilter.class)
                .build();
    }
}
```

------

### âœ… 8. ì‹¤í–‰ íë¦„ ìš”ì•½

```
[íšŒì›ê°€ì…]
  - ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” í›„ DB ì €ì¥

[ë¡œê·¸ì¸]
  - ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ â†’ JWT ë°œê¸‰

[ì¸ì¦ ìš”ì²­]
  - Authorization: Bearer <token> í—¤ë” í¬í•¨
  - JWTAuthenticationFilterê°€ ì¸ì¦ ì²˜ë¦¬
  - SecurityContextì— ìœ ì € ì •ë³´ ì €ì¥ë¨
```

------

### ğŸ” 9. application.yml ì„¤ì • ì˜ˆì‹œ

```
jwt:
  secret: MY_SECRET_12345678901234567890ABCDEF
```

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½

| ê¸°ëŠ¥                 | êµ¬ì„± ìš”ì†Œ                                 |
| -------------------- | ----------------------------------------- |
| íšŒì›ê°€ì…             | DTO + Service + BCryptPasswordEncoder     |
| ë¡œê·¸ì¸               | ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í›„ JWT ë°œê¸‰          |
| í† í° ë°œê¸‰            | `JwtTokenProvider.generateToken()`        |
| ì¸ì¦ í•„í„°            | `JwtAuthenticationFilter`                 |
| Spring Security ì—°ë™ | Stateless, í•„í„° ì‚½ì…, ê¶Œí•œ ì²˜ë¦¬           |
| í™•ì¥ì„±               | Refresh Token, Role/ê¶Œí•œë³„ ì¸ì¦ ì²˜ë¦¬ ê°€ëŠ¥ |

------

### ë‹¤ìŒ ì£¼ì œ

- ğŸ” Refresh Token + Redis ê¸°ë°˜ í† í° ì¬ë°œê¸‰
- ğŸ” Role ê¸°ë°˜ ì¸ê°€ (`@PreAuthorize`, `hasRole`)
- ğŸ§¾ í† í° ë¬´íš¨í™” ë° ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì²˜ë¦¬ ì „ëµ
- ğŸŒ OAuth2 ë¡œê·¸ì¸ (Google, Kakao ì—°ë™)

## Kafka ê¸°ë°˜ ì•Œë¦¼ ì‹œìŠ¤í…œ

### ğŸ“Œ 1. ìš”êµ¬ì‚¬í•­ ë° ì‹œë‚˜ë¦¬ì˜¤

| ì‹œë‚˜ë¦¬ì˜¤         | ì„¤ëª…                                                 |
| ---------------- | ---------------------------------------------------- |
| ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°    | ì£¼ë¬¸ ì™„ë£Œ ì‹œ Kafkaë¡œ ì´ë²¤íŠ¸ ë°œí–‰                     |
| ì†Œë¹„ì(Consumer) | ì•Œë¦¼ ì„œë¹„ìŠ¤ê°€ í•´ë‹¹ ì´ë²¤íŠ¸ë¥¼ êµ¬ë…í•˜ê³  ì²˜ë¦¬            |
| ì•Œë¦¼ ë°©ì‹        | ì´ë©”ì¼ / SMS / í‘¸ì‹œ ë“± í™•ì¥ ê°€ëŠ¥                     |
| ë¹„ë™ê¸° ì²˜ë¦¬      | ì£¼ë¬¸ íë¦„ê³¼ ë³„ë„ë¡œ ì´ë²¤íŠ¸ ì²˜ë¦¬                       |
| ë³´ì¥ ìš”êµ¬        | ìµœì†Œ 1íšŒ ì „ì†¡ (at-least-once), ë¡œê·¸ ê¸°ë°˜ ì¬ì²˜ë¦¬ ê°€ëŠ¥ |

------

### ğŸ” 2. Kafka ê¸°ë³¸ êµ¬ì„±

#### ğŸ“¦ í† í”½ ì„¤ê³„

| Topic ì´ë¦„           | ë©”ì‹œì§€ íƒ€ì…      |
| -------------------- | ---------------- |
| `order.notification` | ì£¼ë¬¸ ì•Œë¦¼ ì´ë²¤íŠ¸ |

------

### ğŸ§± 3. ì•Œë¦¼ ì´ë²¤íŠ¸ DTO

```
public record NotificationEvent(
    Long userId,
    String type,          // EMAIL, SMS, PUSH ë“±
    String title,
    String content
) {}
```

KafkaëŠ” ê¸°ë³¸ì ìœ¼ë¡œ JSON ì§ë ¬í™”ë¡œ ì£¼ê³ ë°›ê¸° ë•Œë¬¸ì— **DTOëŠ” ì§ë ¬í™” ê°€ëŠ¥í•´ì•¼ í•¨**.

------

### âš™ï¸ 4. Kafka ì„¤ì • (`application.yml`)

```
spring:
  kafka:
    bootstrap-servers: localhost:9092
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
    consumer:
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      group-id: notification-group
    properties:
      spring.json.trusted.packages: "*"
```

------

### âœ‰ï¸ 5. ë©”ì‹œì§€ ë°œí–‰ Producer

```
@Service
@RequiredArgsConstructor
public class NotificationProducer {
    private final KafkaTemplate<String, NotificationEvent> kafkaTemplate;

    public void send(NotificationEvent event) {
        kafkaTemplate.send("order.notification", event);
    }
}
```

------

### ğŸ›’ 6. ì£¼ë¬¸ ì„œë¹„ìŠ¤ì—ì„œ ë°œí–‰

```
@Service
@RequiredArgsConstructor
public class OrderService {
    private final NotificationProducer producer;
    private final OrderRepository orderRepository;

    @Transactional
    public void completeOrder(Long orderId) {
        Order order = orderRepository.findById(orderId).orElseThrow();
        order.markCompleted();

        NotificationEvent event = new NotificationEvent(
            order.getUserId(),
            "EMAIL",
            "ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
            "ì£¼ë¬¸ ë²ˆí˜¸ " + order.getId() + " ê°€ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."
        );

        producer.send(event);
    }
}
```

------

### ğŸ“¬ 7. ì•Œë¦¼ ì†Œë¹„ì Consumer

```
@Component
public class NotificationConsumer {

    @KafkaListener(topics = "order.notification", groupId = "notification-group")
    public void listen(NotificationEvent event) {
        System.out.println("âœ… ì•Œë¦¼ ìˆ˜ì‹ : " + event);

        switch (event.type()) {
            case "EMAIL" -> sendEmail(event);
            case "SMS" -> sendSms(event);
            case "PUSH" -> sendPush(event);
        }
    }

    private void sendEmail(NotificationEvent event) {
        // ì‹¤ì œ ì´ë©”ì¼ ì „ì†¡ ë¡œì§
        System.out.printf("ğŸ“§ ì´ë©”ì¼ ì „ì†¡: [%s] %s%n", event.title(), event.content());
    }

    private void sendSms(NotificationEvent event) {
        // SMS ì „ì†¡ ë¡œì§
    }

    private void sendPush(NotificationEvent event) {
        // í‘¸ì‹œ ì•Œë¦¼ ë¡œì§
    }
}
```

------

### ğŸ§ª 8. í…ŒìŠ¤íŠ¸

```
# í† í”½ ìƒì„±
kafka-topics.sh --create --topic order.notification --bootstrap-server localhost:9092

# ë©”ì‹œì§€ ìˆ˜ì‹  í…ŒìŠ¤íŠ¸
kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic order.notification --from-beginning
```

------

### ğŸ”„ 9. ì‹¤ì „ í™•ì¥ êµ¬ì¡°

#### âœ… êµ¬ì¡° ì˜ˆì‹œ

```
[OrderService]
    â†“ Kafka ë©”ì‹œì§€ ë°œí–‰
[Kafka Broker (order.notification)]
    â†“
[NotificationConsumer]
    â†’ EmailService
    â†’ SmsService
    â†’ PushService
```

------

### ğŸ“¦ 10. í™•ì¥ í¬ì¸íŠ¸

| ê¸°ëŠ¥                    | ì„¤ëª…                                     |
| ----------------------- | ---------------------------------------- |
| Dead Letter Queue (DLQ) | ì†Œë¹„ ì‹¤íŒ¨í•œ ë©”ì‹œì§€ë¥¼ ë³„ë„ í† í”½ìœ¼ë¡œ ë¶„ë¦¬  |
| ë©”ì‹œì§€ ì¬ì²˜ë¦¬           | DLQ ì†Œë¹„ìë¥¼ ë§Œë“¤ì–´ ì¬ì‹œë„ ê°€ëŠ¥          |
| ë©”ì‹œì§€ í—¤ë” ì‚¬ìš©        | `KafkaHeader`ë¡œ íƒ€ì…/ìš°ì„ ìˆœìœ„ êµ¬ë¶„ ê°€ëŠ¥  |
| íŠ¸ë ˆì´ì‹±                | Sleuth + Kafka Propagation ì—°ë™          |
| ì¸ì¦ëœ ì‚¬ìš©ì ì „íŒŒ      | JWT í† í°ì„ Kafka ë©”ì‹œì§€ í—¤ë”ì— í¬í•¨ ê°€ëŠ¥ |

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½

| êµ¬ì„± ìš”ì†Œ                          | ì„¤ëª…                                          |
| ---------------------------------- | --------------------------------------------- |
| `NotificationEvent`                | ì´ë²¤íŠ¸ ë©”ì‹œì§€ DTO                             |
| `NotificationProducer`             | Kafka ë°œí–‰ì                                  |
| `NotificationConsumer`             | Kafka ì†Œë¹„ì (ì•Œë¦¼ ì²˜ë¦¬ ë‹´ë‹¹)                 |
| `KafkaTemplate` / `@KafkaListener` | Spring Kafka í•µì‹¬ ì»´í¬ë„ŒíŠ¸                    |
| `order.notification`               | ì•Œë¦¼ìš© í† í”½                                   |
| í™•ì¥ ë°©í–¥                          | ì´ë©”ì¼ â†’ SMS â†’ í‘¸ì‹œ â†’ ë©€í‹° ì±„ë„ ì²˜ë¦¬ê¹Œì§€ ê°€ëŠ¥ |

------

### ë‹¤ìŒ ì£¼ì œ

- ğŸ“¦ Kafka + Redis ê¸°ë°˜ **ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€** ì „ëµ
- ğŸ” Kafka + Retry + DLQ íŒ¨í„´
- ğŸ§¾ Kafka ë©”ì‹œì§€ ì¶”ì  ë¡œê¹… + Elastic Stack ì—°ë™
- â˜ï¸ Kafka + Kubernetes + Externalized Secrets ì—°ë™

## íŒŒì¼ ì—…ë¡œë“œ ë° ì¸ë„¤ì¼ ì²˜ë¦¬ ì‹œìŠ¤í…œ

### ğŸ“Œ 1. ì£¼ìš” ê¸°ëŠ¥ ìš”ì•½

| ê¸°ëŠ¥           | ì„¤ëª…                                          |
| -------------- | --------------------------------------------- |
| íŒŒì¼ ì—…ë¡œë“œ    | ì´ë¯¸ì§€ ë˜ëŠ” ì¼ë°˜ íŒŒì¼ ì—…ë¡œë“œ (Multipart ì§€ì›) |
| ì €ì¥ ê²½ë¡œ ë¶„ë¦¬ | ì—…ë¡œë“œ íŒŒì¼ê³¼ ì¸ë„¤ì¼ ë””ë ‰í„°ë¦¬ êµ¬ë¶„            |
| ì¸ë„¤ì¼ ìƒì„±    | ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì¸ë„¤ì¼ ìƒì„±         |
| ì ‘ê·¼ ê²½ë¡œ ì œê³µ | ì—…ë¡œë“œëœ íŒŒì¼ì„ URLë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ ì œê³µ      |
| íŒŒì¼ ì‚­ì œ      | ì›ë³¸ ë° ì¸ë„¤ì¼ ë™ì‹œ ì‚­ì œ ê°€ëŠ¥                 |

------

### ğŸ§± 2. ì˜ì¡´ì„± ì„¤ì • (Gradle ê¸°ì¤€)

```
dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'net.coobird:thumbnailator:0.4.14'
}
```

> `thumbnailator`ëŠ” ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§•ì„ ìœ„í•œ ê²½ëŸ‰ ë¼ì´ë¸ŒëŸ¬ë¦¬ì•¼.

------

### âš™ï¸ 3. application.yml ì„¤ì •

```
file:
  upload-dir: uploads/
  thumbnail-dir: uploads/thumbnails/
```

------

### ğŸ—‚ï¸ 4. íŒŒì¼ ì €ì¥ ìœ í‹¸ë¦¬í‹°

```
@Component
@RequiredArgsConstructor
public class FileStorageUtil {

    @Value("${file.upload-dir}")
    private String uploadDir;

    @Value("${file.thumbnail-dir}")
    private String thumbnailDir;

    public String saveFile(MultipartFile file) throws IOException {
        String filename = UUID.randomUUID() + "_" + file.getOriginalFilename();
        Path targetPath = Paths.get(uploadDir).resolve(filename);
        Files.createDirectories(targetPath.getParent());
        file.transferTo(targetPath.toFile());
        return filename;
    }

    public void createThumbnail(String filename, int width, int height) throws IOException {
        Path source = Paths.get(uploadDir).resolve(filename);
        Path thumbTarget = Paths.get(thumbnailDir).resolve(filename);
        Files.createDirectories(thumbTarget.getParent());

        try (InputStream in = Files.newInputStream(source);
             OutputStream out = Files.newOutputStream(thumbTarget)) {
            Thumbnails.of(in)
                    .size(width, height)
                    .toOutputStream(out);
        }
    }

    public Resource load(String filename, boolean thumbnail) {
        try {
            Path dir = thumbnail ? Paths.get(thumbnailDir) : Paths.get(uploadDir);
            Path path = dir.resolve(filename);
            return new UrlResource(path.toUri());
        } catch (Exception e) {
            throw new RuntimeException("íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", e);
        }
    }
}
```

------

### ğŸŒ 5. íŒŒì¼ ì—…ë¡œë“œ API

```
@RestController
@RequestMapping("/api/files")
@RequiredArgsConstructor
public class FileUploadController {

    private final FileStorageUtil fileStorageUtil;

    @PostMapping("/upload")
    public ResponseEntity<Map<String, String>> upload(@RequestParam("file") MultipartFile file) throws IOException {
        String filename = fileStorageUtil.saveFile(file);
        if (file.getContentType().startsWith("image")) {
            fileStorageUtil.createThumbnail(filename, 200, 200);
        }

        Map<String, String> result = new HashMap<>();
        result.put("fileName", filename);
        result.put("fileUrl", "/api/files/view/" + filename);
        result.put("thumbnailUrl", "/api/files/thumb/" + filename);

        return ResponseEntity.ok(result);
    }

    @GetMapping("/view/{filename}")
    public ResponseEntity<Resource> view(@PathVariable String filename) {
        Resource file = fileStorageUtil.load(filename, false);
        return ResponseEntity.ok()
                .header(HttpHeaders.CONTENT_DISPOSITION, "inline; filename=\"" + filename + "\"")
                .body(file);
    }

    @GetMapping("/thumb/{filename}")
    public ResponseEntity<Resource> thumbnail(@PathVariable String filename) {
        Resource file = fileStorageUtil.load(filename, true);
        return ResponseEntity.ok()
                .header(HttpHeaders.CONTENT_DISPOSITION, "inline; filename=\"" + filename + "\"")
                .body(file);
    }
}
```

------

### ğŸ“¦ 6. í™•ì¥ ê°€ëŠ¥ ê¸°ëŠ¥

| ê¸°ëŠ¥               | ì„¤ëª…                                                       |
| ------------------ | ---------------------------------------------------------- |
| íŒŒì¼ í™•ì¥ì í•„í„°ë§ | `.jpg`, `.png`, `.pdf` ë“± ì œí•œ ê°€ëŠ¥                        |
| MIME Type ê²€ì¦     | `file.getContentType()`ë¡œ í—ˆìš© ì—¬ë¶€ í™•ì¸                   |
| ì¸ë„¤ì¼ í¬ê¸° ì„¤ì •   | ìš”ì²­ë§ˆë‹¤ ë™ì  ì§€ì • ê°€ëŠ¥í•˜ê²Œ í™•ì¥                           |
| DB ì—°ë™            | ì—…ë¡œë“œ íŒŒì¼ ë©”íƒ€ì •ë³´ë¥¼ DBì— ì €ì¥ (ê²½ë¡œ, ì‚¬ìš©ì, ìƒì„±ì¼ ë“±) |
| AWS S3 ì—°ë™        | íŒŒì¼ ì €ì¥ì†Œë¥¼ ë¡œì»¬ â†’ S3ë¡œ í™•ì¥ ê°€ëŠ¥                        |
| ì¸ì¦ ì—°ë™          | `@PreAuthorize("isAuthenticated()")` ë“±ìœ¼ë¡œ ê¶Œí•œ ì„¤ì •      |

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½

| ê¸°ëŠ¥        | êµ¬í˜„ ë°©ì‹                                              |
| ----------- | ------------------------------------------------------ |
| íŒŒì¼ ì €ì¥   | UUID ê¸°ë°˜ íŒŒì¼ëª… ìƒì„± + `MultipartFile.transferTo()`   |
| ì¸ë„¤ì¼ ìƒì„± | `Thumbnailator.of().size().toOutputStream()`           |
| ì ‘ê·¼ API    | `/api/files/view/{filename}`, `/thumb/{filename}`      |
| ì—ëŸ¬ ì²˜ë¦¬   | íŒŒì¼ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš° `RuntimeException` ë°œìƒ        |
| ì •ë¦¬ í¬ì¸íŠ¸ | ì›ë³¸/ì¸ë„¤ì¼ í´ë” ë¶„ë¦¬, íŒŒì¼ëª… ì¶©ëŒ ë°©ì§€, ë¦¬ì†ŒìŠ¤ ì§ë ¬í™” |

------

### ë‹¤ìŒ ì£¼ì œ

- ğŸ—ƒï¸ ì—…ë¡œë“œ ë©”íƒ€ì •ë³´ DB ì—°ë™ (`FileMetadata`, ì‚¬ìš©ì ID, ì—…ë¡œë“œ ì¼ì‹œ ë“±)
- ğŸŒ AWS S3 / Cloud Storage ì—°ë™
- ğŸ” ë¡œê·¸ì¸ ì‚¬ìš©ìì˜ ê°œì¸ íŒŒì¼ ë¶„ë¦¬ (`/user/{id}/files`)
- ğŸ“¸ ë™ì˜ìƒ ì¸ë„¤ì¼ ì¶”ì¶œ (ffmpeg ì—°ë™)

## ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê¸°ë°˜ ë„ì„œ API ì‹œìŠ¤í…œ

### ğŸ“Œ 1. í•µì‹¬ ì•„í‚¤í…ì²˜ ê°œìš”

#### ğŸ§© ì„œë¹„ìŠ¤ ë¶„ë¦¬ êµ¬ì¡° (MSA)

| ì„œë¹„ìŠ¤ ì´ë¦„          | ì±…ì„ ë„ë©”ì¸                         |
| -------------------- | ----------------------------------- |
| **Book Service**     | ë„ì„œ ì •ë³´ ë“±ë¡/ì¡°íšŒ                 |
| **User Service**     | ì‚¬ìš©ì ë“±ë¡, ë¡œê·¸ì¸                 |
| **Review Service**   | ë„ì„œ ë¦¬ë·° ë“±ë¡ ë° ì¡°íšŒ              |
| **Search Service**   | ë„ì„œ ê²€ìƒ‰ (Elasticsearch ê¸°ë°˜ ê°€ëŠ¥) |
| **API Gateway**      | í´ë¼ì´ì–¸íŠ¸ ì§„ì…ì , ë¼ìš°íŒ…           |
| **Config Server**    | ì„¤ì • ì •ë³´ ì¤‘ì•™ ê´€ë¦¬                 |
| **Discovery Server** | ì„œë¹„ìŠ¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ (Eureka)          |

------

### ğŸ§± 2. ê° ì„œë¹„ìŠ¤ ê°œìš”

#### ğŸ“˜ Book Service

- `/books`
  - GET `/books` : ì „ì²´ ëª©ë¡
  - GET `/books/{id}` : ë‹¨ê±´ ì¡°íšŒ
  - POST `/books` : ë“±ë¡
- DB: MySQL (ì±… í…Œì´ë¸”)

#### ğŸ‘¤ User Service

- `/users`
  - POST `/users` : íšŒì›ê°€ì…
  - POST `/login` : ë¡œê·¸ì¸ (JWT ë°œê¸‰)
- JWT ì¸ì¦ í•„í„° í¬í•¨
- DB: MySQL (user í…Œì´ë¸”)

#### ğŸ“ Review Service

- `/reviews`
  - POST `/reviews` : ë¦¬ë·° ì‘ì„±
  - GET `/reviews/book/{bookId}` : ë„ì„œ ë¦¬ë·° ì¡°íšŒ
- ë„ì„œ ID ê¸°ë°˜ ë¦¬ë·° ì—°ë™
- DB: MongoDB ë˜ëŠ” MySQL

#### ğŸ” Search Service (ì„ íƒ)

- `/search`
  - GET `/search?q=ìë°”`
- Elasticsearch ì—°ë™ ë˜ëŠ” DB LIKE ê²€ìƒ‰

------

### ğŸ”€ 3. API Gateway (Spring Cloud Gateway)

#### ğŸ“„ application.yml

```
spring:
  cloud:
    gateway:
      routes:
        - id: book-service
          uri: lb://BOOK-SERVICE
          predicates:
            - Path=/books/**
        - id: user-service
          uri: lb://USER-SERVICE
          predicates:
            - Path=/users/**,/login
        - id: review-service
          uri: lb://REVIEW-SERVICE
          predicates:
            - Path=/reviews/**
```

> `lb://`ëŠ” Eureka ë“±ë¡ëœ ì„œë¹„ìŠ¤ ì´ë¦„ ê¸°ë°˜ìœ¼ë¡œ ë¼ìš°íŒ…

------

### ğŸ—ƒï¸ 4. Config Server (Spring Cloud Config)

- ëª¨ë“  ì„œë¹„ìŠ¤ ì„¤ì •ì„ Git ë˜ëŠ” ë¡œì»¬ì— ì €ì¥
- `application.yml` íŒŒì¼ ë¶„ë¦¬ ê´€ë¦¬

```
ğŸ“ config-repo/
â”œâ”€â”€ book-service.yml
â”œâ”€â”€ user-service.yml
â”œâ”€â”€ review-service.yml
```

> ê° ì„œë¹„ìŠ¤ëŠ” `spring.cloud.config.uri`ë¡œ ì„¤ì • ì„œë²„ë¥¼ ì°¸ì¡°í•¨

------

### ğŸ“¡ 5. Discovery Server (Eureka)

#### âœ… ì„¤ì •

```
eureka:
  client:
    register-with-eureka: true
    fetch-registry: true
  instance:
    prefer-ip-address: true
```

> ëª¨ë“  ì„œë¹„ìŠ¤ëŠ” Eureka Clientë¡œ ë“±ë¡ë˜ê³ , Gatewayê°€ ì´ë¥¼ ì°¸ì¡°í•´ ë¼ìš°íŒ…

------

### ğŸ”’ 6. JWT ì¸ì¦ ì—°ë™

#### êµ¬ì¡°

```
[í´ë¼ì´ì–¸íŠ¸]
   â†“ ë¡œê·¸ì¸ (User Service)
[JWT ë°œê¸‰]
   â†“ Authorization: Bearer <token>
[Gateway]
   â†“ ì¸ì¦ í•„í„° â†’ User ì •ë³´ ì¶”ì¶œ
[Backend Service] â† ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ ì „ë‹¬
```

- Gatewayì—ì„œ í† í° ê²€ì¦ í›„ í—¤ë”ì— ì‚¬ìš©ì ID ì¶”ê°€ (`X-User-Id`)
- í›„ë°© ì„œë¹„ìŠ¤ì—ì„œëŠ” ë³„ë„ ì¸ì¦ ì—†ì´ í—¤ë” ê¸°ë°˜ ì‚¬ìš©ì í™•ì¸

------

### ğŸ§ª 7. ë„ì„œ + ë¦¬ë·° ì—°ë™ íë¦„ ì˜ˆì‹œ

1. `/books/123` â†’ BookServiceê°€ ë„ì„œ ì •ë³´ ì‘ë‹µ
2. `/reviews/book/123` â†’ ReviewServiceê°€ ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ ì‘ë‹µ
3. í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë³´ ê²°í•©, ë˜ëŠ” `API Gateway`ì—ì„œ Fan-out íŒ¨í„´ ì‚¬ìš©í•´ í•œ ë²ˆì— ì‘ë‹µ êµ¬ì„± ê°€ëŠ¥

------

### ğŸ§° 8. ê¸°ìˆ  ìŠ¤íƒ ì œì•ˆ

| ì˜ì—­              | ê¸°ìˆ                                |
| ----------------- | ---------------------------------- |
| ì„œë¹„ìŠ¤ ê°œë°œ       | Spring Boot 3.x                    |
| API ê²Œì´íŠ¸ì›¨ì´    | Spring Cloud Gateway               |
| ì„œë¹„ìŠ¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ | Spring Cloud Eureka                |
| ì„¤ì • ê´€ë¦¬         | Spring Cloud Config                |
| ë°ì´í„° ì €ì¥ì†Œ     | MySQL (ì±…/ìœ ì €), MongoDB (ë¦¬ë·°)    |
| ì¸ì¦              | JWT + Gateway Filter               |
| ë©”ì‹œì§• (í™•ì¥)     | Kafka (ex: ë¦¬ë·° ì‘ì„± ì‹œ ì•Œë¦¼ ë°œí–‰) |

------

### ğŸ” 9. CI/CD ë° ë°°í¬

| ë‹¨ê³„        | ë„êµ¬                                  |
| ----------- | ------------------------------------- |
| ì½”ë“œ ì €ì¥ì†Œ | Git + GitHub/GitLab                   |
| CI          | GitHub Actions / Jenkins              |
| ë¹Œë“œ        | Gradle + Docker                       |
| ë°°í¬        | Docker Compose / Kubernetes (í™•ì¥ ì‹œ) |
| ê´€ì¸¡        | Prometheus + Grafana, ELK ë˜ëŠ” Loki   |

------

### âœ… ë§ˆë¬´ë¦¬ ìš”ì•½

| êµ¬ì„± ìš”ì†Œ   | ì„¤ëª…                                                   |
| ----------- | ------------------------------------------------------ |
| ì„œë¹„ìŠ¤ ë¶„ë¦¬ | Book, User, Review ë“± ê° ë„ë©”ì¸ìœ¼ë¡œ ë¶„ë¦¬               |
| í†µì‹  ë°©ì‹   | REST + Eureka + Gateway                                |
| ì¸ì¦ ë°©ì‹   | JWT, Gateway í•„í„°ì—ì„œ ê²€ì¦                             |
| ì„¤ì • ë°©ì‹   | Config Serverë¥¼ í†µí•´ ì¤‘ì•™í™”                            |
| í™•ì¥ì„±      | ë©”ì‹œì§•(Kafka), ê²€ìƒ‰(Elastic), ì•Œë¦¼ ì‹œìŠ¤í…œ ë“± ì—°ë™ ê°€ëŠ¥ |

------

### ë‹¤ìŒ ì£¼ì œ

- ğŸ§¬ ì„œë¹„ìŠ¤ ê°„ í†µì‹ : REST vs Kafka ì´ë²¤íŠ¸ ê¸°ë°˜
- ğŸ” Gatewayì—ì„œ JWT ì¸ì¦ + ì—­í• (Role) ì¸ê°€ ì²˜ë¦¬
- â˜ï¸ Kubernetes ê¸°ë°˜ ë°°í¬ êµ¬ì„±
- ğŸ§¾ Saga íŒ¨í„´ ê¸°ë°˜ ì£¼ë¬¸-ê²°ì œ ì²˜ë¦¬ (MSA íŠ¸ëœì­ì…˜)